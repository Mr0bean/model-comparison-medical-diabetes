<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹ä¸ªæ€§åŒ–è¯„ä¼°ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            margin: 0;
            background: white;
            box-shadow: none;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        /* è¯„åˆ†ç›¸å…³æ ·å¼ */
        .rating-panel {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }

        .rating-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ccc;
        }

        .rating-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .checkbox-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 6px;
            cursor: pointer;
        }

        .checkbox-item.checked {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .slider-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .slider-item label {
            min-width: 100px;
            font-size: 13px;
            font-weight: 600;
        }

        .slider-item input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            cursor: pointer;
        }

        .slider-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 700;
            color: #667eea;
        }

        .rating-dimensions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .rating-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .rating-item label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        .rating-stars {
            display: flex;
            gap: 5px;
        }

        .star {
            font-size: 24px;
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s;
            user-select: none;
        }

        .star.selected {
            color: #ffc107;
        }

        .star:hover {
            color: #ffb300;
        }

        .rating-comment {
            margin-top: 10px;
        }

        .rating-comment textarea {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
            resize: vertical;
        }

        .export-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s;
            z-index: 1000;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .clear-btn {
            position: fixed;
            bottom: 30px;
            right: 220px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
            transition: all 0.3s;
            z-index: 1000;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        .controls {
            padding: 20px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        .patient-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .patient-checkbox {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .patient-checkbox:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .patient-checkbox.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .patient-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .select-all-patients-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }

        .select-all-patients-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .model-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .model-checkbox {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .model-checkbox:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .model-checkbox.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .model-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .conv-type-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .conv-type-checkbox {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .conv-type-checkbox:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .conv-type-checkbox.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .conv-type-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .select-all-btn {
            padding: 10px 20px;
            border: 2px solid #764ba2;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }

        .select-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .comparison-area {
            padding: 30px 40px;
            min-height: 500px;
            background: white;
        }

        .no-data {
            text-align: center;
            padding: 100px 20px;
            color: #999;
            font-size: 16px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
        }

        /* è¶…å®½å±ä¼˜åŒ– */
        @media (min-width: 2560px) {
            .comparison-grid {
                grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            }
        }

        @media (min-width: 3440px) {
            .comparison-grid {
                grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            }
        }

        .comparison-grid.horizontal-layout {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 20px;
            align-items: flex-start;
        }

        .comparison-grid.horizontal-layout .model-card {
            width: 450px;
            flex-shrink: 0;
        }

        .comparison-grid.horizontal-layout::-webkit-scrollbar {
            height: 12px;
        }

        .comparison-grid.horizontal-layout::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .comparison-grid.horizontal-layout::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 6px;
        }

        .comparison-grid.horizontal-layout::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .model-card {
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .model-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .model-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .model-card-body {
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }

        .model-card-body::-webkit-scrollbar {
            width: 8px;
        }

        .model-card-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .model-card-body::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .model-card-body::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .model-card-body p {
            margin-bottom: 15px;
        }

        .model-card-body h3 {
            margin: 20px 0 10px 0;
            font-size: 16px;
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 18px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .model-selector {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .controls {
                padding: 15px 20px;
            }

            .comparison-area {
                padding: 20px 15px;
            }
        }

        /* å¹³æ¿é€‚é… */
        @media (min-width: 769px) and (max-width: 1024px) {
            .comparison-grid {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            }
        }

        /* æ™®é€šæ¡Œé¢ */
        @media (min-width: 1025px) and (max-width: 1920px) {
            .comparison-grid {
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            }
        }

        /* 2Kå±å¹• */
        @media (min-width: 1921px) and (max-width: 2559px) {
            .comparison-grid {
                grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ åŒ»ç–—æ¨¡å‹ä¸ªæ€§åŒ–è¯„ä¼°ç³»ç»Ÿ</h1>
            <p>å¤šç»´åº¦ã€ä¸ªæ€§åŒ–è¯„ä¼°AIæ¨¡å‹çš„ç—…å†ç”Ÿæˆè´¨é‡</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label class="control-label">ğŸ“‹ é€‰æ‹©æ‚£è€… (å¯å¤šé€‰):</label>
                <div class="patient-selector" id="patientSelector"></div>
            </div>

            <div class="control-group">
                <label class="control-label">ğŸ¤– é€‰æ‹©æ¨¡å‹ (å¯å¤šé€‰):</label>
                <div class="model-selector" id="modelSelector"></div>
            </div>

            <div class="control-group">
                <label class="control-label">ğŸ“ é€‰æ‹©å¯¹è¯ç±»å‹ (å¯å¤šé€‰):</label>
                <div class="conv-type-selector" id="convTypeSelector"></div>
            </div>

            <div class="control-group">
                <label class="control-label">ğŸ¨ å¸ƒå±€æ–¹å¼:</label>
                <div style="display: flex; gap: 15px;">
                    <label class="layout-radio" style="display: flex; align-items: center; cursor: pointer; padding: 10px 20px; background: white; border: 2px solid #667eea; border-radius: 8px; font-weight: 500;">
                        <input type="radio" name="layout" value="wrap" checked onchange="changeLayout(this.value)" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <span>è‡ªåŠ¨æ¢è¡Œ</span>
                    </label>
                    <label class="layout-radio" style="display: flex; align-items: center; cursor: pointer; padding: 10px 20px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; font-weight: 500;">
                        <input type="radio" name="layout" value="horizontal" onchange="changeLayout(this.value)" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <span>å›ºå®šæ¨ªå‘æ’åˆ—</span>
                    </label>
                </div>
            </div>

            <div class="stats" id="stats"></div>
        </div>

        <div class="comparison-area" id="comparisonArea">
            <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        </div>
    </div>

    <button class="clear-btn" onclick="clearAllRatings()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è¯„åˆ†</button>
    <button class="export-btn" onclick="exportRatings()">ğŸ’¾ å¯¼å‡ºè¯„åˆ†æ•°æ®</button>

    <script>
        // è¯„åˆ†æ•°æ®å­˜å‚¨
        // ä» localStorage åŠ è½½è¯„åˆ†æ•°æ®
        let ratingsData = JSON.parse(localStorage.getItem('ratingsData') || '{}');
        let comparisonData = null;
        let selectedPatients = new Set();
        let selectedModels = new Set();
        let selectedConvTypes = new Set();
        let currentLayout = 'wrap'; // é»˜è®¤è‡ªåŠ¨æ¢è¡Œ

        // ä¿å­˜è¯„åˆ†æ•°æ®åˆ° localStorage
        function saveRatingsData() {
            localStorage.setItem('ratingsData', JSON.stringify(ratingsData));
        }

        // ä¸ºæ¨¡å‹åˆ†é…æŸ”å’Œçš„æ¸å˜è‰²
        const modelColors = {
            'gpt-5.1': { start: '#667eea', end: '#764ba2' },
            'deepseek/deepseek-v3.1': { start: '#f093fb', end: '#f5576c' },
            'gemini-2.5-pro': { start: '#4facfe', end: '#00f2fe' },
            'qwen3-max': { start: '#43e97b', end: '#38f9d7' },
            'grok-4-0709': { start: '#fa709a', end: '#fee140' },
            'moonshotai/kimi-k2-0905': { start: '#30cfd0', end: '#330867' },
            'doubao-seed-1-6-251015': { start: '#a8edea', end: '#fed6e3' },
            'Baichuan-M2': { start: '#ff9a9e', end: '#fecfef' }
        };

        // è·å–æ¨¡å‹é¢œè‰²,å¦‚æœæ²¡æœ‰é¢„å®šä¹‰åˆ™ç”ŸæˆæŸ”å’Œçš„é¢œè‰²
        function getModelColor(model) {
            if (modelColors[model]) {
                return modelColors[model];
            }

            // ä¸ºæœªçŸ¥æ¨¡å‹ç”ŸæˆæŸ”å’Œçš„é¢œè‰²
            const hue = (model.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 360);
            const start = `hsl(${hue}, 65%, 65%)`;
            const end = `hsl(${(hue + 30) % 360}, 65%, 75%)`;

            modelColors[model] = { start, end };
            return modelColors[model];
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const response = await fetch('output/comparison_data.json');
                comparisonData = await response.json();
                initializeUI();
            } catch (error) {
                document.getElementById('comparisonArea').innerHTML =
                    '<div class="no-data">âŒ æ•°æ®åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åˆå§‹åŒ–UI
        function initializeUI() {
            // åˆå§‹åŒ–æ‚£è€…é€‰æ‹©å™¨
            const patientSelector = document.getElementById('patientSelector');

            // æ·»åŠ å…¨é€‰æŒ‰é’®
            const selectAllPatientsBtn = document.createElement('button');
            selectAllPatientsBtn.className = 'select-all-patients-btn';
            selectAllPatientsBtn.textContent = 'âœ“ å…¨é€‰æ‚£è€…';
            selectAllPatientsBtn.onclick = selectAllPatients;
            patientSelector.appendChild(selectAllPatientsBtn);

            comparisonData.patients.forEach(patient => {
                const label = document.createElement('label');
                label.className = 'patient-checkbox';
                label.innerHTML = `
                    <input type="checkbox" value="${patient}" onchange="togglePatient('${patient}', this.checked)">
                    <span>${patient}</span>
                `;
                patientSelector.appendChild(label);
            });

            // åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©å™¨
            const modelSelector = document.getElementById('modelSelector');

            // æ·»åŠ å…¨é€‰æ¨¡å‹æŒ‰é’®
            const selectAllModelsBtn = document.createElement('label');
            selectAllModelsBtn.className = 'model-checkbox';
            selectAllModelsBtn.style.cssText = 'cursor: pointer; background: #667eea; color: white; border-color: #667eea; font-weight: 600;';
            selectAllModelsBtn.innerHTML = `
                <input type="button" value="å…¨é€‰" onclick="selectAllModels()" style="display: none;">
                <span onclick="selectAllModels()">âœ“ å…¨é€‰æ¨¡å‹</span>
            `;
            modelSelector.appendChild(selectAllModelsBtn);

            comparisonData.models.forEach(model => {
                const label = document.createElement('label');
                label.className = 'model-checkbox';
                label.innerHTML = `
                    <input type="checkbox" value="${model}" onchange="toggleModel('${model}', this.checked)">
                    <span>${model}</span>
                `;
                modelSelector.appendChild(label);
            });

            // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæ‚£è€…
            if (comparisonData.patients.length > 0) {
                const firstPatient = comparisonData.patients[0];
                selectedPatients.add(firstPatient);

                // æ›´æ–°UI
                document.querySelectorAll('.patient-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input');
                    if (checkbox.value === firstPatient) {
                        checkbox.checked = true;
                        label.classList.add('selected');
                    }
                });

                updateConvTypeSelector();
                updateComparison();
            }

            updateStats();
        }

        // åˆ‡æ¢æ‚£è€…é€‰æ‹©
        function togglePatient(patient, checked) {
            if (checked) {
                selectedPatients.add(patient);
            } else {
                selectedPatients.delete(patient);
            }

            // æ›´æ–°checkboxçŠ¶æ€
            document.querySelectorAll('.patient-checkbox').forEach(label => {
                const checkbox = label.querySelector('input');
                label.classList.toggle('selected', checkbox.checked);
            });

            // æ›´æ–°å¯¹è¯ç±»å‹é€‰æ‹©å™¨
            updateConvTypeSelector();

            // æ›´æ–°æ˜¾ç¤º
            updateComparison();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰æ‚£è€…
        function selectAllPatients() {
            const allSelected = selectedPatients.size === comparisonData.patients.length;

            if (allSelected) {
                // å–æ¶ˆå…¨é€‰
                selectedPatients.clear();

                // æ›´æ–°UI
                document.querySelectorAll('.patient-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input');
                    checkbox.checked = false;
                    label.classList.remove('selected');
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.select-all-patients-btn');
                btn.textContent = 'âœ“ å…¨é€‰æ‚£è€…';
            } else {
                // å…¨é€‰
                selectedPatients.clear();
                comparisonData.patients.forEach(patient => {
                    selectedPatients.add(patient);
                });

                // æ›´æ–°UI
                document.querySelectorAll('.patient-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input');
                    checkbox.checked = true;
                    label.classList.add('selected');
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.select-all-patients-btn');
                btn.textContent = 'âœ— å–æ¶ˆå…¨é€‰';
            }

            updateConvTypeSelector();
            updateComparison();
        }

        // æ›´æ–°å¯¹è¯ç±»å‹é€‰æ‹©å™¨
        function updateConvTypeSelector() {
            const convTypeSelector = document.getElementById('convTypeSelector');
            convTypeSelector.innerHTML = '';

            if (selectedPatients.size === 0) return;

            // æ”¶é›†æ‰€æœ‰é€‰ä¸­æ‚£è€…çš„å¯¹è¯ç±»å‹ï¼ˆå–äº¤é›†ï¼‰
            const convTypes = {};
            let isFirst = true;

            selectedPatients.forEach(patient => {
                const patientData = comparisonData.data[patient];
                if (!patientData) return;

                if (isFirst) {
                    // ç¬¬ä¸€ä¸ªæ‚£è€…ï¼Œåˆå§‹åŒ–å¯¹è¯ç±»å‹
                    Object.entries(patientData).forEach(([convId, models]) => {
                        Object.values(models).forEach(data => {
                            if (data.title) {
                                convTypes[convId] = data.title;
                            }
                        });
                    });
                    isFirst = false;
                }
            });

            // æ·»åŠ å…¨é€‰æŒ‰é’®
            const selectAllBtn = document.createElement('button');
            selectAllBtn.className = 'select-all-btn';
            selectAllBtn.textContent = 'âœ“ å…¨é€‰ç±»å‹';
            selectAllBtn.onclick = () => selectAllConvTypes(convTypes);
            convTypeSelector.appendChild(selectAllBtn);

            // åˆ›å»ºå¯¹è¯ç±»å‹å¤é€‰æ¡†
            Object.entries(convTypes).forEach(([convId, title]) => {
                const label = document.createElement('label');
                label.className = 'conv-type-checkbox';

                const isChecked = selectedConvTypes.has(convId);
                label.innerHTML = `
                    <input type="checkbox" value="${convId}" ${isChecked ? 'checked' : ''} onchange="toggleConvType('${convId}', this.checked)">
                    <span>${title}</span>
                `;

                if (isChecked) {
                    label.classList.add('selected');
                }

                convTypeSelector.appendChild(label);
            });

            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„å¯¹è¯ç±»å‹ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
            if (selectedConvTypes.size === 0) {
                const firstConvId = Object.keys(convTypes)[0];
                if (firstConvId) {
                    toggleConvType(firstConvId, true);
                }
            }
        }

        // åˆ‡æ¢å¯¹è¯ç±»å‹
        function toggleConvType(convId, checked) {
            if (checked) {
                selectedConvTypes.add(convId);
            } else {
                selectedConvTypes.delete(convId);
            }

            // æ›´æ–°checkboxçŠ¶æ€
            document.querySelectorAll('.conv-type-checkbox').forEach(label => {
                const checkbox = label.querySelector('input');
                label.classList.toggle('selected', checkbox.checked);
            });

            updateComparison();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰å¯¹è¯ç±»å‹
        function selectAllConvTypes(convTypes) {
            const allConvTypeIds = Object.keys(convTypes);
            const allSelected = allConvTypeIds.every(convId => selectedConvTypes.has(convId));

            if (allSelected) {
                // å–æ¶ˆå…¨é€‰
                selectedConvTypes.clear();

                // æ›´æ–°UI
                document.querySelectorAll('.conv-type-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input');
                    checkbox.checked = false;
                    label.classList.remove('selected');
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.select-all-btn');
                btn.textContent = 'âœ“ å…¨é€‰ç±»å‹';
            } else {
                // å…¨é€‰
                selectedConvTypes.clear();
                allConvTypeIds.forEach(convId => {
                    selectedConvTypes.add(convId);
                });

                // æ›´æ–°UI
                document.querySelectorAll('.conv-type-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input');
                    checkbox.checked = true;
                    label.classList.add('selected');
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.select-all-btn');
                btn.textContent = 'âœ— å–æ¶ˆå…¨é€‰';
            }

            updateComparison();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰æ¨¡å‹
        function selectAllModels() {
            const allSelected = selectedModels.size === comparisonData.models.length;

            if (allSelected) {
                // å–æ¶ˆå…¨é€‰
                selectedModels.clear();

                // æ›´æ–°UI
                document.querySelectorAll('.model-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = false;
                        label.classList.remove('selected');
                    }
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.model-checkbox span[onclick="selectAllModels()"]');
                if (btn) btn.textContent = 'âœ“ å…¨é€‰æ¨¡å‹';
            } else {
                // å…¨é€‰
                selectedModels.clear();
                comparisonData.models.forEach(model => {
                    selectedModels.add(model);
                });

                // æ›´æ–°UI
                document.querySelectorAll('.model-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = true;
                        label.classList.add('selected');
                    }
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.model-checkbox span[onclick="selectAllModels()"]');
                if (btn) btn.textContent = 'âœ— å–æ¶ˆå…¨é€‰';
            }

            updateComparison();
        }

        // åˆ‡æ¢æ¨¡å‹é€‰æ‹©
        function toggleModel(model, checked) {
            if (checked) {
                selectedModels.add(model);
            } else {
                selectedModels.delete(model);
            }

            // æ›´æ–°checkboxçŠ¶æ€
            document.querySelectorAll('.model-checkbox').forEach(label => {
                const checkbox = label.querySelector('input');
                label.classList.toggle('selected', checkbox.checked);
            });

            updateComparison();
        }

        // æ›´æ–°å¯¹æ¯”æ˜¾ç¤º
        function updateComparison() {
            const comparisonArea = document.getElementById('comparisonArea');

            if (selectedPatients.size === 0 || selectedConvTypes.size === 0 || selectedModels.size === 0) {
                comparisonArea.innerHTML = '<div class="no-data">ğŸ‘† è¯·é€‰æ‹©æ‚£è€…ã€æ¨¡å‹å’Œå¯¹è¯ç±»å‹</div>';
                return;
            }

            comparisonArea.innerHTML = '';

            // ä¸ºæ¯ä¸ªé€‰ä¸­çš„æ‚£è€…åˆ›å»ºåŒºå—
            selectedPatients.forEach(patient => {
                const patientData = comparisonData.data[patient];
                if (!patientData) return;

                // åˆ›å»ºæ‚£è€…åˆ†ç»„æ ‡é¢˜
                const patientTitle = document.createElement('h1');
                patientTitle.style.cssText = 'font-size: 24px; margin: 40px 0 25px 0; color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px; font-weight: 700;';
                patientTitle.textContent = `ğŸ“‹ ${patient}`;
                comparisonArea.appendChild(patientTitle);

                // ä¸ºæ¯ä¸ªé€‰ä¸­çš„å¯¹è¯ç±»å‹åˆ›å»ºä¸€ä¸ªåŒºå—
                selectedConvTypes.forEach(convId => {
                    const convData = patientData[convId];
                    if (!convData) return;

                    // è·å–å¯¹è¯ç±»å‹æ ‡é¢˜
                    let convTitle = 'æœªçŸ¥ç±»å‹';
                    Object.values(convData).forEach(data => {
                        if (data.title) {
                            convTitle = data.title;
                        }
                    });

                    // åˆ›å»ºåˆ†ç»„æ ‡é¢˜
                    const sectionTitle = document.createElement('h2');
                    sectionTitle.style.cssText = 'font-size: 18px; margin: 25px 0 15px 0; color: #333; border-left: 4px solid #764ba2; padding-left: 15px;';
                    sectionTitle.textContent = `${convTitle} (å¯¹è¯ ${convId})`;
                    comparisonArea.appendChild(sectionTitle);

                    // åˆ›å»ºæ¨¡å‹å¡ç‰‡ç½‘æ ¼
                    const grid = document.createElement('div');
                    grid.className = 'comparison-grid';
                    if (currentLayout === 'horizontal') {
                        grid.classList.add('horizontal-layout');
                        grid.dataset.convId = convId; // æ ‡è®°å¯¹è¯ç±»å‹IDç”¨äºåŒæ­¥æ»šåŠ¨
                    }

                    // æŒ‰ç…§æ¨¡å‹é€‰æ‹©çš„é¡ºåºåˆ›å»ºå¡ç‰‡ï¼Œç¡®ä¿ä¸åŒæ‚£è€…çš„ç›¸åŒå¯¹è¯ç±»å‹ä¸­æ¨¡å‹é¡ºåºä¸€è‡´
                    const sortedModels = Array.from(selectedModels).sort();
                    sortedModels.forEach(model => {
                        if (convData[model]) {
                            const card = createModelCard(model, convData[model], patient, convId);
                            grid.appendChild(card);
                        }
                    });

                    comparisonArea.appendChild(grid);
                });
            });

            // åœ¨æ¨ªå‘å¸ƒå±€æ¨¡å¼ä¸‹ï¼Œä¸ºç›¸åŒå¯¹è¯ç±»å‹çš„åŒºå—æ·»åŠ åŒæ­¥æ»šåŠ¨
            if (currentLayout === 'horizontal') {
                syncHorizontalScroll();
            }
        }

        // åŒæ­¥æ¨ªå‘æ»šåŠ¨
        function syncHorizontalScroll() {
            const horizontalGrids = document.querySelectorAll('.comparison-grid.horizontal-layout');

            // æŒ‰å¯¹è¯ç±»å‹åˆ†ç»„
            const gridsByConvId = {};
            horizontalGrids.forEach(grid => {
                const convId = grid.dataset.convId;
                if (!gridsByConvId[convId]) {
                    gridsByConvId[convId] = [];
                }
                gridsByConvId[convId].push(grid);
            });

            // ä¸ºæ¯ç»„ç›¸åŒå¯¹è¯ç±»å‹çš„gridæ·»åŠ åŒæ­¥æ»šåŠ¨
            Object.values(gridsByConvId).forEach(grids => {
                if (grids.length <= 1) return; // åªæœ‰ä¸€ä¸ªgridä¸éœ€è¦åŒæ­¥

                grids.forEach(grid => {
                    // ç§»é™¤ä¹‹å‰çš„æ»šåŠ¨ç›‘å¬ï¼ˆé¿å…é‡å¤ç»‘å®šï¼‰
                    grid.onscroll = null;

                    grid.addEventListener('scroll', function() {
                        const scrollLeft = this.scrollLeft;

                        // åŒæ­¥å…¶ä»–ç›¸åŒå¯¹è¯ç±»å‹çš„grid
                        grids.forEach(otherGrid => {
                            if (otherGrid !== this) {
                                otherGrid.scrollLeft = scrollLeft;
                            }
                        });
                    });
                });
            });
        }

        // åˆ›å»ºæ¨¡å‹å¡ç‰‡
        function createModelCard(model, data, patient, convId) {
            const card = document.createElement('div');
            card.className = 'model-card';

            const header = document.createElement('div');
            header.className = 'model-card-header';
            header.textContent = model;

            // åº”ç”¨æ¨¡å‹ç‰¹å®šçš„é¢œè‰²
            const colors = getModelColor(model);
            header.style.background = `linear-gradient(135deg, ${colors.start} 0%, ${colors.end} 100%)`;

            const body = document.createElement('div');
            body.className = 'model-card-body';

            // æ ¼å¼åŒ–è¾“å‡ºå†…å®¹
            const formattedOutput = formatOutput(data.output);
            body.innerHTML = formattedOutput;

            // åˆ›å»ºè¯„åˆ†é¢æ¿
            const ratingPanel = createRatingPanel(model, patient, convId);

            card.appendChild(header);
            card.appendChild(body);
            card.appendChild(ratingPanel);

            return card;
        }

        // æ ¹æ®å¯¹è¯ç±»å‹è·å–è¯„åˆ†é…ç½®
        function getRatingConfig(convId) {
            const configs = {
                '1': { // ä¸»è¯‰
                    title: 'ä¸»è¯‰è¯„ä¼°',
                    sliders: [
                        { id: 'symptom_clarity', label: 'ç—‡çŠ¶æè¿°æ¸…æ™°åº¦' },
                        { id: 'time_accuracy', label: 'æ—¶é—´ä¿¡æ¯å‡†ç¡®æ€§' }
                    ],
                    strengths: [
                        { id: 'str_concise', label: 'ç®€æ´æ˜äº†' },
                        { id: 'str_complete', label: 'è¦ç´ å®Œæ•´' },
                        { id: 'str_accurate', label: 'è¡¨è¿°å‡†ç¡®' }
                    ],
                    issues: [
                        { id: 'iss_verbose', label: 'è¿‡äºå†—é•¿' },
                        { id: 'iss_missing', label: 'å…³é”®ä¿¡æ¯ç¼ºå¤±' },
                        { id: 'iss_ambiguous', label: 'è¡¨è¿°æ¨¡ç³Š' }
                    ]
                },
                '2': { // ç°ç—…å²
                    title: 'ç°ç—…å²è¯„ä¼°',
                    sliders: [
                        { id: 'timeline_logic', label: 'æ—¶é—´çº¿é€»è¾‘æ€§' },
                        { id: 'detail_richness', label: 'ç»†èŠ‚ä¸°å¯Œåº¦' }
                    ],
                    strengths: [
                        { id: 'str_chronological', label: 'æ—¶åºæ¸…æ™°' },
                        { id: 'str_comprehensive', label: 'å†…å®¹å…¨é¢' },
                        { id: 'str_relevant', label: 'ç›¸å…³æ€§å¼º' }
                    ],
                    issues: [
                        { id: 'iss_confusing', label: 'æ—¶åºæ··ä¹±' },
                        { id: 'iss_incomplete', label: 'ç—…ç¨‹ä¸å®Œæ•´' },
                        { id: 'iss_irrelevant', label: 'æ— å…³ä¿¡æ¯è¿‡å¤š' }
                    ]
                },
                '3': { // æ—¢å¾€å²
                    title: 'æ—¢å¾€å²è¯„ä¼°',
                    sliders: [
                        { id: 'disease_coverage', label: 'æ—¢å¾€ç–¾ç—…è¦†ç›–åº¦' },
                        { id: 'format_standard', label: 'æ ¼å¼è§„èŒƒæ€§' }
                    ],
                    strengths: [
                        { id: 'str_systematic', label: 'ç³»ç»Ÿå…¨é¢' },
                        { id: 'str_structured', label: 'ç»“æ„æ¸…æ™°' }
                    ],
                    issues: [
                        { id: 'iss_omission', label: 'é‡è¦ç—…å²é—æ¼' },
                        { id: 'iss_disorganized', label: 'ç»„ç»‡æ··ä¹±' }
                    ]
                },
                '4': { // é¢„é—®è¯Šæ€»ç»“
                    title: 'é¢„é—®è¯Šæ€»ç»“è¯„ä¼°',
                    sliders: [
                        { id: 'summary_completeness', label: 'ä¿¡æ¯æ•´åˆå®Œæ•´åº¦' },
                        { id: 'format_professional', label: 'ä¸“ä¸šæ ¼å¼è§„èŒƒåº¦' }
                    ],
                    strengths: [
                        { id: 'str_integrated', label: 'ä¿¡æ¯æ•´åˆå¥½' },
                        { id: 'str_professional', label: 'ä¸“ä¸šè§„èŒƒ' },
                        { id: 'str_structured', label: 'å±‚æ¬¡æ¸…æ™°' }
                    ],
                    issues: [
                        { id: 'iss_redundant', label: 'ä¿¡æ¯å†—ä½™' },
                        { id: 'iss_inconsistent', label: 'å‰åä¸ä¸€è‡´' },
                        { id: 'iss_unprofessional', label: 'æ ¼å¼ä¸ä¸“ä¸š' }
                    ]
                },
                '5': { // å®¶æ—å²
                    title: 'å®¶æ—å²è¯„ä¼°',
                    sliders: [
                        { id: 'relationship_clarity', label: 'äº²å±å…³ç³»æ¸…æ™°åº¦' },
                        { id: 'info_accuracy', label: 'ä¿¡æ¯å‡†ç¡®æ€§' }
                    ],
                    strengths: [
                        { id: 'str_clear', label: 'å…³ç³»æ˜ç¡®' },
                        { id: 'str_specific', label: 'ä¿¡æ¯å…·ä½“' }
                    ],
                    issues: [
                        { id: 'iss_vague', label: 'å…³ç³»è¡¨è¿°ä¸æ¸…' },
                        { id: 'iss_incomplete', label: 'ä¿¡æ¯ä¸å®Œæ•´' }
                    ]
                }
            };

            return configs[convId] || configs['1']; // é»˜è®¤ä½¿ç”¨ä¸»è¯‰é…ç½®
        }

        // åˆ›å»ºè¯„åˆ†é¢æ¿
        function createRatingPanel(model, patient, convId) {
            const panel = document.createElement('div');
            panel.className = 'rating-panel';

            const ratingKey = `${patient}_${convId}_${model}`;
            const config = getRatingConfig(convId);

            // ç¬¬ä¸€éƒ¨åˆ†ï¼šé‡åŒ–è¯„åˆ†
            const section1 = document.createElement('div');
            section1.className = 'rating-section';
            let slidersHTML = `<div class="section-title">ğŸ“Š ${config.title} (0-10åˆ†)</div>`;
            config.sliders.forEach(slider => {
                slidersHTML += `
                    <div class="slider-item">
                        <label>${slider.label}</label>
                        <input type="range" min="0" max="10" value="5"
                               oninput="setSliderRating('${ratingKey}', '${slider.id}', this.value, this.nextElementSibling)">
                        <span class="slider-value">5</span>
                    </div>
                `;
            });
            section1.innerHTML = slidersHTML;

            // ç¬¬äºŒéƒ¨åˆ†ï¼šä¼˜ç‚¹
            const section2 = document.createElement('div');
            section2.className = 'rating-section';
            let strengthsHTML = `
                <div class="section-title">
                    âœ… ä¼˜ç‚¹ (å¯å¤šé€‰)
                    <button onclick="toggleAllStrengths('${ratingKey}', this)"
                            style="margin-left: 10px; padding: 4px 12px; background: #4caf50; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 12px; font-weight: 600;">
                        å…¨é€‰
                    </button>
                </div>
                <div class="checkbox-group" data-group="strengths-${ratingKey}">`;
            config.strengths.forEach(item => {
                strengthsHTML += `
                    <label class="checkbox-item">
                        <input type="checkbox" data-strength="${item.id}" onchange="toggleCheckbox('${ratingKey}', '${item.id}', this.checked, this.parentElement)">
                        <span>${item.label}</span>
                    </label>
                `;
            });
            strengthsHTML += `</div>`;
            section2.innerHTML = strengthsHTML;

            // ç¬¬ä¸‰éƒ¨åˆ†ï¼šé—®é¢˜
            const section3 = document.createElement('div');
            section3.className = 'rating-section';
            let issuesHTML = `
                <div class="section-title">
                    âš ï¸ é—®é¢˜ (å¯å¤šé€‰)
                    <button onclick="toggleAllIssues('${ratingKey}', this)"
                            style="margin-left: 10px; padding: 4px 12px; background: #ff9800; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 12px; font-weight: 600;">
                        å…¨é€‰
                    </button>
                </div>
                <div class="checkbox-group" data-group="issues-${ratingKey}">`;
            config.issues.forEach(item => {
                issuesHTML += `
                    <label class="checkbox-item">
                        <input type="checkbox" data-issue="${item.id}" onchange="toggleCheckbox('${ratingKey}', '${item.id}', this.checked, this.parentElement)">
                        <span>${item.label}</span>
                    </label>
                `;
            });
            issuesHTML += `</div>`;
            section3.innerHTML = issuesHTML;

            // ç¬¬å››éƒ¨åˆ†ï¼šå¤‡æ³¨
            const section4 = document.createElement('div');
            section4.className = 'rating-section';
            section4.innerHTML = `
                <div class="section-title">ğŸ’¬ å¤‡æ³¨</div>
                <textarea placeholder="å¯é€‰ï¼šè¡¥å……è¯´æ˜..."
                          onchange="setComment('${ratingKey}', this.value)"
                          style="width: 100%; min-height: 60px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 13px;"></textarea>
            `;

            panel.appendChild(section1);
            panel.appendChild(section2);
            panel.appendChild(section3);
            panel.appendChild(section4);

            // æ¢å¤å·²ä¿å­˜çš„æ•°æ®
            setTimeout(() => {
                const savedData = ratingsData[ratingKey];
                if (savedData) {
                    // æ¢å¤æ»‘å—è¯„åˆ†
                    if (savedData.scores) {
                        Object.keys(savedData.scores).forEach(dimension => {
                            const slider = panel.querySelector(`input[type="range"][oninput*="${dimension}"]`);
                            if (slider) {
                                slider.value = savedData.scores[dimension];
                                const valueSpan = slider.nextElementSibling;
                                if (valueSpan) {
                                    valueSpan.textContent = savedData.scores[dimension];
                                }
                            }
                        });
                    }

                    // æ¢å¤å¤é€‰æ¡†çŠ¶æ€
                    if (savedData.checkboxes) {
                        Object.keys(savedData.checkboxes).forEach(dimension => {
                            if (savedData.checkboxes[dimension]) {
                                const checkbox = panel.querySelector(`input[type="checkbox"][data-strength="${dimension}"], input[type="checkbox"][data-issue="${dimension}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    checkbox.parentElement.classList.add('checked');
                                }
                            }
                        });
                    }

                    // æ¢å¤å¤‡æ³¨
                    if (savedData.comment) {
                        const textarea = panel.querySelector('textarea');
                        if (textarea) {
                            textarea.value = savedData.comment;
                        }
                    }

                    // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
                    updateToggleButtons(ratingKey);
                }
            }, 0);

            return panel;
        }

        // è®¾ç½®æ»‘å—è¯„åˆ†
        function setSliderRating(ratingKey, dimension, value, valueElement) {
            if (!ratingsData[ratingKey]) {
                ratingsData[ratingKey] = { scores: {}, checkboxes: {}, comment: '' };
            }
            ratingsData[ratingKey].scores = ratingsData[ratingKey].scores || {};
            ratingsData[ratingKey].scores[dimension] = parseInt(value);
            valueElement.textContent = value;
            saveRatingsData(); // ä¿å­˜åˆ° localStorage
        }

        // åˆ‡æ¢å¤é€‰æ¡†
        function toggleCheckbox(ratingKey, dimension, checked, labelElement) {
            if (!ratingsData[ratingKey]) {
                ratingsData[ratingKey] = { scores: {}, checkboxes: {}, comment: '' };
            }
            ratingsData[ratingKey].checkboxes = ratingsData[ratingKey].checkboxes || {};
            ratingsData[ratingKey].checkboxes[dimension] = checked;

            // æ›´æ–°æ ·å¼
            if (checked) {
                labelElement.classList.add('checked');
            } else {
                labelElement.classList.remove('checked');
            }

            saveRatingsData(); // ä¿å­˜åˆ° localStorage
        }

        // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
        function updateToggleButtons(ratingKey) {
            // æ›´æ–°ä¼˜ç‚¹å…¨é€‰æŒ‰é’®
            const strengthsGroup = document.querySelector(`[data-group="strengths-${ratingKey}"]`);
            if (strengthsGroup) {
                const checkboxes = strengthsGroup.querySelectorAll('input[type="checkbox"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                const button = strengthsGroup.previousElementSibling?.querySelector('button');
                if (button) {
                    button.textContent = allChecked ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰';
                    button.style.background = allChecked ? '#9e9e9e' : '#4caf50';
                }
            }

            // æ›´æ–°é—®é¢˜å…¨é€‰æŒ‰é’®
            const issuesGroup = document.querySelector(`[data-group="issues-${ratingKey}"]`);
            if (issuesGroup) {
                const checkboxes = issuesGroup.querySelectorAll('input[type="checkbox"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                const button = issuesGroup.previousElementSibling?.querySelector('button');
                if (button) {
                    button.textContent = allChecked ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰';
                    button.style.background = allChecked ? '#9e9e9e' : '#ff9800';
                }
            }
        }

        // å…¨é€‰/å–æ¶ˆä¼˜ç‚¹å¤é€‰æ¡†
        function toggleAllStrengths(ratingKey, button) {
            const group = document.querySelector(`[data-group="strengths-${ratingKey}"]`);
            if (!group) return;

            const checkboxes = group.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(checkbox => {
                const shouldCheck = !allChecked;
                checkbox.checked = shouldCheck;
                const itemId = checkbox.getAttribute('data-strength');

                // æ›´æ–°æ•°æ®ä½†ä¸é‡å¤ä¿å­˜
                if (!ratingsData[ratingKey]) {
                    ratingsData[ratingKey] = { scores: {}, checkboxes: {}, comment: '' };
                }
                ratingsData[ratingKey].checkboxes = ratingsData[ratingKey].checkboxes || {};
                ratingsData[ratingKey].checkboxes[itemId] = shouldCheck;

                // æ›´æ–°æ ·å¼
                if (shouldCheck) {
                    checkbox.parentElement.classList.add('checked');
                } else {
                    checkbox.parentElement.classList.remove('checked');
                }
            });

            button.textContent = allChecked ? 'å…¨é€‰' : 'å–æ¶ˆå…¨é€‰';
            button.style.background = allChecked ? '#4caf50' : '#9e9e9e';

            saveRatingsData(); // ä¸€æ¬¡æ€§ä¿å­˜æ‰€æœ‰æ›´æ”¹
        }

        // å…¨é€‰/å–æ¶ˆé—®é¢˜å¤é€‰æ¡†
        function toggleAllIssues(ratingKey, button) {
            const group = document.querySelector(`[data-group="issues-${ratingKey}"]`);
            if (!group) return;

            const checkboxes = group.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(checkbox => {
                const shouldCheck = !allChecked;
                checkbox.checked = shouldCheck;
                const itemId = checkbox.getAttribute('data-issue');

                // æ›´æ–°æ•°æ®ä½†ä¸é‡å¤ä¿å­˜
                if (!ratingsData[ratingKey]) {
                    ratingsData[ratingKey] = { scores: {}, checkboxes: {}, comment: '' };
                }
                ratingsData[ratingKey].checkboxes = ratingsData[ratingKey].checkboxes || {};
                ratingsData[ratingKey].checkboxes[itemId] = shouldCheck;

                // æ›´æ–°æ ·å¼
                if (shouldCheck) {
                    checkbox.parentElement.classList.add('checked');
                } else {
                    checkbox.parentElement.classList.remove('checked');
                }
            });

            button.textContent = allChecked ? 'å…¨é€‰' : 'å–æ¶ˆå…¨é€‰';
            button.style.background = allChecked ? '#ff9800' : '#9e9e9e';

            saveRatingsData(); // ä¸€æ¬¡æ€§ä¿å­˜æ‰€æœ‰æ›´æ”¹
        }

        // è®¾ç½®è¯„è®º
        function setComment(ratingKey, comment) {
            if (!ratingsData[ratingKey]) {
                ratingsData[ratingKey] = { scores: {}, checkboxes: {}, comment: '' };
            }
            ratingsData[ratingKey].comment = comment;
            saveRatingsData(); // ä¿å­˜åˆ° localStorage
        }

        // æ ¼å¼åŒ–è¾“å‡ºå†…å®¹
        function formatOutput(text) {
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br>
            let formatted = text.replace(/\n/g, '<br>');

            // åŠ ç²—æ ‡é¢˜
            formatted = formatted.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^\*\*(.+?)\*\*:/gm, '<strong>$1:</strong>');

            // åˆ—è¡¨é¡¹
            formatted = formatted.replace(/^- (.+)$/gm, 'â€¢ $1');
            formatted = formatted.replace(/^\* (.+)$/gm, 'â€¢ $1');

            return formatted;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${comparisonData.models.length}</div>
                    <div class="stat-label">æ¨¡å‹æ€»æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${comparisonData.patients.length}</div>
                    <div class="stat-label">æ‚£è€…æ•°é‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${selectedModels.size}</div>
                    <div class="stat-label">å·²é€‰æ¨¡å‹</div>
                </div>
            `;
        }

        // åˆ‡æ¢å¸ƒå±€æ–¹å¼
        function changeLayout(layout) {
            currentLayout = layout;

            // æ›´æ–°å•é€‰æ¡†æ ·å¼
            document.querySelectorAll('.layout-radio').forEach(label => {
                const radio = label.querySelector('input');
                if (radio.checked) {
                    label.style.borderColor = '#667eea';
                    label.style.background = '#f0f4ff';
                } else {
                    label.style.borderColor = '#e0e0e0';
                    label.style.background = 'white';
                }
            });

            // é‡æ–°æ¸²æŸ“å¯¹æ¯”åŒºåŸŸ
            updateComparison();
        }

        // æ¸…ç©ºæ‰€æœ‰è¯„åˆ†æ•°æ®
        function clearAllRatings() {
            if (Object.keys(ratingsData).length === 0) {
                alert('âš ï¸ å½“å‰æ²¡æœ‰ä»»ä½•è¯„åˆ†æ•°æ®ï¼');
                return;
            }

            if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è¯„åˆ†æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼å»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚')) {
                // æ¸…ç©ºæ•°æ®
                ratingsData = {};
                localStorage.removeItem('ratingsData');

                // åˆ·æ–°é¡µé¢ä»¥é‡ç½®æ‰€æœ‰UI
                location.reload();
            }
        }

        // å¯¼å‡ºè¯„åˆ†æ•°æ®
        function exportRatings() {
            if (Object.keys(ratingsData).length === 0) {
                alert('âš ï¸ è¿˜æ²¡æœ‰ä»»ä½•è¯„åˆ†æ•°æ®ï¼è¯·å…ˆå¯¹æ¨¡å‹è¿›è¡Œè¯„åˆ†ã€‚');
                return;
            }

            // æ•´ç†å¯¼å‡ºæ•°æ®
            const exportData = [];

            Object.keys(ratingsData).forEach(key => {
                const [patient, convId, model] = key.split('_');
                const rating = ratingsData[key];

                // è·å–å¯¹è¯ç±»å‹æ ‡é¢˜
                let convTitle = 'æœªçŸ¥';
                if (comparisonData && comparisonData.data[patient] && comparisonData.data[patient][convId]) {
                    const convData = comparisonData.data[patient][convId];
                    Object.values(convData).forEach(data => {
                        if (data.title) {
                            convTitle = data.title;
                        }
                    });
                }

                // æå–è¯„åˆ†æ•°æ®
                const scores = rating.scores || {};
                const checkboxes = rating.checkboxes || {};

                // è®¡ç®—å¹³å‡åˆ†
                const scoreValues = Object.values(scores);
                const avgScore = scoreValues.length > 0 ? (scoreValues.reduce((a, b) => a + b, 0) / scoreValues.length).toFixed(2) : 0;

                // æ•´ç†å¤é€‰æ¡†æ•°æ®
                const strengths = [];
                const issues = [];

                Object.keys(checkboxes).forEach(key => {
                    if (checkboxes[key]) {
                        if (key.startsWith('str_')) {
                            const label = key.replace('str_', '').replace(/_/g, ' ');
                            strengths.push(label);
                        } else if (key.startsWith('iss_')) {
                            const label = key.replace('iss_', '').replace(/_/g, ' ');
                            issues.push(label);
                        }
                    }
                });

                // åŠ¨æ€æ„å»ºå¯¼å‡ºå¯¹è±¡
                const exportRow = {
                    'æ‚£è€…': patient,
                    'å¯¹è¯ç±»å‹': `${convTitle} (${convId})`,
                    'æ¨¡å‹': model
                };

                // æ·»åŠ æ‰€æœ‰è¯„åˆ†é¡¹
                Object.keys(scores).forEach(key => {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    exportRow[label] = scores[key];
                });

                exportRow['å¹³å‡åˆ†'] = avgScore;
                exportRow['ä¼˜ç‚¹'] = strengths.join('; ') || 'æ— ';
                exportRow['é—®é¢˜'] = issues.join('; ') || 'æ— ';
                exportRow['å¤‡æ³¨'] = rating.comment || '';

                exportData.push(exportRow);
            });

            // è½¬æ¢ä¸ºCSV
            const csv = convertToCSV(exportData);
            downloadCSV(csv, `æ¨¡å‹è¯„åˆ†æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`);

            alert(`âœ… è¯„åˆ†æ•°æ®å¯¼å‡ºæˆåŠŸï¼\nå…±å¯¼å‡º ${exportData.length} æ¡è¯„åˆ†è®°å½•ã€‚`);
        }

        // è½¬æ¢ä¸ºCSVæ ¼å¼
        function convertToCSV(data) {
            if (data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvRows = [];

            // æ·»åŠ  BOM ä»¥æ”¯æŒ Excel æ‰“å¼€ä¸­æ–‡
            csvRows.push('\ufeff' + headers.join(','));

            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    // å¤„ç†åŒ…å«é€—å·ã€æ¢è¡Œæˆ–å¼•å·çš„å­—æ®µ
                    if (typeof value === 'string' && (value.includes(',') || value.includes('\n') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });

            return csvRows.join('\n');
        }

        // ä¸‹è½½CSVæ–‡ä»¶
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        loadData();

        // ç›‘å¬æ¨¡å‹é€‰æ‹©å˜åŒ–ä»¥æ›´æ–°ç»Ÿè®¡
        setInterval(updateStats, 100);
    </script>
</body>
</html>
