<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹æ¨ªè¯„å¯¹æ¯”ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            margin: 0;
            background: white;
            box-shadow: none;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
            position: relative;
        }


        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        .patient-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .patient-checkbox {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .patient-checkbox:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .patient-checkbox.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .patient-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .select-all-patients-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }

        .select-all-patients-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .model-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .model-checkbox {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .model-checkbox:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .model-checkbox.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .model-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .conv-type-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .conv-type-checkbox {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .conv-type-checkbox:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .conv-type-checkbox.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .conv-type-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .select-all-btn {
            padding: 10px 20px;
            border: 2px solid #764ba2;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }

        .select-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .comparison-area {
            padding: 30px 40px;
            min-height: 500px;
            background: white;
        }

        .no-data {
            text-align: center;
            padding: 100px 20px;
            color: #999;
            font-size: 16px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
        }

        /* è¶…å®½å±ä¼˜åŒ– */
        @media (min-width: 2560px) {
            .comparison-grid {
                grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            }
        }

        @media (min-width: 3440px) {
            .comparison-grid {
                grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            }
        }

        .comparison-grid.horizontal-layout {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 20px;
            align-items: flex-start;
        }

        .comparison-grid.horizontal-layout .model-card {
            width: 450px;
            flex-shrink: 0;
        }

        .comparison-grid.horizontal-layout::-webkit-scrollbar {
            height: 12px;
        }

        .comparison-grid.horizontal-layout::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .comparison-grid.horizontal-layout::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 6px;
        }

        .comparison-grid.horizontal-layout::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .model-card {
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .model-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .model-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .patient-info-bar {
            background: #f0f4ff;
            padding: 10px 20px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #555;
        }

        .patient-info-bar .patient-icon {
            font-size: 16px;
        }

        .patient-info-bar .patient-name {
            font-weight: 600;
            color: #667eea;
        }


        .model-card-body {
            padding: 20px;
            max-height: 800px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }

        .model-card-body::-webkit-scrollbar {
            width: 8px;
        }

        .model-card-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .model-card-body::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .model-card-body::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .model-card-body p {
            margin-bottom: 15px;
        }

        .model-card-body h3 {
            margin: 20px 0 10px 0;
            font-size: 16px;
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 18px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .model-selector {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .controls {
                padding: 15px 20px;
            }

            .comparison-area {
                padding: 20px 15px;
            }
        }

        /* å¹³æ¿é€‚é… */
        @media (min-width: 769px) and (max-width: 1024px) {
            .comparison-grid {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            }
        }

        /* æ™®é€šæ¡Œé¢ */
        @media (min-width: 1025px) and (max-width: 1920px) {
            .comparison-grid {
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            }
        }

        /* 2Kå±å¹• */
        @media (min-width: 1921px) and (max-width: 2559px) {
            .comparison-grid {
                grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ åŒ»ç–—æ¨¡å‹æ¨ªè¯„å¯¹æ¯”ç³»ç»Ÿ</h1>
            <p>å¯¹æ¯”ä¸åŒAIæ¨¡å‹åœ¨ç—…å†ç”Ÿæˆä»»åŠ¡ä¸­çš„è¡¨ç°</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label class="control-label">ğŸ“‹ é€‰æ‹©æ‚£è€… (å¯å¤šé€‰):</label>
                <div class="patient-selector" id="patientSelector"></div>
            </div>

            <div class="control-group">
                <label class="control-label">ğŸ¤– é€‰æ‹©æ¨¡å‹ (å¯å¤šé€‰):</label>
                <div class="model-selector" id="modelSelector"></div>
            </div>

            <div class="control-group">
                <label class="control-label">ğŸ“ é€‰æ‹©å¯¹è¯ç±»å‹ (å¯å¤šé€‰):</label>
                <div class="conv-type-selector" id="convTypeSelector"></div>
            </div>

            <div class="control-group">
                <label class="control-label">ğŸ¨ å¸ƒå±€æ–¹å¼:</label>
                <div style="display: flex; gap: 15px;">
                    <label class="layout-radio" style="display: flex; align-items: center; cursor: pointer; padding: 10px 20px; background: white; border: 2px solid #667eea; border-radius: 8px; font-weight: 500;">
                        <input type="radio" name="layout" value="wrap" checked onchange="changeLayout(this.value)" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <span>è‡ªåŠ¨æ¢è¡Œ</span>
                    </label>
                    <label class="layout-radio" style="display: flex; align-items: center; cursor: pointer; padding: 10px 20px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; font-weight: 500;">
                        <input type="radio" name="layout" value="horizontal" onchange="changeLayout(this.value)" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                        <span>å›ºå®šæ¨ªå‘æ’åˆ—</span>
                    </label>
                </div>
            </div>

            <div class="stats" id="stats"></div>
        </div>

        <div class="comparison-area" id="comparisonArea">
            <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        </div>
    </div>

    <script>
        let comparisonData = null;
        let selectedPatients = new Set();
        let selectedModels = new Set();
        let selectedConvTypes = new Set();
        let currentLayout = 'wrap'; // é»˜è®¤è‡ªåŠ¨æ¢è¡Œ

        // ä¸ºæ¨¡å‹åˆ†é…æŸ”å’Œçš„æ¸å˜è‰²
        const modelColors = {
            'gpt-5.1': { start: '#667eea', end: '#764ba2' },
            'deepseek/deepseek-v3.1': { start: '#f093fb', end: '#f5576c' },
            'gemini-2.5-pro': { start: '#4facfe', end: '#00f2fe' },
            'qwen3-max': { start: '#43e97b', end: '#38f9d7' },
            'grok-4-0709': { start: '#fa709a', end: '#fee140' },
            'moonshotai/kimi-k2-0905': { start: '#30cfd0', end: '#330867' },
            'doubao-seed-1-6-251015': { start: '#a8edea', end: '#fed6e3' },
            'Baichuan-M2': { start: '#ff9a9e', end: '#fecfef' }
        };

        // è·å–æ¨¡å‹é¢œè‰²,å¦‚æœæ²¡æœ‰é¢„å®šä¹‰åˆ™ç”ŸæˆæŸ”å’Œçš„é¢œè‰²
        function getModelColor(model) {
            if (modelColors[model]) {
                return modelColors[model];
            }

            // ä¸ºæœªçŸ¥æ¨¡å‹ç”ŸæˆæŸ”å’Œçš„é¢œè‰²
            const hue = (model.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 360);
            const start = `hsl(${hue}, 65%, 65%)`;
            const end = `hsl(${(hue + 30) % 360}, 65%, 75%)`;

            modelColors[model] = { start, end };
            return modelColors[model];
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const response = await fetch('output/comparison_data.json');
                comparisonData = await response.json();
                initializeUI();
            } catch (error) {
                document.getElementById('comparisonArea').innerHTML =
                    '<div class="no-data">âŒ æ•°æ®åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åˆå§‹åŒ–UI
        function initializeUI() {
            // åˆå§‹åŒ–æ‚£è€…é€‰æ‹©å™¨
            const patientSelector = document.getElementById('patientSelector');

            // æ·»åŠ å…¨é€‰æŒ‰é’®
            const selectAllPatientsBtn = document.createElement('button');
            selectAllPatientsBtn.className = 'select-all-patients-btn';
            selectAllPatientsBtn.textContent = 'âœ“ å…¨é€‰æ‚£è€…';
            selectAllPatientsBtn.onclick = selectAllPatients;
            patientSelector.appendChild(selectAllPatientsBtn);

            comparisonData.patients.forEach(patient => {
                const label = document.createElement('label');
                label.className = 'patient-checkbox';
                label.innerHTML = `
                    <input type="checkbox" value="${patient}" onchange="togglePatient('${patient}', this.checked)">
                    <span>${patient}</span>
                `;
                patientSelector.appendChild(label);
            });

            // åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©å™¨
            const modelSelector = document.getElementById('modelSelector');

            // æ·»åŠ å…¨é€‰æ¨¡å‹æŒ‰é’®
            const selectAllModelsBtn = document.createElement('label');
            selectAllModelsBtn.className = 'model-checkbox';
            selectAllModelsBtn.style.cssText = 'cursor: pointer; background: #667eea; color: white; border-color: #667eea; font-weight: 600;';
            selectAllModelsBtn.innerHTML = `
                <input type="button" value="å…¨é€‰" onclick="selectAllModels()" style="display: none;">
                <span onclick="selectAllModels()">âœ“ å…¨é€‰æ¨¡å‹</span>
            `;
            modelSelector.appendChild(selectAllModelsBtn);

            comparisonData.models.forEach(model => {
                const label = document.createElement('label');
                label.className = 'model-checkbox';
                label.innerHTML = `
                    <input type="checkbox" value="${model}" onchange="toggleModel('${model}', this.checked)">
                    <span>${model}</span>
                `;
                modelSelector.appendChild(label);
            });

            // é»˜è®¤å…¨é€‰æ‰€æœ‰æ‚£è€…
            if (comparisonData.patients.length > 0) {
                comparisonData.patients.forEach(patient => {
                    selectedPatients.add(patient);
                });

                // æ›´æ–°UI
                document.querySelectorAll('.patient-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input');
                    if (checkbox) {
                        checkbox.checked = true;
                        label.classList.add('selected');
                    }
                });

                // æ›´æ–°å…¨é€‰æŒ‰é’®æ–‡å­—
                const patientBtn = document.querySelector('.select-all-patients-btn');
                if (patientBtn) patientBtn.textContent = 'âœ— å–æ¶ˆå…¨é€‰';
            }

            // é»˜è®¤å…¨é€‰æ‰€æœ‰æ¨¡å‹
            if (comparisonData.models.length > 0) {
                comparisonData.models.forEach(model => {
                    selectedModels.add(model);
                });

                // æ›´æ–°UI
                document.querySelectorAll('.model-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = true;
                        label.classList.add('selected');
                    }
                });

                // æ›´æ–°å…¨é€‰æŒ‰é’®æ–‡å­—
                const modelBtn = document.querySelector('.model-checkbox span[onclick="selectAllModels()"]');
                if (modelBtn) modelBtn.textContent = 'âœ— å–æ¶ˆå…¨é€‰';
            }

            updateConvTypeSelector();
            updateComparison();
            updateStats();
        }

        // åˆ‡æ¢æ‚£è€…é€‰æ‹©
        function togglePatient(patient, checked) {
            if (checked) {
                selectedPatients.add(patient);
            } else {
                selectedPatients.delete(patient);
            }

            // æ›´æ–°checkboxçŠ¶æ€
            document.querySelectorAll('.patient-checkbox').forEach(label => {
                const checkbox = label.querySelector('input');
                label.classList.toggle('selected', checkbox.checked);
            });

            // æ›´æ–°å¯¹è¯ç±»å‹é€‰æ‹©å™¨
            updateConvTypeSelector();

            // æ›´æ–°æ˜¾ç¤º
            updateComparison();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰æ‚£è€…
        function selectAllPatients() {
            const allSelected = selectedPatients.size === comparisonData.patients.length;

            if (allSelected) {
                // å–æ¶ˆå…¨é€‰
                selectedPatients.clear();

                // æ›´æ–°UI
                document.querySelectorAll('.patient-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input');
                    checkbox.checked = false;
                    label.classList.remove('selected');
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.select-all-patients-btn');
                btn.textContent = 'âœ“ å…¨é€‰æ‚£è€…';
            } else {
                // å…¨é€‰
                selectedPatients.clear();
                comparisonData.patients.forEach(patient => {
                    selectedPatients.add(patient);
                });

                // æ›´æ–°UI
                document.querySelectorAll('.patient-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input');
                    checkbox.checked = true;
                    label.classList.add('selected');
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.select-all-patients-btn');
                btn.textContent = 'âœ— å–æ¶ˆå…¨é€‰';
            }

            updateConvTypeSelector();
            updateComparison();
        }

        // æ›´æ–°å¯¹è¯ç±»å‹é€‰æ‹©å™¨
        function updateConvTypeSelector() {
            const convTypeSelector = document.getElementById('convTypeSelector');
            convTypeSelector.innerHTML = '';

            if (selectedPatients.size === 0) return;

            // æ”¶é›†æ‰€æœ‰é€‰ä¸­æ‚£è€…çš„å¯¹è¯ç±»å‹ï¼ˆå–äº¤é›†ï¼‰å¹¶è¿‡æ»¤æ‰"åŒ»ç–—æ€»ç»“"
            const convTypes = {};
            let isFirst = true;

            selectedPatients.forEach(patient => {
                const patientData = comparisonData.data[patient];
                if (!patientData) return;

                if (isFirst) {
                    // ç¬¬ä¸€ä¸ªæ‚£è€…ï¼Œåˆå§‹åŒ–å¯¹è¯ç±»å‹
                    Object.entries(patientData).forEach(([convId, models]) => {
                        Object.values(models).forEach(data => {
                            // è¿‡æ»¤æ‰åŒ…å«"åŒ»ç–—æ€»ç»“"çš„å¯¹è¯ç±»å‹
                            if (data.title && !data.title.includes('åŒ»ç–—æ€»ç»“')) {
                                convTypes[convId] = data.title;
                            }
                        });
                    });
                    isFirst = false;
                }
            });

            // æ·»åŠ å…¨é€‰æŒ‰é’®
            const selectAllBtn = document.createElement('button');
            selectAllBtn.className = 'select-all-btn';
            const allConvTypeIds = Object.keys(convTypes);
            const allSelected = allConvTypeIds.every(convId => selectedConvTypes.has(convId));
            selectAllBtn.textContent = allSelected ? 'âœ— å–æ¶ˆå…¨é€‰' : 'âœ“ å…¨é€‰ç±»å‹';
            selectAllBtn.onclick = () => selectAllConvTypes(convTypes);
            convTypeSelector.appendChild(selectAllBtn);

            // åˆ›å»ºå¯¹è¯ç±»å‹å¤é€‰æ¡†
            Object.entries(convTypes).forEach(([convId, title]) => {
                const label = document.createElement('label');
                label.className = 'conv-type-checkbox';

                const isChecked = selectedConvTypes.has(convId);
                label.innerHTML = `
                    <input type="checkbox" value="${convId}" ${isChecked ? 'checked' : ''} onchange="toggleConvType('${convId}', this.checked)">
                    <span>${title}</span>
                `;

                if (isChecked) {
                    label.classList.add('selected');
                }

                convTypeSelector.appendChild(label);
            });

            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„å¯¹è¯ç±»å‹ï¼Œé»˜è®¤å…¨é€‰æ‰€æœ‰ç±»å‹
            if (selectedConvTypes.size === 0 && Object.keys(convTypes).length > 0) {
                Object.keys(convTypes).forEach(convId => {
                    selectedConvTypes.add(convId);
                });

                // æ›´æ–°UI
                document.querySelectorAll('.conv-type-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input');
                    if (checkbox) {
                        checkbox.checked = true;
                        label.classList.add('selected');
                    }
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.select-all-btn');
                if (btn) btn.textContent = 'âœ— å–æ¶ˆå…¨é€‰';
            }
        }

        // åˆ‡æ¢å¯¹è¯ç±»å‹
        function toggleConvType(convId, checked) {
            if (checked) {
                selectedConvTypes.add(convId);
            } else {
                selectedConvTypes.delete(convId);
            }

            // æ›´æ–°checkboxçŠ¶æ€
            document.querySelectorAll('.conv-type-checkbox').forEach(label => {
                const checkbox = label.querySelector('input');
                label.classList.toggle('selected', checkbox.checked);
            });

            updateComparison();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰å¯¹è¯ç±»å‹
        function selectAllConvTypes(convTypes) {
            const allConvTypeIds = Object.keys(convTypes);
            const allSelected = allConvTypeIds.every(convId => selectedConvTypes.has(convId));

            if (allSelected) {
                // å–æ¶ˆå…¨é€‰
                selectedConvTypes.clear();

                // æ›´æ–°UI
                document.querySelectorAll('.conv-type-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input');
                    checkbox.checked = false;
                    label.classList.remove('selected');
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.select-all-btn');
                btn.textContent = 'âœ“ å…¨é€‰ç±»å‹';
            } else {
                // å…¨é€‰
                selectedConvTypes.clear();
                allConvTypeIds.forEach(convId => {
                    selectedConvTypes.add(convId);
                });

                // æ›´æ–°UI
                document.querySelectorAll('.conv-type-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input');
                    checkbox.checked = true;
                    label.classList.add('selected');
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.select-all-btn');
                btn.textContent = 'âœ— å–æ¶ˆå…¨é€‰';
            }

            updateComparison();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰æ¨¡å‹
        function selectAllModels() {
            const allSelected = selectedModels.size === comparisonData.models.length;

            if (allSelected) {
                // å–æ¶ˆå…¨é€‰
                selectedModels.clear();

                // æ›´æ–°UI
                document.querySelectorAll('.model-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = false;
                        label.classList.remove('selected');
                    }
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.model-checkbox span[onclick="selectAllModels()"]');
                if (btn) btn.textContent = 'âœ“ å…¨é€‰æ¨¡å‹';
            } else {
                // å…¨é€‰
                selectedModels.clear();
                comparisonData.models.forEach(model => {
                    selectedModels.add(model);
                });

                // æ›´æ–°UI
                document.querySelectorAll('.model-checkbox').forEach(label => {
                    const checkbox = label.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = true;
                        label.classList.add('selected');
                    }
                });

                // æ›´æ–°æŒ‰é’®æ–‡å­—
                const btn = document.querySelector('.model-checkbox span[onclick="selectAllModels()"]');
                if (btn) btn.textContent = 'âœ— å–æ¶ˆå…¨é€‰';
            }

            updateComparison();
        }

        // åˆ‡æ¢æ¨¡å‹é€‰æ‹©
        function toggleModel(model, checked) {
            if (checked) {
                selectedModels.add(model);
            } else {
                selectedModels.delete(model);
            }

            // æ›´æ–°checkboxçŠ¶æ€
            document.querySelectorAll('.model-checkbox').forEach(label => {
                const checkbox = label.querySelector('input');
                label.classList.toggle('selected', checkbox.checked);
            });

            updateComparison();
        }

        // æ›´æ–°å¯¹æ¯”æ˜¾ç¤º
        function updateComparison() {
            const comparisonArea = document.getElementById('comparisonArea');

            if (selectedPatients.size === 0 || selectedConvTypes.size === 0 || selectedModels.size === 0) {
                comparisonArea.innerHTML = '<div class="no-data">ğŸ‘† è¯·é€‰æ‹©æ‚£è€…ã€æ¨¡å‹å’Œå¯¹è¯ç±»å‹</div>';
                return;
            }

            comparisonArea.innerHTML = '';

            // ä¸ºæ¯ä¸ªé€‰ä¸­çš„æ‚£è€…åˆ›å»ºåŒºå—
            selectedPatients.forEach(patient => {
                const patientData = comparisonData.data[patient];
                if (!patientData) return;

                // åˆ›å»ºæ‚£è€…åˆ†ç»„æ ‡é¢˜
                const patientTitle = document.createElement('h1');
                patientTitle.style.cssText = 'font-size: 24px; margin: 40px 0 25px 0; color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px; font-weight: 700;';
                patientTitle.textContent = `ğŸ“‹ ${patient}`;
                comparisonArea.appendChild(patientTitle);

                // åˆ›å»ºæ¨¡å‹å¡ç‰‡ç½‘æ ¼ï¼ˆæ‰€æœ‰å¯¹è¯ç±»å‹åˆå¹¶åœ¨ä¸€èµ·ï¼‰
                const grid = document.createElement('div');
                grid.className = 'comparison-grid';
                if (currentLayout === 'horizontal') {
                    grid.classList.add('horizontal-layout');
                }

                // æŒ‰ç…§æ¨¡å‹é€‰æ‹©çš„é¡ºåºåˆ›å»ºå¡ç‰‡
                const sortedModels = Array.from(selectedModels).sort();
                sortedModels.forEach(model => {
                    // æ”¶é›†è¯¥æ¨¡å‹åœ¨æ‰€æœ‰é€‰ä¸­å¯¹è¯ç±»å‹ä¸­çš„æ•°æ®
                    const modelConvData = [];
                    selectedConvTypes.forEach(convId => {
                        const convData = patientData[convId];
                        if (convData && convData[model]) {
                            modelConvData.push({
                                convId: convId,
                                data: convData[model]
                            });
                        }
                    });

                    // å¦‚æœè¯¥æ¨¡å‹åœ¨è‡³å°‘ä¸€ä¸ªå¯¹è¯ç±»å‹ä¸­æœ‰æ•°æ®ï¼Œåˆ›å»ºåˆå¹¶çš„å¡ç‰‡
                    if (modelConvData.length > 0) {
                        const card = createMergedModelCard(model, modelConvData, patient);
                        grid.appendChild(card);
                    }
                });

                comparisonArea.appendChild(grid);
            });
        }


        // åˆ›å»ºåˆå¹¶å¤šä¸ªå¯¹è¯ç±»å‹çš„æ¨¡å‹å¡ç‰‡
        function createMergedModelCard(model, modelConvData, patient) {
            const card = document.createElement('div');
            card.className = 'model-card';

            const header = document.createElement('div');
            header.className = 'model-card-header';
            header.textContent = model;

            // åº”ç”¨æ¨¡å‹ç‰¹å®šçš„é¢œè‰²
            const colors = getModelColor(model);
            header.style.background = `linear-gradient(135deg, ${colors.start} 0%, ${colors.end} 100%)`;

            // åˆ›å»ºæ‚£è€…ä¿¡æ¯æ¡
            const patientInfoBar = document.createElement('div');
            patientInfoBar.className = 'patient-info-bar';
            patientInfoBar.innerHTML = `
                <span class="patient-icon">ğŸ‘¤</span>
                <span>æ‚£è€…ï¼š</span>
                <span class="patient-name">${patient}</span>
            `;

            const body = document.createElement('div');
            body.className = 'model-card-body';

            // åˆå¹¶æ‰€æœ‰å¯¹è¯ç±»å‹çš„å†…å®¹
            let mergedContent = '';
            modelConvData.forEach((convItem, index) => {
                // å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªå¯¹è¯ç±»å‹ï¼Œæ·»åŠ åˆ†éš”çº¿
                if (index > 0) {
                    mergedContent += '<div style="border-top: 2px solid #e0e0e0; margin: 20px 0;"></div>';
                }

                // æ·»åŠ å¯¹è¯ç±»å‹æ ‡é¢˜
                const convTitle = convItem.data.title || `å¯¹è¯ ${convItem.convId}`;
                mergedContent += `<h3 style="color: #667eea; font-size: 16px; margin: 15px 0 10px 0; font-weight: 600;">${convTitle}</h3>`;

                // æ ¼å¼åŒ–å¹¶æ·»åŠ è¾“å‡ºå†…å®¹
                const formattedOutput = formatOutput(convItem.data.output);
                mergedContent += formattedOutput;
            });

            body.innerHTML = mergedContent;

            card.appendChild(header);
            card.appendChild(patientInfoBar);
            card.appendChild(body);

            return card;
        }

        // åˆ›å»ºæ¨¡å‹å¡ç‰‡ï¼ˆä¿ç•™ç”¨äºå‘åå…¼å®¹ï¼‰
        function createModelCard(model, data, patient) {
            const card = document.createElement('div');
            card.className = 'model-card';

            const header = document.createElement('div');
            header.className = 'model-card-header';
            header.textContent = model;

            // åº”ç”¨æ¨¡å‹ç‰¹å®šçš„é¢œè‰²
            const colors = getModelColor(model);
            header.style.background = `linear-gradient(135deg, ${colors.start} 0%, ${colors.end} 100%)`;

            const body = document.createElement('div');
            body.className = 'model-card-body';

            // æ ¼å¼åŒ–è¾“å‡ºå†…å®¹
            const formattedOutput = formatOutput(data.output);
            body.innerHTML = formattedOutput;

            card.appendChild(header);
            card.appendChild(body);

            return card;
        }

        // æ ¼å¼åŒ–è¾“å‡ºå†…å®¹
        function formatOutput(text) {
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br>
            let formatted = text.replace(/\n/g, '<br>');

            // åŠ ç²—æ ‡é¢˜
            formatted = formatted.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^\*\*(.+?)\*\*:/gm, '<strong>$1:</strong>');

            // åˆ—è¡¨é¡¹
            formatted = formatted.replace(/^- (.+)$/gm, 'â€¢ $1');
            formatted = formatted.replace(/^\* (.+)$/gm, 'â€¢ $1');

            return formatted;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${comparisonData.models.length}</div>
                    <div class="stat-label">æ¨¡å‹æ€»æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${comparisonData.patients.length}</div>
                    <div class="stat-label">æ‚£è€…æ•°é‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${selectedModels.size}</div>
                    <div class="stat-label">å·²é€‰æ¨¡å‹</div>
                </div>
            `;
        }

        // åˆ‡æ¢å¸ƒå±€æ–¹å¼
        function changeLayout(layout) {
            currentLayout = layout;

            // æ›´æ–°å•é€‰æ¡†æ ·å¼
            document.querySelectorAll('.layout-radio').forEach(label => {
                const radio = label.querySelector('input');
                if (radio.checked) {
                    label.style.borderColor = '#667eea';
                    label.style.background = '#f0f4ff';
                } else {
                    label.style.borderColor = '#e0e0e0';
                    label.style.background = 'white';
                }
            });

            // é‡æ–°æ¸²æŸ“å¯¹æ¯”åŒºåŸŸ
            updateComparison();
        }

        // æ‰“å¼€ä¾§è¾¹æ å¯¹è¯é¢æ¿
        function openChatSidebar() {
            if (selectedPatients.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©æ‚£è€…');
                return;
            }

            // åªæ”¯æŒå•ä¸ªæ‚£è€…æŸ¥çœ‹å¯¹è¯
            const patient = Array.from(selectedPatients)[0];
            const patientData = comparisonData.data[patient];

            if (!patientData) return;

            // æ›´æ–°ä¾§è¾¹æ æ ‡é¢˜
            document.getElementById('chatSidebarPatient').textContent = `${patient} - å¯¹è¯è®°å½•`;

            // åˆ›å»ºå¯¹è¯ç±»å‹æ ‡ç­¾
            const tabsContainer = document.getElementById('chatTypeTabs');
            tabsContainer.innerHTML = '';

            const convTypes = {};
            Object.entries(patientData).forEach(([convId, models]) => {
                Object.values(models).forEach(data => {
                    // è¿‡æ»¤æ‰åŒ…å«"åŒ»ç–—æ€»ç»“"çš„å¯¹è¯ç±»å‹
                    if (data.title && data.chat && !data.title.includes('åŒ»ç–—æ€»ç»“')) {
                        convTypes[convId] = {
                            title: data.title,
                            chat: data.chat
                        };
                    }
                });
            });

            // åˆ›å»ºæ ‡ç­¾æŒ‰é’®
            Object.entries(convTypes).forEach(([convId, data], index) => {
                const tab = document.createElement('div');
                tab.className = 'chat-type-tab' + (index === 0 ? ' active' : '');
                tab.textContent = data.title;
                tab.onclick = () => selectChatType(convTypes, convId);
                tabsContainer.appendChild(tab);
            });

            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªå¯¹è¯
            const firstConvId = Object.keys(convTypes)[0];
            if (firstConvId) {
                displayChat(convTypes[firstConvId].chat);
            }

            // æ˜¾ç¤ºä¾§è¾¹æ 
            document.getElementById('chatSidebar').classList.add('open');
            document.getElementById('chatOverlay').classList.add('show');
        }

        // å…³é—­ä¾§è¾¹æ å¯¹è¯é¢æ¿
        function closeChatSidebar() {
            document.getElementById('chatSidebar').classList.remove('open');
            document.getElementById('chatOverlay').classList.remove('show');
        }

        // é€‰æ‹©å¯¹è¯ç±»å‹
        function selectChatType(convTypes, convId) {
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.chat-type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // æ˜¾ç¤ºå¯¹è¯å†…å®¹
            displayChat(convTypes[convId].chat);
        }

        // æ˜¾ç¤ºå¯¹è¯å†…å®¹
        function displayChat(chatContent) {
            const displayArea = document.getElementById('chatDisplayArea');
            if (!chatContent) {
                displayArea.innerHTML = '<div class="no-chat-message">æš‚æ— å¯¹è¯è®°å½•</div>';
                return;
            }

            // è§£æå¯¹è¯å†…å®¹
            const messages = parseChatContent(chatContent);

            // æ¸²æŸ“èŠå¤©æ°”æ³¡
            let html = '';
            messages.forEach(msg => {
                if (msg.type === 'section') {
                    html += `<div class="chat-section-title">${msg.content}</div>`;
                } else if (msg.type === 'patient-info') {
                    // æ¸²æŸ“æ‚£è€…ä¿¡æ¯å¡ç‰‡
                    html += '<div class="patient-info-card"><h4>ğŸ‘¤ æ‚£è€…åŸºæœ¬ä¿¡æ¯</h4><div class="patient-info-grid">';
                    for (const [key, value] of Object.entries(msg.data)) {
                        html += `<div class="patient-info-item"><strong>${key}:</strong> ${value}</div>`;
                    }
                    html += '</div></div>';
                } else {
                    const role = msg.role === 'patient' ? 'patient' : 'doctor';
                    const avatar = msg.role === 'patient' ? 'ğŸ‘¤' : 'ğŸ‘¨â€âš•ï¸';
                    const roleName = msg.role === 'patient' ? 'æ‚£è€…' : 'åŒ»åŠ©';

                    html += `
                        <div class="chat-message ${role}">
                            <div class="chat-message-header">
                                <div class="chat-avatar">${avatar}</div>
                                <div class="chat-role">${roleName}</div>
                            </div>
                            <div class="chat-bubble">${escapeHtml(msg.content)}</div>
                        </div>
                    `;
                }
            });

            displayArea.innerHTML = html;

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            displayArea.scrollTop = 0;
        }

        // è§£æå¯¹è¯å†…å®¹
        function parseChatContent(content) {
            const messages = [];
            const lines = content.split('\n');

            let inDialogSection = false;
            let inBasicInfo = false;
            let currentMessage = null;
            let patientInfo = {};

            for (let line of lines) {
                line = line.trim();

                // è·³è¿‡åˆ†éš”çº¿å’Œç©ºè¡Œ
                if (line.startsWith('====') || line.startsWith('----') || line === '') {
                    continue;
                }

                // æ£€æµ‹ç« èŠ‚æ ‡é¢˜
                if (line.includes('æ‚£è€…åŸºæœ¬ä¿¡æ¯')) {
                    if (currentMessage) {
                        messages.push(currentMessage);
                        currentMessage = null;
                    }
                    inBasicInfo = true;
                    inDialogSection = false;
                    continue;
                }

                if (line.includes('é¢„é—®è¯Šå¯¹è¯è®°å½•')) {
                    if (currentMessage) {
                        messages.push(currentMessage);
                        currentMessage = null;
                    }
                    // æ·»åŠ æ‚£è€…ä¿¡æ¯å¡ç‰‡
                    if (Object.keys(patientInfo).length > 0) {
                        messages.push({ type: 'patient-info', data: patientInfo });
                    }
                    messages.push({ type: 'section', content: 'é¢„é—®è¯Šå¯¹è¯è®°å½•' });
                    inBasicInfo = false;
                    inDialogSection = true;
                    continue;
                }

                // æ”¶é›†åŸºæœ¬ä¿¡æ¯
                if (inBasicInfo) {
                    const infoMatch = line.match(/^(.+?)[:ï¼š]\s*(.+)$/);
                    if (infoMatch) {
                        const key = infoMatch[1].trim();
                        const value = infoMatch[2].trim();
                        patientInfo[key] = value;
                    }
                    continue;
                }

                // è§£æå¯¹è¯è¡Œ
                const patientMatch = line.match(/^\d+\.\s*æ‚£è€…:\s*(.+)$/);
                const doctorMatch = line.match(/^\d+\.\s*åŒ»åŠ©:\s*(.+)$/);

                if (patientMatch) {
                    if (currentMessage) {
                        messages.push(currentMessage);
                    }
                    currentMessage = {
                        type: 'message',
                        role: 'patient',
                        content: patientMatch[1].trim()
                    };
                } else if (doctorMatch) {
                    if (currentMessage) {
                        messages.push(currentMessage);
                    }
                    currentMessage = {
                        type: 'message',
                        role: 'doctor',
                        content: doctorMatch[1].trim()
                    };
                } else if (currentMessage && line) {
                    // ç»§ç»­å½“å‰æ¶ˆæ¯çš„å†…å®¹ï¼ˆå¤šè¡Œï¼‰
                    currentMessage.content += '\n' + line;
                }
            }

            // æ·»åŠ æœ€åä¸€æ¡æ¶ˆæ¯
            if (currentMessage) {
                messages.push(currentMessage);
            }

            return messages;
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // æ›´æ–°æŸ¥çœ‹å¯¹è¯æŒ‰é’®çŠ¶æ€
        function updateChatViewerButton() {
            const btn = document.getElementById('chatViewerBtn');
            if (selectedPatients.size === 1) {
                btn.classList.remove('disabled');
            } else {
                btn.classList.add('disabled');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        loadData();

        // ç›‘å¬æ¨¡å‹é€‰æ‹©å˜åŒ–ä»¥æ›´æ–°ç»Ÿè®¡
        setInterval(updateStats, 100);
    </script>
</body>
</html>
