"""
简单聊天脚本
可以自定义 system_prompt 和 user_prompt
"""
from chat_client import ChatClient
import sys


def chat(system_prompt: str, user_prompt: str, stream: bool = True):
    """
    简单的聊天函数

    Args:
        system_prompt: 系统提示词，定义 AI 的角色和行为
        user_prompt: 用户问题或指令
        stream: 是否使用流式输出（默认 True）
    """
    # 创建客户端
    client = ChatClient(system_prompt=system_prompt)

    print(f"\n{'='*60}")
    print(f"System Prompt: {system_prompt}")
    print(f"{'='*60}")
    print(f"\n用户: {user_prompt}")
    print(f"\n助手: ", end="", flush=True)

    if stream:
        # 流式输出
        # gpt-5.1 模型需要 temperature=1, top_p=1
        for chunk in client.chat(
            message=user_prompt,
            stream=True,
            temperature=1.0,
            frequency_penalty=0.0,
            presence_penalty=0.0
        ):
            print(chunk, end="", flush=True)
        print("\n")
    else:
        # 非流式输出
        # gpt-5.1 模型需要 temperature=1, top_p=1
        response = client.chat(
            message=user_prompt,
            stream=False,
            temperature=1.0,
            frequency_penalty=0.0,
            presence_penalty=0.0
        )
        print(response)
        print()


# def main():
#     """主函数"""
#     print("\n" + "="*60)
#     print("简单聊天脚本")
#     print("="*60)

#     # 获取 system_prompt
#     print("\n请输入 System Prompt (系统提示词):")
#     print("(例如: 你是一个专业的Python编程助手)")
#     system_prompt = input("> ").strip()

#     if not system_prompt:
#         system_prompt = "你是一个友好的AI助手。"
#         print(f"使用默认: {system_prompt}")

#     # 获取 user_prompt
#     print("\n请输入 User Prompt (用户问题):")
#     print("(例如: 如何学习Python?)")
#     user_prompt = input("> ").strip()

#     if not user_prompt:
#         print("错误: 用户问题不能为空！")
#         sys.exit(1)

#     # 询问是否流式输出
#     print("\n是否使用流式输出? (y/n, 默认 y):")
#     use_stream = input("> ").strip().lower()
#     stream = use_stream != 'n'

#     # 执行聊天
#     chat(system_prompt, user_prompt, stream)


# if __name__ == "__main__":
#     try:
#         main()
#     except KeyboardInterrupt:
#         print("\n\n程序已取消")
#         sys.exit(0)
#     except Exception as e:
#         print(f"\n错误: {e}")
#         sys.exit(1)


# 获取 system_prompt


system_prompt = """#角色：\n你是一个糖尿病的主任医师，你的任务是总结医生助手与患者的对话，生成病历主诉。\n以下病历主诉的医学表达风格特点，并附有推荐书写模板和标准示例，供参考。\n\n#限制：\n只生成主诉信息，不要生成其他信息，不要废话，不要输出思考内容。\n主诉指的是：患者就诊时最主要、最核心的、与糖尿病直接相关的不适症状（或异常表现）及持续时间。\n主诉指的是：患者就诊时最主要、最核心的、与糖尿病直接相关的不适症状（或异常表现）及持续时间。\n主诉指的是：患者就诊时最主要、最核心的、与糖尿病直接相关的不适症状（或异常表现）及持续时间。 \n# 一、医学表达风格特点\n\n### 1. 简洁明了，突出主要症状或发现\n\n* 只写最核心、最能代表疾病特征的症状或检验发现。\n* 避免赘述，无主观感受或无关描述。\n\n### 2. 时间单位明确，主次分明\n\n* 症状或发现后紧跟持续时间（\\\"X天/月/年\\\"），重点突出持续或起病时长。\n* 多症状时，时间紧随每一症状或用逗号分隔并按顺序写明。\n\n### 3. 医学术语规范\n\n* 用\\\"口干、多饮、多尿、体重减轻、头晕乏力、腰腿疼痛、血糖升高\\\"等标准医学表达。\n* 用\\\"发现血糖升高\\\"\\\"体重下降\\\"\\\"控制不佳\\\"等固定表述描述检验发现或病情控制情况。\n\n### 4. 并列结构，条理清晰\n\n* 并列症状之间用顿号\\\"、\\\"分隔。\n* 不叙述发病经过，只罗列现有症状或检验结果。\n\n### 5. 避免主观词汇与评价性描述\n\n* 不使用\\\"自觉\\\"\\\"严重\\\"\\\"明显\\\"等主观描述。\n\n---\n\n# 二、推荐主诉书写模板\n\n1. [症状/发现] + [持续时间]\n\n   * 口干、多饮、多尿X月/年\n   * 发现血糖升高X年/余年/天\n\n2. [多症状/多发现] + [各自持续时间]\n\n   * 口干、多饮、多尿X月，体重减轻X月\n   * 发现血糖升高X年，右下腹胀痛X月\n\n3. [并列发现] + [分别持续时间]\n\n   * 发现血糖升高X年，控制不佳X年\n   * 腰腿部疼痛不适X年，发现骨质疏松X天\n\n---\n\n# 三、标准化主诉书写示例\n\n* 口干、多饮、多尿\n* 发现血糖升高15年，右下腹胀痛1月\n* 血糖升高10年\n* 发现血糖升高20年\n* 口干多饮、多尿1月\n* 发现血糖升高15年\n* 口干、多饮20年，头晕乏力2日\n* 腰腿部疼痛不适2年，发现骨质疏松1天\n* 血糖升高4天\n* 口干多饮、多尿2月\n* 发现血糖升高8年\n* 发现血糖升高12年\n* 发现血糖升高24年\n* 发现血糖升高25年，控制不佳1年\n* 口干、多饮、多尿\n* 发现血糖升高2余年\n* 发现血糖升高10余年\n\n---\n\n# 四、写作建议\n\n* 只写首因/核心问题，如血糖、症状等，不必列出全部不适。\n* 先写最突出的症状，再写伴随症状，时间按实际情况排序。\n* 建议采用顿号（\\\"、\\\"）分隔同一时间或同一类型的多种症状，逗号分隔不同类型症状或有不同起始时间的症状。\n\n请根据对话内容生成标准的主诉。"""

user_prompt = """预问诊问答
============================================================

患者基本信息：
姓名：患者1
年龄：50-55岁
性别：男
身高：182.0cm
体重：64.0kg
BMI：19.3


预问诊对话记录：
----------------------------------------
1. 患者: 您好 我叫 患者1，性别 男, 年龄段 50-55, BMI指数 19.3

2. 医助: 先生您好，我是糖尿病专病医助。请问您今天主要是因为什么症状来就诊的呢？

3. 患者: 配药

4. 医助: 好的，先生。请问您是已经确诊糖尿病了吗？需要配什么药呢？

5. 患者: 二甲双胍，司美格鲁肽

6. 医助: 明白了，先生。请问您的糖尿病确诊多长时间了？

7. 患者: 确诊十二年以上

8. 医助: 好的，先生。您糖尿病病程已经12年以上了，请问您最初是怎么发现糖尿病的呢？是通过体检发现的，还是因为有什么不舒服的症状去检查发现的？

9. 患者: 自己发现，去医院检查发现

10. 医助: 请问您当时是因为什么症状自己发现不对劲的呢？比如有没有出现多喝水、多吃、多上厕所或者体重减轻这些情况？

11. 患者: 小便泡沫多，妈妈舅舅有糖尿病

12. 医助: 明白了。请问您现在除了二甲双胍和司美格鲁肽，还有在用其他的降糖药物或者胰岛素吗？这两种药您是怎么服用的？

13. 患者: 胰岛素最近没打。格列齐特

14. 医助: 好的，先生。请问您现在的用药情况是：二甲双胍、司美格鲁肽和格列齐特，这三种药您分别是怎么服用的？比如每天吃几次，每次吃多少？

15. 患者: 二甲双胍早晚各一粒，司美格鲁肽一个星期打一次，格列齐特早上两粒，多格列艾汀片早晚各一粒

16. 医助: 好的，了解了您目前的用药情况。请问您平时测血糖吗？最近的空腹血糖和餐后血糖大概是多少？

17. 患者: 空腹11

18. 医助: 空腹血糖11确实偏高了。请问您有测过餐后2小时血糖吗？大概是多少？

19. 患者: 没测过

20. 医助: 好的。请问您最近体重有没有明显的变化？比如在多长时间内增加或减轻了多少斤？

21. 患者: 最近没有。五个月前来住院，后续两个月掉了十几斤

22. 医助: 您说五个月前住院后的两个月内掉了十几斤，这个体重下降幅度比较明显。请问您当时住院是因为什么原因呢？

23. 患者: 血糖不稳定

24. 医助: 明白了。请问您现在有没有手麻、脚麻的情况？或者有没有视物模糊？还有小便有没有泡沫的情况？

25. 患者: 小便有泡沫

26. 医助: 您提到小便有泡沫，这个情况持续多长时间了？泡沫多吗？是每次小便都有还是偶尔有？

27. 患者: 一直有 泡沫一般

28. 医助: 好的，了解了。请问您除了糖尿病之外，还有没有其他疾病？比如高血压、血脂异常、冠心病、脑血管疾病、肾脏病、甲亢等？

29. 患者: 甘油三酯高

30. 医助: 请问您的甘油三酯高是什么时候发现的？现在有在吃降血脂的药物吗？如果有的话，吃的是什么药，怎么服用的？

31. 患者: 现在没有吃降血脂的药物

32. 医助: 好的。除了甘油三酯高和糖尿病，您还有没有其他疾病？比如高血压、冠心病、脑血管疾病、肾脏病、甲亢、胰腺炎等？

33. 患者: 没有

34. 医助: 好的。您刚才提到妈妈和舅舅有糖尿病，请问家族中还有其他人患糖尿病吗？

35. 患者: 哥哥

36. 医助: 明白了，您的妈妈、舅舅和哥哥都有糖尿病。感谢您信任并提供这些宝贵信息，它们将帮助医生更全面地关心您的健康。接下来医生会根据您的情况，和您进行更深入的交流，请您稍候。
"""

# 询问是否流式输出
use_stream = False
# 执行聊天
chat(system_prompt, user_prompt, use_stream)
