<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç–—æ¨¡å‹è¯„æµ‹ - å¯¹è¯è§†å›¾</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-height: 80px;
            position: relative;
        }

        .home-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .home-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) translateX(-2px);
        }

        .patient-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .patient-selector-label {
            font-size: 16px;
            font-weight: 600;
        }

        .patient-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .patient-tab {
            padding: 8px 20px;
            font-size: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            white-space: nowrap;
        }

        .patient-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .patient-tab.active {
            background: white;
            color: #667eea;
            border-color: white;
            font-weight: 600;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 80px);
            gap: 0;
        }

        /* å·¦ä¾§å¯¹è¯åŒºåŸŸ */
        .chat-panel {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
        }

        .chat-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .chat-header h2 {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f0f2f5;
        }

        .chat-content::-webkit-scrollbar {
            width: 8px;
        }

        .chat-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-content::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        .chat-content::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        /* èŠå¤©æ°”æ³¡æ ·å¼ */
        .chat-message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .chat-message.patient {
            align-items: flex-start;
        }

        .chat-message.doctor {
            align-items: flex-end;
        }

        .chat-message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px;
            color: #666;
        }

        .chat-message.patient .chat-message-header {
            flex-direction: row;
        }

        .chat-message.doctor .chat-message-header {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .chat-message.patient .chat-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .chat-message.doctor .chat-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .chat-role {
            font-weight: 600;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 14px;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .chat-message.patient .chat-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .chat-message.doctor .chat-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .patient-info-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .patient-info-card h4 {
            color: #667eea;
            font-size: 14px;
            margin: 0 0 12px 0;
            font-weight: 600;
        }

        .patient-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .patient-info-item {
            font-size: 13px;
            color: #666;
        }

        .patient-info-item strong {
            color: #333;
            font-weight: 600;
        }

        .chat-section-title {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin: 30px 0 20px 0;
            position: relative;
        }

        .chat-section-title::before,
        .chat-section-title::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 35%;
            height: 1px;
            background: #e0e0e0;
        }

        .chat-section-title::before {
            left: 0;
        }

        .chat-section-title::after {
            right: 0;
        }

        /* å³ä¾§æŠ¥å‘ŠåŒºåŸŸ */
        .report-panel {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .report-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-title {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .report-title h2 {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }

        .model-name {
            font-size: 13px;
            color: #999;
            font-weight: 500;
        }

        .model-name.hidden {
            display: none;
        }

        .model-navigator {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #667eea;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .nav-button:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .nav-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: scale(1);
        }

        .model-indicator {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .report-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .report-content::-webkit-scrollbar {
            width: 8px;
        }

        .report-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .report-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .report-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .report-section {
            margin-bottom: 30px;
        }

        .report-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .report-section-content {
            font-size: 14px;
            line-height: 1.9;
            color: #333;
        }

        .report-section-content p {
            margin-bottom: 12px;
        }

        .report-section-content strong {
            color: #667eea;
            font-weight: 600;
        }

        .report-section-content ul,
        .report-section-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .report-section-content li {
            margin-bottom: 8px;
            line-height: 1.7;
        }

        .report-section-content h3 {
            font-size: 15px;
            font-weight: 600;
            color: #764ba2;
            margin: 18px 0 10px 0;
            padding-left: 12px;
            border-left: 3px solid #764ba2;
        }

        .report-section-content h4 {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin: 15px 0 8px 0;
        }

        .report-section-content code {
            background: #f0f2f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #e83e8c;
        }

        .report-section-content .info-row {
            display: flex;
            margin-bottom: 8px;
            align-items: baseline;
        }

        .report-section-content .info-label {
            font-weight: 600;
            color: #667eea;
            min-width: 100px;
            margin-right: 10px;
        }

        .report-section-content .info-value {
            color: #333;
            flex: 1;
        }

        .no-data {
            text-align: center;
            color: #999;
            padding: 50px 20px;
            font-size: 15px;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 50px 20px;
            font-size: 16px;
        }

        /* è¯„æµ‹çª—å£æµ®åŠ¨æŒ‰é’® */
        .eval-float-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .eval-float-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .eval-float-btn.hidden {
            display: none;
        }

        /* è¯„æµ‹çª—å£å®¹å™¨ */
        .eval-window {
            position: fixed;
            /* å±…ä¸­æ˜¾ç¤ºï¼Œä¸Šä¸‹ç•™10% */
            top: 10vh;
            left: 50%;
            transform: translateX(-50%);
            /* é«˜åº¦80vhï¼Œå®½åº¦ä¿æŒ0.7çš„å®½é«˜æ¯” */
            width: 56vh;
            height: 80vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            z-index: 1001;
            resize: both;
            overflow: hidden;
            min-width: 350px;
            min-height: 400px;
            max-width: 90vw;
            max-height: 90vh;
        }

        .eval-window.active {
            display: flex;
        }

        .eval-window.minimized {
            height: 50px !important;
            min-height: 50px !important;
            max-height: 50px !important;
            resize: none !important;
        }

        .eval-window.dragging {
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        /* çª—å£æ ‡é¢˜æ  */
        .eval-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        /* å¡«å†™è¿›åº¦æç¤ºåŒºåŸŸ */
        .eval-progress-bar {
            background: #f8f9fa;
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }

        .eval-progress-bar.show {
            display: block;
        }

        .progress-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-percentage {
            font-weight: 600;
            color: #667eea;
        }

        .progress-track {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .incomplete-items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .incomplete-tag {
            font-size: 11px;
            padding: 3px 8px;
            background: #fff3cd;
            color: #856404;
            border-radius: 10px;
            border: 1px solid #ffc107;
            cursor: pointer;
            transition: all 0.2s;
        }

        .incomplete-tag:hover {
            background: #ffc107;
            color: white;
        }

        /* æœªå¡«å†™çš„è¯„åˆ†é¡¹é«˜äº® */
        .eval-section.incomplete {
            border: 2px solid #ffc107;
            border-radius: 8px;
            background: #fff9e6;
        }

        .eval-section.incomplete .eval-section-title {
            color: #856404;
            user-select: none;
            border-radius: 12px 12px 0 0;
            position: relative;
        }

        .eval-header::before {
            content: 'â‹®â‹®';
            position: absolute;
            left: 8px;
            font-size: 18px;
            opacity: 0.6;
            letter-spacing: -2px;
        }

        .eval-title {
            font-size: 15px;
            font-weight: 600;
            margin-left: 16px;
        }

        .eval-title::after {
            content: 'ï¼ˆå¯æ‹–åŠ¨ï¼‰';
            font-size: 11px;
            opacity: 0.7;
            margin-left: 6px;
            font-weight: 400;
        }

        .eval-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .eval-font-controls {
            display: flex;
            gap: 4px;
            margin-right: 12px;
            padding-right: 12px;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }

        .eval-control-btn {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .eval-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .eval-font-btn {
            width: 28px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .eval-font-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* çª—å£å†…å®¹åŒº */
        .eval-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .eval-window.minimized .eval-content {
            display: none;
        }

        /* è°ƒæ•´å¤§å°å›¾æ ‡ */
        .eval-window::after {
            content: 'â‡²';
            position: absolute;
            right: 4px;
            bottom: 4px;
            font-size: 16px;
            color: #999;
            pointer-events: none;
            opacity: 0.5;
            line-height: 1;
        }

        .eval-window.minimized::after {
            display: none;
        }

        .eval-window:hover::after {
            opacity: 0.8;
            color: #667eea;
        }

        /* è¯„åˆ†é¡¹ */
        .eval-section {
            margin-bottom: 20px;
        }

        .eval-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .eval-section-max {
            font-size: 12px;
            color: #999;
            font-weight: normal;
        }

        .eval-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .eval-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        /* æ˜Ÿæ˜Ÿè¯„åˆ† */
        .star-rating {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 8px 0;
        }

        .star {
            font-size: 24px;
            cursor: pointer;
            color: #ddd;
            transition: all 0.15s;
            user-select: none;
        }

        .star.filled {
            color: #ffc107;
            text-shadow: 0 0 3px rgba(255, 193, 7, 0.3);
        }

        .star:hover {
            transform: scale(1.15);
        }

        .star-score {
            margin-left: 8px;
            font-size: 15px;
            font-weight: 600;
            color: #667eea;
            min-width: 70px;
        }

        .eval-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .eval-input.score-input {
            width: 70px;
            text-align: center;
            flex: none;
        }

        .eval-textarea {
            width: 100%;
            min-height: 60px;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            resize: vertical;
            font-family: inherit;
        }

        .eval-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* æ€»åˆ†æ˜¾ç¤º */
        .eval-total {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
        }

        .eval-total-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .eval-total-score {
            font-size: 32px;
            font-weight: 700;
            color: #ffc107;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .eval-total-stars {
            display: flex;
            gap: 3px;
        }

        .eval-total-number {
            font-size: 20px;
            color: #667eea;
        }

        /* æŒ‰é’®ç»„ */
        .eval-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .eval-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eval-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .eval-btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .eval-btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .eval-btn-secondary:hover {
            background: #e5e5e5;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .eval-content::-webkit-scrollbar {
            width: 6px;
        }

        .eval-content::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        .eval-content::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .eval-content::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* ä½¿ç”¨æç¤º */
        .eval-hint {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .eval-hint.show {
            opacity: 1;
        }

        .eval-hint::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid rgba(0, 0, 0, 0.85);
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="home-button">â† è¿”å›ä¸»é¡µ</a>
        <div class="patient-selector">
            <span class="patient-selector-label">ğŸ‘¤ é€‰æ‹©æ‚£è€…ï¼š</span>
            <div class="patient-tabs" id="patientTabs"></div>
        </div>
    </div>

    <div class="main-container">
        <!-- å·¦ä¾§å¯¹è¯åŒºåŸŸ -->
        <div class="chat-panel">
            <div class="chat-header">
                <h2>ğŸ’¬ æ‚£è€…å¯¹è¯è®°å½•</h2>
            </div>
            <div class="chat-content" id="chatContent">
                <div class="loading">æ­£åœ¨åŠ è½½å¯¹è¯...</div>
            </div>
        </div>

        <!-- å³ä¾§æŠ¥å‘ŠåŒºåŸŸ -->
        <div class="report-panel">
            <div class="report-header">
                <div class="report-title">
                    <h2>ğŸ“‹ åŒ»ç–—æŠ¥å‘Š</h2>
                    <div class="model-name" id="modelName">æ¨¡å‹: åŠ è½½ä¸­...</div>
                </div>
                <div class="model-navigator">
                    <button class="nav-button" id="prevModel" onclick="previousModel()" disabled>â—€</button>
                    <span class="model-indicator" id="modelIndicator">-/-</span>
                    <button class="nav-button" id="nextModel" onclick="nextModel()" disabled>â–¶</button>
                </div>
            </div>
            <div class="report-content" id="reportContent">
                <div class="loading">æ­£åœ¨åŠ è½½æŠ¥å‘Š...</div>
            </div>
        </div>
    </div>

    <!-- è¯„æµ‹æµ®åŠ¨æŒ‰é’® -->
    <button class="eval-float-btn" id="evalFloatBtn" onclick="toggleEvalWindow()">
        ğŸ“
    </button>

    <!-- è¯„æµ‹çª—å£ -->
    <div class="eval-window" id="evalWindow">
        <div class="eval-hint" id="evalHint">ğŸ’¡ æ‹–åŠ¨æ ‡é¢˜æ ç§»åŠ¨ | å³ä¸‹è§’è°ƒæ•´å¤§å°</div>
        <div class="eval-header" id="evalHeader">
            <div class="eval-title">æ¨¡å‹è¾“å‡ºè¯„æµ‹</div>
            <div class="eval-controls">
                <div class="eval-font-controls">
                    <button class="eval-font-btn" onclick="decreaseFontSize()" title="ç¼©å°å­—ä½“">Aâˆ’</button>
                    <button class="eval-font-btn" onclick="increaseFontSize()" title="æ”¾å¤§å­—ä½“">A+</button>
                </div>
                <button class="eval-control-btn" onclick="toggleMinimize()" title="æœ€å°åŒ–">
                    <span id="minimizeIcon">âˆ’</span>
                </button>
                <button class="eval-control-btn" onclick="closeEvalWindow()" title="å…³é—­">Ã—</button>
            </div>
        </div>

        <!-- å¡«å†™è¿›åº¦æ¡ -->
        <div class="eval-progress-bar" id="evalProgressBar">
            <div class="progress-title">
                <span>ğŸ“ è¯„æµ‹è¿›åº¦</span>
                <span class="progress-percentage" id="progressPercentage">0%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div class="incomplete-items" id="incompleteItems">
                <!-- æœªå¡«é¡¹æ ‡ç­¾å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <div class="eval-content">
            <!-- æ€»åˆ†æ˜¾ç¤º -->
            <div class="eval-total">
                <div class="eval-total-label">å¹³å‡è¯„åˆ†</div>
                <div class="eval-total-score">
                    <div class="eval-total-stars" id="totalStars">
                        â˜…â˜…â˜…â˜…â˜…
                    </div>
                    <span class="eval-total-number" id="totalScore">0.0</span>
                </div>
            </div>

            <!-- 1. ä¿¡æ¯å‡†ç¡®æ€§ -->
            <div class="eval-section">
                <div class="eval-section-title">
                    1. ä¿¡æ¯å‡†ç¡®æ€§
                    <span class="eval-section-max">æ»¡åˆ† 5â­</span>
                </div>
                <div class="star-rating">
                    <span class="star" data-score="1" data-category="accuracy" onclick="setRating('accuracy', 1)">â˜…</span>
                    <span class="star" data-score="2" data-category="accuracy" onclick="setRating('accuracy', 2)">â˜…</span>
                    <span class="star" data-score="3" data-category="accuracy" onclick="setRating('accuracy', 3)">â˜…</span>
                    <span class="star" data-score="4" data-category="accuracy" onclick="setRating('accuracy', 4)">â˜…</span>
                    <span class="star" data-score="5" data-category="accuracy" onclick="setRating('accuracy', 5)">â˜…</span>
                    <span class="star-score" id="score-accuracy-display">æœªè¯„åˆ†</span>
                </div>
                <input type="hidden" id="score-accuracy" value="0">
                <textarea class="eval-textarea" id="comment-accuracy"
                          placeholder="è¯„åˆ†è¯´æ˜ï¼šæ•°å€¼é”™è¯¯ã€è¯åé”™è¯¯ã€æ— ä¸­ç”Ÿæœ‰ç­‰..."></textarea>
            </div>

            <!-- 2. ä¿¡æ¯å®Œæ•´æ€§ (25åˆ†) -->
            <div class="eval-section">
                <div class="eval-section-title">
                    2. ä¿¡æ¯å®Œæ•´æ€§
                    <span class="eval-section-max">æ»¡åˆ† 5â­</span>
                </div>
                <div class="star-rating">
                    <span class="star" data-score="1" data-category="completeness" onclick="setRating('completeness', 1)">â˜…</span>
                    <span class="star" data-score="2" data-category="completeness" onclick="setRating('completeness', 2)">â˜…</span>
                    <span class="star" data-score="3" data-category="completeness" onclick="setRating('completeness', 3)">â˜…</span>
                    <span class="star" data-score="4" data-category="completeness" onclick="setRating('completeness', 4)">â˜…</span>
                    <span class="star" data-score="5" data-category="completeness" onclick="setRating('completeness', 5)">â˜…</span>
                    <span class="star-score" id="score-completeness-display">æœªè¯„åˆ†</span>
                </div>
                <input type="hidden" id="score-completeness" value="0">
                <textarea class="eval-textarea" id="comment-completeness"
                          placeholder="è¯„åˆ†è¯´æ˜ï¼šç¼ºå¤±ä¿¡æ¯ã€ä¸»è¯‰ã€ç”¨è¯æ–¹æ¡ˆã€æ£€æŸ¥ç»“æœç­‰..."></textarea>
            </div>

            <!-- 3. ä¸´åºŠå®ç”¨æ€§ (20åˆ†) -->
            <div class="eval-section">
                <div class="eval-section-title">
                    3. ä¸´åºŠå®ç”¨æ€§
                    <span class="eval-section-max">æ»¡åˆ† 5â­</span>
                </div>
                <div class="star-rating">
                    <span class="star" data-score="1" data-category="clinical" onclick="setRating('clinical', 1)">â˜…</span>
                    <span class="star" data-score="2" data-category="clinical" onclick="setRating('clinical', 2)">â˜…</span>
                    <span class="star" data-score="3" data-category="clinical" onclick="setRating('clinical', 3)">â˜…</span>
                    <span class="star" data-score="4" data-category="clinical" onclick="setRating('clinical', 4)">â˜…</span>
                    <span class="star" data-score="5" data-category="clinical" onclick="setRating('clinical', 5)">â˜…</span>
                    <span class="star-score" id="score-clinical-display">æœªè¯„åˆ†</span>
                </div>
                <input type="hidden" id="score-clinical" value="0">
                <textarea class="eval-textarea" id="comment-clinical"
                          placeholder="è¯„åˆ†è¯´æ˜ï¼šæ˜¯å¦çªå‡ºè¡€ç³–æ§åˆ¶ã€ä½“é‡å˜åŒ–ã€ç”¨è¯æ–¹æ¡ˆã€å¹¶å‘ç—‡çº¿ç´¢ç­‰..."></textarea>
            </div>

            <!-- 4. ç»“æ„æ¸…æ™°åº¦ (15åˆ†) -->
            <div class="eval-section">
                <div class="eval-section-title">
                    4. ç»“æ„æ¸…æ™°åº¦
                    <span class="eval-section-max">æ»¡åˆ† 5â­</span>
                </div>
                <div class="star-rating">
                    <span class="star" data-score="1" data-category="structure" onclick="setRating('structure', 1)">â˜…</span>
                    <span class="star" data-score="2" data-category="structure" onclick="setRating('structure', 2)">â˜…</span>
                    <span class="star" data-score="3" data-category="structure" onclick="setRating('structure', 3)">â˜…</span>
                    <span class="star" data-score="4" data-category="structure" onclick="setRating('structure', 4)">â˜…</span>
                    <span class="star" data-score="5" data-category="structure" onclick="setRating('structure', 5)">â˜…</span>
                    <span class="star-score" id="score-structure-display">æœªè¯„åˆ†</span>
                </div>
                <input type="hidden" id="score-structure" value="0">
                <textarea class="eval-textarea" id="comment-structure"
                          placeholder="è¯„åˆ†è¯´æ˜ï¼šç« èŠ‚åˆ’åˆ†ã€æ ‡é¢˜å±‚çº§ã€ä¿¡æ¯å½’ç±»ã€æ—¶é—´çº¿ç­‰..."></textarea>
            </div>

            <!-- 5. è¯­è¨€ä¸“ä¸šæ€§ (10åˆ†) -->
            <div class="eval-section">
                <div class="eval-section-title">
                    5. è¯­è¨€ä¸“ä¸šæ€§
                    <span class="eval-section-max">æ»¡åˆ† 5â­</span>
                </div>
                <div class="star-rating">
                    <span class="star" data-score="1" data-category="language" onclick="setRating('language', 1)">â˜…</span>
                    <span class="star" data-score="2" data-category="language" onclick="setRating('language', 2)">â˜…</span>
                    <span class="star" data-score="3" data-category="language" onclick="setRating('language', 3)">â˜…</span>
                    <span class="star" data-score="4" data-category="language" onclick="setRating('language', 4)">â˜…</span>
                    <span class="star" data-score="5" data-category="language" onclick="setRating('language', 5)">â˜…</span>
                    <span class="star-score" id="score-language-display">æœªè¯„åˆ†</span>
                </div>
                <input type="hidden" id="score-language" value="0">
                <textarea class="eval-textarea" id="comment-language"
                          placeholder="è¯„åˆ†è¯´æ˜ï¼šå†—ä½™è¡¨è¾¾ã€å£è¯­åŒ–ã€ä¸ä¸“ä¸šè¡¨è¾¾ç­‰..."></textarea>
            </div>

            <!-- ç»¼åˆè¯„ä»· -->
            <div class="eval-section">
                <div class="eval-section-title">ç»¼åˆè¯„ä»·</div>
                <textarea class="eval-textarea" id="overall-comment"
                          placeholder="æ•´ä½“ä¼˜ç¼ºç‚¹ã€æ”¹è¿›å»ºè®®..." style="min-height: 80px;"></textarea>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="eval-actions">
                <button class="eval-btn eval-btn-secondary" onclick="resetEval()">é‡ç½®</button>
                <button class="eval-btn eval-btn-primary" onclick="saveEval()">ä¿å­˜è¯„æµ‹</button>
            </div>
        </div>
    </div>

    <script>
        let comparisonData = null;
        let currentPatient = null;
        let currentModelIndex = 0;
        let availableModels = [];
        let debugMode = false;

        // æ£€æŸ¥debugæ¨¡å¼
        const urlParams = new URLSearchParams(window.location.search);
        debugMode = urlParams.get('debug') === 'true';

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                console.log('å¼€å§‹åŠ è½½æ•°æ®...');
                const response = await fetch('output/comparison_data.json');
                console.log('å“åº”çŠ¶æ€:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                comparisonData = await response.json();
                console.log('æ•°æ®åŠ è½½æˆåŠŸ:', comparisonData);

                if (!comparisonData || !comparisonData.patients || !comparisonData.models) {
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }

                initializePage();
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                const errorMsg = `âŒ æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`;
                document.getElementById('chatContent').innerHTML =
                    `<div class="no-data">${errorMsg}</div>`;
                document.getElementById('reportContent').innerHTML =
                    `<div class="no-data">${errorMsg}</div>`;
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            availableModels = comparisonData.models;

            // åˆå§‹åŒ–æ‚£è€…é€‰æ‹©å™¨
            const patientTabs = document.getElementById('patientTabs');
            comparisonData.patients.forEach((patient, index) => {
                const tab = document.createElement('div');
                tab.className = 'patient-tab';
                tab.textContent = patient;
                tab.onclick = () => selectPatient(patient);

                // ç¬¬ä¸€ä¸ªæ‚£è€…é»˜è®¤é€‰ä¸­
                if (index === 0) {
                    tab.classList.add('active');
                }

                patientTabs.appendChild(tab);
            });

            // é€‰æ‹©ç¬¬ä¸€ä¸ªæ‚£è€…
            if (comparisonData.patients.length > 0) {
                currentPatient = comparisonData.patients[0];
                currentModelIndex = 0;
                updateView();
            }

            // è®¾ç½®æ¨¡å‹åç§°æ˜¾ç¤º/éšè—
            const modelNameElement = document.getElementById('modelName');
            if (!debugMode) {
                modelNameElement.classList.add('hidden');
            }
        }

        // é€‰æ‹©æ‚£è€…
        function selectPatient(patient) {
            currentPatient = patient;
            currentModelIndex = 0;

            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.patient-tab').forEach(tab => {
                if (tab.textContent === patient) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            updateView();
        }

        // ä¸Šä¸€ä¸ªæ¨¡å‹
        function previousModel() {
            // æ£€æŸ¥å½“å‰æ¨¡å‹è¯„æµ‹æ˜¯å¦å®Œæˆ
            if (!checkCompletionStatus()) {
                alert('âš ï¸ è¯·å…ˆå®Œæˆå½“å‰æ¨¡å‹çš„è¯„æµ‹ï¼\n\næœªå¡«å†™é¡¹ä¼šåœ¨ä¸Šæ–¹æ˜¾ç¤ºï¼Œè¯·ç‚¹å‡»ä¿®æ”¹åˆ†æ•°åå†åˆ‡æ¢æ¨¡å‹ã€‚');
                // æ»šåŠ¨åˆ°è¯„æµ‹çª—å£
                const evalWindow = document.getElementById('evalWindow');
                if (evalWindow.classList.contains('active')) {
                    document.getElementById('evalProgressBar').classList.add('show');
                    document.getElementById('evalProgressBar').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                return;
            }

            if (currentModelIndex > 0) {
                currentModelIndex--;
                updateView();
            }
        }

        // ä¸‹ä¸€ä¸ªæ¨¡å‹
        function nextModel() {
            // æ£€æŸ¥å½“å‰æ¨¡å‹è¯„æµ‹æ˜¯å¦å®Œæˆ
            if (!checkCompletionStatus()) {
                alert('âš ï¸ è¯·å…ˆå®Œæˆå½“å‰æ¨¡å‹çš„è¯„æµ‹ï¼\n\næœªå¡«å†™é¡¹ä¼šåœ¨ä¸Šæ–¹æ˜¾ç¤ºï¼Œè¯·ç‚¹å‡»ä¿®æ”¹åˆ†æ•°åå†åˆ‡æ¢æ¨¡å‹ã€‚');
                // æ»šåŠ¨åˆ°è¯„æµ‹çª—å£
                const evalWindow = document.getElementById('evalWindow');
                if (evalWindow.classList.contains('active')) {
                    document.getElementById('evalProgressBar').classList.add('show');
                    document.getElementById('evalProgressBar').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                return;
            }

            if (currentModelIndex < availableModels.length - 1) {
                currentModelIndex++;
                updateView();
            }
        }

        // æ›´æ–°è§†å›¾
        function updateView() {
            updateChatView();
            updateReportView();
            updateNavigator();
            loadSavedEval(); // åŠ è½½å·²ä¿å­˜çš„è¯„æµ‹
            checkCompletionStatus(); // æ£€æŸ¥æ–°æ¨¡å‹çš„å®Œæˆåº¦
        }

        // æ›´æ–°å¯¹è¯è§†å›¾
        function updateChatView() {
            const chatContent = document.getElementById('chatContent');

            if (!currentPatient || !comparisonData.data[currentPatient]) {
                chatContent.innerHTML = '<div class="no-data">æš‚æ— å¯¹è¯æ•°æ®</div>';
                return;
            }

            // è·å–ç¬¬ä¸€ä¸ªå¯¹è¯è®°å½•ï¼ˆé€šå¸¸æ˜¯ä¸»è¯‰å¯¹è¯ï¼ŒåŒ…å«å®Œæ•´çš„å¯¹è¯å†å²ï¼‰
            const patientData = comparisonData.data[currentPatient];
            const firstConvId = Object.keys(patientData).sort()[0];
            const firstConv = patientData[firstConvId];

            // è·å–ä»»æ„ä¸€ä¸ªæ¨¡å‹çš„å¯¹è¯æ•°æ®ï¼ˆæ‰€æœ‰æ¨¡å‹çš„å¯¹è¯å†å²åº”è¯¥æ˜¯ç›¸åŒçš„ï¼‰
            let chatData = null;
            for (const model in firstConv) {
                if (firstConv[model].chat) {
                    chatData = firstConv[model].chat;
                    break;
                }
            }

            if (!chatData) {
                chatContent.innerHTML = '<div class="no-data">æš‚æ— å¯¹è¯è®°å½•</div>';
                return;
            }

            // è§£æå¹¶æ¸²æŸ“å¯¹è¯
            const messages = parseChatContent(chatData);
            let html = '';
            messages.forEach(msg => {
                if (msg.type === 'patient-info') {
                    // æ¸²æŸ“æ‚£è€…ä¿¡æ¯å¡ç‰‡
                    html += '<div class="patient-info-card"><h4>ğŸ‘¤ æ‚£è€…åŸºæœ¬ä¿¡æ¯</h4><div class="patient-info-grid">';
                    for (const [key, value] of Object.entries(msg.data)) {
                        html += `<div class="patient-info-item"><strong>${key}:</strong> ${value}</div>`;
                    }
                    html += '</div></div>';
                } else if (msg.type === 'section') {
                    html += `<div class="chat-section-title">${msg.content}</div>`;
                } else {
                    const role = msg.role === 'patient' ? 'patient' : 'doctor';
                    const avatar = msg.role === 'patient' ? 'ğŸ‘¤' : 'ğŸ‘¨â€âš•ï¸';
                    const roleName = msg.role === 'patient' ? 'æ‚£è€…' : 'åŒ»åŠ©';

                    html += `
                        <div class="chat-message ${role}">
                            <div class="chat-message-header">
                                <div class="chat-avatar">${avatar}</div>
                                <div class="chat-role">${roleName}</div>
                            </div>
                            <div class="chat-bubble">${escapeHtml(msg.content)}</div>
                        </div>
                    `;
                }
            });

            chatContent.innerHTML = html;
            chatContent.scrollTop = 0;
        }

        // è§£æå¯¹è¯å†…å®¹
        function parseChatContent(content) {
            const messages = [];
            const lines = content.split('\n');

            let inDialogSection = false;
            let inBasicInfo = false;
            let currentMessage = null;
            let patientInfo = {};

            for (let line of lines) {
                line = line.trim();

                if (line.startsWith('====') || line.startsWith('----') || line === '') {
                    continue;
                }

                if (line.includes('æ‚£è€…åŸºæœ¬ä¿¡æ¯')) {
                    if (currentMessage) {
                        messages.push(currentMessage);
                        currentMessage = null;
                    }
                    inBasicInfo = true;
                    inDialogSection = false;
                    continue;
                }

                if (line.includes('é¢„é—®è¯Šå¯¹è¯è®°å½•')) {
                    if (currentMessage) {
                        messages.push(currentMessage);
                        currentMessage = null;
                    }
                    if (Object.keys(patientInfo).length > 0) {
                        messages.push({ type: 'patient-info', data: patientInfo });
                    }
                    messages.push({ type: 'section', content: 'é¢„é—®è¯Šå¯¹è¯è®°å½•' });
                    inBasicInfo = false;
                    inDialogSection = true;
                    continue;
                }

                if (inBasicInfo) {
                    const infoMatch = line.match(/^(.+?)[:ï¼š]\s*(.+)$/);
                    if (infoMatch) {
                        const key = infoMatch[1].trim();
                        const value = infoMatch[2].trim();
                        patientInfo[key] = value;
                    }
                    continue;
                }

                const patientMatch = line.match(/^\d+\.\s*æ‚£è€…:\s*(.+)$/);
                const doctorMatch = line.match(/^\d+\.\s*åŒ»åŠ©:\s*(.+)$/);

                if (patientMatch) {
                    if (currentMessage) {
                        messages.push(currentMessage);
                    }
                    currentMessage = {
                        type: 'message',
                        role: 'patient',
                        content: patientMatch[1].trim()
                    };
                } else if (doctorMatch) {
                    if (currentMessage) {
                        messages.push(currentMessage);
                    }
                    currentMessage = {
                        type: 'message',
                        role: 'doctor',
                        content: doctorMatch[1].trim()
                    };
                } else if (currentMessage && line) {
                    currentMessage.content += '\n' + line;
                }
            }

            if (currentMessage) {
                messages.push(currentMessage);
            }

            return messages;
        }

        // æ›´æ–°æŠ¥å‘Šè§†å›¾
        function updateReportView() {
            const reportContent = document.getElementById('reportContent');
            const modelNameElement = document.getElementById('modelName');

            if (!currentPatient || !comparisonData.data[currentPatient]) {
                reportContent.innerHTML = '<div class="no-data">æš‚æ— æŠ¥å‘Šæ•°æ®</div>';
                return;
            }

            const currentModel = availableModels[currentModelIndex];
            modelNameElement.textContent = `æ¨¡å‹: ${currentModel}`;

            const patientData = comparisonData.data[currentPatient];

            // å®šä¹‰æŠ¥å‘Šé¡ºåº
            const reportOrder = ['ä¸»è¯‰', 'ç°ç—…å²', 'æ—¢å¾€å²', 'åŒ»ç–—æ€»ç»“', 'å®¶æ—å²'];

            let html = '';
            let hasData = false;

            // æŒ‰é¡ºåºæ”¶é›†æŠ¥å‘Š
            reportOrder.forEach(title => {
                // æŸ¥æ‰¾åŒ¹é…çš„å¯¹è¯ID
                for (const convId in patientData) {
                    const convData = patientData[convId][currentModel];
                    if (convData && convData.title === title) {
                        hasData = true;
                        html += `
                            <div class="report-section">
                                <div class="report-section-title">${title}</div>
                                <div class="report-section-content">${renderMarkdown(convData.output)}</div>
                            </div>
                        `;
                        break;
                    }
                }
            });

            if (!hasData) {
                reportContent.innerHTML = '<div class="no-data">è¯¥æ¨¡å‹æš‚æ— æŠ¥å‘Šæ•°æ®</div>';
            } else {
                reportContent.innerHTML = html;
                reportContent.scrollTop = 0;
            }
        }

        // æ›´æ–°å¯¼èˆªå™¨
        function updateNavigator() {
            const prevButton = document.getElementById('prevModel');
            const nextButton = document.getElementById('nextModel');
            const indicator = document.getElementById('modelIndicator');

            prevButton.disabled = currentModelIndex === 0;
            nextButton.disabled = currentModelIndex === availableModels.length - 1;
            indicator.textContent = `${currentModelIndex + 1}/${availableModels.length}`;
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // Markdownæ¸²æŸ“å‡½æ•°
        function renderMarkdown(text) {
            if (!text) return '';

            let html = text;

            // è½¬ä¹‰HTMLæ ‡ç­¾
            html = html.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;');

            // å¤„ç†ä¸‰çº§æ ‡é¢˜ ### Title
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');

            // å¤„ç†å››çº§æ ‡é¢˜ #### Title
            html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');

            // å¤„ç†åŠ ç²— **text** æˆ– __text__
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');

            // å¤„ç†è¡Œå†…ä»£ç  `code`
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // å¤„ç†é”®å€¼å¯¹æ ¼å¼ï¼ˆå¦‚ï¼š"æ€§åˆ«ï¼š** ç”·"ï¼‰
            html = html.replace(/^- \*\*(.+?)[ï¼š:]\*\*\s*(.+)$/gm, function(match, label, value) {
                return `<div class="info-row"><span class="info-label">${label}:</span><span class="info-value">${value}</span></div>`;
            });

            // å¤„ç†åˆ—è¡¨é¡¹ - item æˆ– * item
            const lines = html.split('\n');
            let inList = false;
            let processedLines = [];

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];

                // æ£€æµ‹åˆ—è¡¨é¡¹
                if (/^[-*â€¢]\s+/.test(line)) {
                    if (!inList) {
                        processedLines.push('<ul>');
                        inList = true;
                    }
                    // ç§»é™¤åˆ—è¡¨æ ‡è®°å¹¶åˆ›å»ºåˆ—è¡¨é¡¹
                    line = '<li>' + line.replace(/^[-*â€¢]\s+/, '') + '</li>';
                    processedLines.push(line);
                } else {
                    if (inList && line.trim() === '') {
                        processedLines.push('</ul>');
                        inList = false;
                    }
                    if (line.trim() !== '' || !inList) {
                        processedLines.push(line);
                    }
                }
            }

            // å…³é—­å¯èƒ½æœªå…³é—­çš„åˆ—è¡¨
            if (inList) {
                processedLines.push('</ul>');
            }

            html = processedLines.join('\n');

            // å¤„ç†æ®µè½ï¼šè¿ç»­çš„éæ ‡ç­¾è¡Œåˆå¹¶ä¸ºæ®µè½
            html = html.replace(/^(?!<[hul]|<div|<li)(.+)$/gm, function(match) {
                if (match.trim() === '') return '';
                return '<p>' + match + '</p>';
            });

            // æ¸…ç†å¤šä½™çš„ç©ºæ®µè½
            html = html.replace(/<p>\s*<\/p>/g, '');
            html = html.replace(/<p>(<[hul])/g, '$1');
            html = html.replace(/(<\/[hul][^>]*>)<\/p>/g, '$1');

            return html;
        }

        // ==================== è¯„æµ‹çª—å£ç›¸å…³åŠŸèƒ½ ====================

        // å­—ä½“å¤§å°æ§åˆ¶
        let currentFontSize = parseInt(localStorage.getItem('eval_font_size')) || 13;

        function applyFontSize() {
            const evalContent = document.getElementById('evalWindow');
            if (evalContent) {
                evalContent.style.fontSize = currentFontSize + 'px';
            }
        }

        function increaseFontSize() {
            if (currentFontSize < 18) {
                currentFontSize++;
                applyFontSize();
                localStorage.setItem('eval_font_size', currentFontSize);
            }
        }

        function decreaseFontSize() {
            if (currentFontSize > 10) {
                currentFontSize--;
                applyFontSize();
                localStorage.setItem('eval_font_size', currentFontSize);
            }
        }

        // åˆ‡æ¢è¯„æµ‹çª—å£æ˜¾ç¤º/éšè—
        function toggleEvalWindow() {
            const evalWindow = document.getElementById('evalWindow');
            const evalBtn = document.getElementById('evalFloatBtn');
            const evalHint = document.getElementById('evalHint');

            if (evalWindow.classList.contains('active')) {
                evalWindow.classList.remove('active');
                evalBtn.classList.remove('hidden');
            } else {
                evalWindow.classList.add('active');
                evalBtn.classList.add('hidden');
                calculateTotal(); // æ‰“å¼€æ—¶è®¡ç®—ä¸€æ¬¡æ€»åˆ†
                checkCompletionStatus(); // æ£€æŸ¥å®Œæˆåº¦

                // é¦–æ¬¡æ‰“å¼€æ—¶æ˜¾ç¤ºä½¿ç”¨æç¤º
                const hasShownHint = localStorage.getItem('eval_hint_shown');
                if (!hasShownHint) {
                    setTimeout(() => {
                        evalHint.classList.add('show');
                        setTimeout(() => {
                            evalHint.classList.remove('show');
                        }, 3000); // 3ç§’åéšè—
                    }, 500); // å»¶è¿Ÿ0.5ç§’æ˜¾ç¤º
                    localStorage.setItem('eval_hint_shown', 'true');
                }
            }
        }

        // å…³é—­è¯„æµ‹çª—å£
        function closeEvalWindow() {
            const evalWindow = document.getElementById('evalWindow');
            const evalBtn = document.getElementById('evalFloatBtn');

            evalWindow.classList.remove('active');
            evalWindow.classList.remove('minimized');
            evalBtn.classList.remove('hidden');
            document.getElementById('minimizeIcon').textContent = 'âˆ’';
        }

        // æœ€å°åŒ–/æ¢å¤çª—å£
        function toggleMinimize() {
            const evalWindow = document.getElementById('evalWindow');
            const minimizeIcon = document.getElementById('minimizeIcon');

            if (evalWindow.classList.contains('minimized')) {
                evalWindow.classList.remove('minimized');
                minimizeIcon.textContent = 'âˆ’';
            } else {
                evalWindow.classList.add('minimized');
                minimizeIcon.textContent = 'â–¡';
            }
        }

        // è®¾ç½®æ˜Ÿæ˜Ÿè¯„åˆ†
        function setRating(category, score) {
            // æ›´æ–°éšè—çš„è¾“å…¥æ¡†
            document.getElementById(`score-${category}`).value = score;

            // æ›´æ–°æ˜Ÿæ˜Ÿæ˜¾ç¤º
            const stars = document.querySelectorAll(`.star[data-category="${category}"]`);
            stars.forEach(star => {
                const starScore = parseInt(star.getAttribute('data-score'));
                if (starScore <= score) {
                    star.classList.add('filled');
                } else {
                    star.classList.remove('filled');
                }
            });

            // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            const ratingLabels = ['', 'å¾ˆå·® (1â­)', 'è¾ƒå·® (2â­)', 'ä¸€èˆ¬ (3â­)', 'è‰¯å¥½ (4â­)', 'ä¼˜ç§€ (5â­)'];
            document.getElementById(`score-${category}-display`).textContent = ratingLabels[score] || 'æœªè¯„åˆ†';

            // è®¡ç®—æ€»åˆ†
            calculateTotal();
        }

        // æ£€æŸ¥æŸä¸ªè¯„åˆ†é¡¹æ˜¯å¦å·²å¡«å†™ï¼ˆè¯„åˆ†>0ï¼‰
        function isScoreCompleted(scoreId, maxScore) {
            const value = parseInt(document.getElementById(scoreId).value) || 0;
            return value > 0; // åªè¦è¯„åˆ†>0å°±ç®—å·²å¡«å†™
        }

        // è®¡ç®—å¡«å†™å®Œæˆåº¦
        function checkCompletionStatus() {
            const scoreItems = [
                { id: 'score-accuracy', max: 5, name: 'ä¿¡æ¯å‡†ç¡®æ€§', sectionId: 'section-accuracy' },
                { id: 'score-completeness', max: 5, name: 'ä¿¡æ¯å®Œæ•´æ€§', sectionId: 'section-completeness' },
                { id: 'score-clinical', max: 5, name: 'ä¸´åºŠå®ç”¨æ€§', sectionId: 'section-clinical' },
                { id: 'score-structure', max: 5, name: 'ç»“æ„æ¸…æ™°åº¦', sectionId: 'section-structure' },
                { id: 'score-language', max: 5, name: 'è¯­è¨€ä¸“ä¸šæ€§', sectionId: 'section-language' }
            ];

            let completedCount = 0;
            const incompleteItems = [];

            scoreItems.forEach(item => {
                const section = document.querySelector(`#${item.id}`).closest('.eval-section');
                if (isScoreCompleted(item.id, item.max)) {
                    completedCount++;
                    section.classList.remove('incomplete');
                } else {
                    section.classList.add('incomplete');
                    incompleteItems.push(item.name);
                }
            });

            const percentage = Math.round((completedCount / scoreItems.length) * 100);
            const isComplete = completedCount === scoreItems.length;

            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('progressPercentage').textContent = percentage + '%';
            document.getElementById('progressFill').style.width = percentage + '%';

            // æ›´æ–°æœªå¡«é¡¹æ ‡ç­¾
            const incompleteItemsContainer = document.getElementById('incompleteItems');
            if (incompleteItems.length > 0) {
                incompleteItemsContainer.innerHTML = incompleteItems.map(name =>
                    `<span class="incomplete-tag">âš ï¸ ${name}</span>`
                ).join('');
                document.getElementById('evalProgressBar').classList.add('show');
            } else {
                incompleteItemsContainer.innerHTML = '<span style="color: #52c41a; font-size: 12px;">âœ… æ‰€æœ‰é¡¹å·²å¡«å†™å®Œæˆ</span>';
                setTimeout(() => {
                    document.getElementById('evalProgressBar').classList.remove('show');
                }, 2000); // 2ç§’åéšè—è¿›åº¦æ¡
            }

            return isComplete;
        }

        // è®¡ç®—æ€»åˆ†ï¼ˆå¹³å‡æ˜Ÿæ•°ï¼‰
        function calculateTotal() {
            const accuracy = parseInt(document.getElementById('score-accuracy').value) || 0;
            const completeness = parseInt(document.getElementById('score-completeness').value) || 0;
            const clinical = parseInt(document.getElementById('score-clinical').value) || 0;
            const structure = parseInt(document.getElementById('score-structure').value) || 0;
            const language = parseInt(document.getElementById('score-language').value) || 0;

            // è®¡ç®—å¹³å‡åˆ†
            const scores = [accuracy, completeness, clinical, structure, language];
            const validScores = scores.filter(s => s > 0);
            const average = validScores.length > 0 ? validScores.reduce((a, b) => a + b, 0) / validScores.length : 0;

            // æ›´æ–°æ•°å­—æ˜¾ç¤º
            document.getElementById('totalScore').textContent = average.toFixed(1);

            // æ›´æ–°æ˜Ÿæ˜Ÿæ˜¾ç¤º
            const totalStars = document.getElementById('totalStars');
            const fullStars = Math.floor(average);
            const hasHalfStar = (average - fullStars) >= 0.5;
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= fullStars) {
                    starsHTML += 'â˜…';
                } else if (i === fullStars + 1 && hasHalfStar) {
                    starsHTML += 'â­';
                } else {
                    starsHTML += 'â˜†';
                }
            }
            totalStars.innerHTML = starsHTML;

            // æ ¹æ®åˆ†æ•°æ”¹å˜é¢œè‰²
            const scoreElement = document.getElementById('totalScore');
            if (average >= 4.5) {
                scoreElement.style.color = '#52c41a'; // ç»¿è‰²
            } else if (average >= 3.5) {
                scoreElement.style.color = '#ffc107'; // é»„è‰²
            } else if (average >= 2.5) {
                scoreElement.style.color = '#ff9800'; // æ©™è‰²
            } else if (average > 0) {
                scoreElement.style.color = '#f5222d'; // çº¢è‰²
            } else {
                scoreElement.style.color = '#999'; // ç°è‰²ï¼ˆæœªè¯„åˆ†ï¼‰
            }

            // æ£€æŸ¥å®Œæˆåº¦
            checkCompletionStatus();

            // è§¦å‘è‡ªåŠ¨ä¿å­˜
            autoSaveEval();
        }

        // é‡ç½®è¯„æµ‹è¡¨å•
        function resetEval() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¯„åˆ†å—ï¼Ÿ')) return;

            // é‡ç½®æ‰€æœ‰æ˜Ÿæ˜Ÿè¯„åˆ†
            ['accuracy', 'completeness', 'clinical', 'structure', 'language'].forEach(category => {
                document.getElementById(`score-${category}`).value = 0;
                document.getElementById(`score-${category}-display`).textContent = 'æœªè¯„åˆ†';
                document.querySelectorAll(`.star[data-category="${category}"]`).forEach(star => {
                    star.classList.remove('filled');
                });
            });

            document.getElementById('comment-accuracy').value = '';
            document.getElementById('comment-completeness').value = '';
            document.getElementById('comment-clinical').value = '';
            document.getElementById('comment-structure').value = '';
            document.getElementById('comment-language').value = '';
            document.getElementById('overall-comment').value = '';

            calculateTotal();
        }

        // ä¿å­˜è¯„æµ‹ç»“æœ
        async function saveEval(silent = false) {
            if (!currentPatient || !availableModels[currentModelIndex]) return;

            const evalData = {
                timestamp: new Date().toISOString(),
                patient: currentPatient,
                model: availableModels[currentModelIndex],
                scores: {
                    accuracy: {
                        score: parseInt(document.getElementById('score-accuracy').value) || 0,
                        max: 5,
                        comment: document.getElementById('comment-accuracy').value
                    },
                    completeness: {
                        score: parseInt(document.getElementById('score-completeness').value) || 0,
                        max: 5,
                        comment: document.getElementById('comment-completeness').value
                    },
                    clinical: {
                        score: parseInt(document.getElementById('score-clinical').value) || 0,
                        max: 5,
                        comment: document.getElementById('comment-clinical').value
                    },
                    structure: {
                        score: parseInt(document.getElementById('score-structure').value) || 0,
                        max: 5,
                        comment: document.getElementById('comment-structure').value
                    },
                    language: {
                        score: parseInt(document.getElementById('score-language').value) || 0,
                        max: 5,
                        comment: document.getElementById('comment-language').value
                    }
                },
                total_score: parseFloat(document.getElementById('totalScore').textContent),
                overall_comment: document.getElementById('overall-comment').value
            };

            // ä¿å­˜åˆ°localStorage
            const storageKey = `eval_${currentPatient}_${availableModels[currentModelIndex]}`;
            localStorage.setItem(storageKey, JSON.stringify(evalData));

            // åŒæ—¶ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆä»…åœ¨æ‰‹åŠ¨ä¿å­˜æ—¶ï¼‰
            if (!silent) {
                let history = JSON.parse(localStorage.getItem('eval_history') || '[]');
                // ç§»é™¤åŒä¸€æ‚£è€…-æ¨¡å‹çš„æ—§è®°å½•
                history = history.filter(h => !(h.patient === currentPatient && h.model === availableModels[currentModelIndex]));
                history.push(evalData);
                localStorage.setItem('eval_history', JSON.stringify(history));

                // æäº¤åˆ°æœåŠ¡å™¨ï¼ˆå¦‚æœå·²éªŒè¯èº«ä»½ï¼‰
                if (window.submitEvaluationToServer) {
                    const success = await window.submitEvaluationToServer(evalData);
                    if (success) {
                        alert('âœ… è¯„æµ‹å·²ä¿å­˜å¹¶æäº¤åˆ°æœåŠ¡å™¨ï¼\n\næ‚£è€…: ' + currentPatient + '\næ¨¡å‹: ' + availableModels[currentModelIndex] + '\næ€»åˆ†: ' + evalData.total_score);
                    } else {
                        alert('âš ï¸ è¯„æµ‹å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†æäº¤æœåŠ¡å™¨å¤±è´¥\n\næ‚£è€…: ' + currentPatient + '\næ¨¡å‹: ' + availableModels[currentModelIndex] + '\næ€»åˆ†: ' + evalData.total_score);
                    }
                } else {
                    alert('è¯„æµ‹å·²ä¿å­˜ï¼\n\næ‚£è€…: ' + currentPatient + '\næ¨¡å‹: ' + availableModels[currentModelIndex] + '\næ€»åˆ†: ' + evalData.total_score);
                }
                console.log('è¯„æµ‹æ•°æ®å·²ä¿å­˜:', evalData);
            }
        }

        // è‡ªåŠ¨ä¿å­˜ï¼ˆé˜²æŠ–ï¼‰
        let autoSaveTimer = null;
        function autoSaveEval() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                saveEval(true); // é™é»˜ä¿å­˜
            }, 500); // 500msåè‡ªåŠ¨ä¿å­˜
        }

        // åŠ è½½å·²ä¿å­˜çš„è¯„æµ‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        function loadSavedEval() {
            if (!currentPatient || !availableModels[currentModelIndex]) return;

            const storageKey = `eval_${currentPatient}_${availableModels[currentModelIndex]}`;
            const saved = localStorage.getItem(storageKey);

            if (saved) {
                const evalData = JSON.parse(saved);

                // åŠ è½½æ˜Ÿæ˜Ÿè¯„åˆ†
                ['accuracy', 'completeness', 'clinical', 'structure', 'language'].forEach(category => {
                    const score = evalData.scores[category].score;
                    if (score > 0) {
                        setRating(category, score);
                    }
                });

                document.getElementById('comment-accuracy').value = evalData.scores.accuracy.comment || '';
                document.getElementById('comment-completeness').value = evalData.scores.completeness.comment || '';
                document.getElementById('comment-clinical').value = evalData.scores.clinical.comment || '';
                document.getElementById('comment-structure').value = evalData.scores.structure.comment || '';
                document.getElementById('comment-language').value = evalData.scores.language.comment || '';
                document.getElementById('overall-comment').value = evalData.overall_comment || '';

                calculateTotal();
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œé‡ç½®ä¸ºé»˜è®¤å€¼ï¼ˆ0æ˜Ÿï¼‰
                ['accuracy', 'completeness', 'clinical', 'structure', 'language'].forEach(category => {
                    document.getElementById(`score-${category}`).value = 0;
                    document.getElementById(`score-${category}-display`).textContent = 'æœªè¯„åˆ†';
                    document.querySelectorAll(`.star[data-category="${category}"]`).forEach(star => {
                        star.classList.remove('filled');
                    });
                });

                document.getElementById('comment-accuracy').value = '';
                document.getElementById('comment-completeness').value = '';
                document.getElementById('comment-clinical').value = '';
                document.getElementById('comment-structure').value = '';
                document.getElementById('comment-language').value = '';
                document.getElementById('overall-comment').value = '';

                calculateTotal();
            }
        }

        // çª—å£æ‹–æ‹½åŠŸèƒ½
        let isDragging = false;
        let currentX, currentY, initialX, initialY;

        document.getElementById('evalHeader').addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('eval-control-btn') || e.target.closest('.eval-control-btn') ||
                e.target.classList.contains('eval-font-btn') || e.target.closest('.eval-font-btn')) {
                return; // ä¸åœ¨æ§åˆ¶æŒ‰é’®ä¸Šæ‹–æ‹½
            }

            isDragging = true;
            const evalWindow = document.getElementById('evalWindow');
            const rect = evalWindow.getBoundingClientRect();

            initialX = rect.left;
            initialY = rect.top;
            currentX = e.clientX;
            currentY = e.clientY;

            // ç§»é™¤transformï¼Œæ”¹ç”¨left/topå®šä½
            evalWindow.style.transform = 'none';
            evalWindow.style.left = initialX + 'px';
            evalWindow.style.top = initialY + 'px';

            // æ·»åŠ æ‹–åŠ¨çŠ¶æ€ç±»ï¼ˆé€æ˜æ•ˆæœï¼‰
            evalWindow.classList.add('dragging');
        });

        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;

            e.preventDefault();
            const evalWindow = document.getElementById('evalWindow');
            const rect = evalWindow.getBoundingClientRect();

            const dx = e.clientX - currentX;
            const dy = e.clientY - currentY;

            // è®¡ç®—æ–°ä½ç½®
            let newLeft = initialX + dx;
            let newTop = initialY + dy;

            // è¾¹ç•Œé™åˆ¶ - ç¡®ä¿çª—å£æ ‡é¢˜æ å§‹ç»ˆå¯è§
            const minTop = 0;
            const maxTop = window.innerHeight - 50; // è‡³å°‘ä¿ç•™50pxæ ‡é¢˜æ é«˜åº¦
            const minLeft = -rect.width + 100; // è‡³å°‘ä¿ç•™100pxå®½åº¦å¯è§
            const maxLeft = window.innerWidth - 100;

            newTop = Math.max(minTop, Math.min(newTop, maxTop));
            newLeft = Math.max(minLeft, Math.min(newLeft, maxLeft));

            evalWindow.style.left = newLeft + 'px';
            evalWindow.style.top = newTop + 'px';
        });

        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                const evalWindow = document.getElementById('evalWindow');
                const rect = evalWindow.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;

                // ç§»é™¤æ‹–åŠ¨çŠ¶æ€ç±»ï¼ˆæ¢å¤ä¸é€æ˜ï¼‰
                evalWindow.classList.remove('dragging');
            }
        });

        // ==================== åŸæœ‰é”®ç›˜äº‹ä»¶ç›‘å¬ ====================

        // é”®ç›˜äº‹ä»¶ç›‘å¬ - æ–¹å‘é”®å¯¼èˆª
        document.addEventListener('keydown', function(event) {
            const reportContent = document.getElementById('reportContent');
            const scrollAmount = 100; // æ¯æ¬¡æ»šåŠ¨çš„åƒç´ æ•°

            // å·¦ç®­å¤´é”® - ä¸Šä¸€ä¸ªæ¨¡å‹
            if (event.key === 'ArrowLeft' || event.keyCode === 37) {
                event.preventDefault();
                previousModel();
            }
            // å³ç®­å¤´é”® - ä¸‹ä¸€ä¸ªæ¨¡å‹
            else if (event.key === 'ArrowRight' || event.keyCode === 39) {
                event.preventDefault();
                nextModel();
            }
            // ä¸Šç®­å¤´é”® - å‘ä¸Šæ»šåŠ¨æŠ¥å‘Š
            else if (event.key === 'ArrowUp' || event.keyCode === 38) {
                event.preventDefault();
                if (reportContent) {
                    reportContent.scrollBy({
                        top: -scrollAmount,
                        behavior: 'smooth'
                    });
                }
            }
            // ä¸‹ç®­å¤´é”® - å‘ä¸‹æ»šåŠ¨æŠ¥å‘Š
            else if (event.key === 'ArrowDown' || event.keyCode === 40) {
                event.preventDefault();
                if (reportContent) {
                    reportContent.scrollBy({
                        top: scrollAmount,
                        behavior: 'smooth'
                    });
                }
            }
        });

        // åˆå§‹åŒ–è¯„æµ‹è¡¨å•è‡ªåŠ¨ä¿å­˜
        function initAutoSave() {
            // ä¸ºæ‰€æœ‰åˆ†æ•°è¾“å…¥æ¡†æ·»åŠ è‡ªåŠ¨ä¿å­˜
            const scoreInputs = [
                'score-accuracy',
                'score-completeness',
                'score-clinical',
                'score-structure',
                'score-language'
            ];

            scoreInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', autoSaveEval);
                    input.addEventListener('change', autoSaveEval);
                }
            });

            // ä¸ºæ‰€æœ‰è¯„è®ºæ–‡æœ¬æ¡†æ·»åŠ è‡ªåŠ¨ä¿å­˜
            const commentInputs = [
                'comment-accuracy',
                'comment-completeness',
                'comment-clinical',
                'comment-structure',
                'comment-language',
                'overall-comment'
            ];

            commentInputs.forEach(id => {
                const textarea = document.getElementById(id);
                if (textarea) {
                    textarea.addEventListener('input', autoSaveEval);
                }
            });

            console.log('è¯„æµ‹è¡¨å•è‡ªåŠ¨ä¿å­˜å·²å¯ç”¨');
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        loadData();
        initAutoSave(); // åˆå§‹åŒ–è‡ªåŠ¨ä¿å­˜
        applyFontSize(); // åº”ç”¨ä¿å­˜çš„å­—ä½“å¤§å°
    </script>

    <!-- èº«ä»½éªŒè¯æ¨¡å— -->
    <script src="evaluation-auth.js"></script>
</body>
</html>
