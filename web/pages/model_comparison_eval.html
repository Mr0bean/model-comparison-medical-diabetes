<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹è¯„æµ‹å¯¹æ¯”ï¼ˆäººå·¥æ‰“åˆ†ï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif; background: #f5f5f5; min-height: 100vh; }

        .container { width: 100%; min-height: 100vh; background: white; overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px 32px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 6px; font-weight: 700; }
        .header p { opacity: 0.9; }

        .controls { padding: 16px 24px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }
        .control-group { margin-bottom: 16px; }
        .control-label { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 8px; display: block; }
        .patient-selector, .conv-type-selector { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .patient-checkbox, .conv-type-checkbox, .model-checkbox { display: flex; align-items: center; padding: 10px 14px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 500; }
        .patient-checkbox:hover, .conv-type-checkbox:hover, .model-checkbox:hover { border-color: #667eea; background: #f0f4ff; }
        .patient-checkbox.selected, .conv-type-checkbox.selected, .model-checkbox.selected { background: #667eea; color: white; border-color: #667eea; }
        .patient-checkbox input, .conv-type-checkbox input, .model-checkbox input { margin-right: 8px; }
        .select-all-btn, .select-all-patients-btn { padding: 10px 16px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600; }

        .comparison-area { padding: 24px; }
        .no-data { text-align: center; padding: 24px; color: #999; }

        /* å›ºå®šæ¨ªå‘æ’åˆ—ï¼šå·¦ä¾§å¯¹è¯ï¼Œå³ä¾§æ¨¡å‹æ¨ªå‘æ»šåŠ¨ */
        .content-wrapper { display: flex; gap: 20px; align-items: flex-start; }
        .conversation-panel { background: #fff; border: 2px solid #e0e0e0; border-radius: 12px; overflow: hidden; width: 420px; flex: 0 0 420px; }
        .conversation-header { display: flex; align-items: center; gap: 8px; background: #f0f4ff; border-bottom: 2px solid #e0e0e0; padding: 12px 16px; }
        .conversation-icon { font-size: 16px; }
        .chat-messages { padding: 16px; max-height: 700px; overflow-y: auto; }
        .chat-section-title { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; text-align: center; margin: 12px 0 10px; }
        .patient-info-card { background: #f8f9fa; border-left: 4px solid #667eea; padding: 12px; border-radius: 8px; margin: 8px 0; }
        .patient-info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; }
        .patient-info-item { font-size: 13px; color: #555; }

        /* å¯¹è¯æ°”æ³¡æ ·å¼ï¼ˆä¸åŸå¯¹æ¯”é¡µä¸€è‡´ï¼‰ */
        .chat-message { margin-bottom: 14px; display: flex; flex-direction: column; }
        .chat-message.patient { align-items: flex-start; }
        .chat-message.doctor { align-items: flex-end; }
        .chat-avatar { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .chat-content { max-width: 80%; }
        .chat-role { font-size: 12px; color: #666; margin: 0 0 6px 0; }
        .chat-message.patient .chat-role { text-align: left; }
        .chat-message.doctor .chat-role { text-align: right; }
        .chat-bubble { padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.6; display: inline-block; white-space: pre-wrap; word-break: keep-all; overflow-wrap: anywhere; max-width: 80%; }
        .chat-bubble.short { white-space: nowrap !important; word-break: keep-all !important; overflow-wrap: normal !important; }
        .chat-message.patient .chat-bubble { background: #f0f4ff; color: #333; border-bottom-left-radius: 4px; }
        .chat-message.doctor .chat-bubble { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px; margin-left: auto; }

        .criteria-panel { padding: 16px; border-top: 2px dashed #e0e0e0; background: #fafbff; border-radius: 8px; }
        .criteria-title { font-weight: 700; color: #667eea; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; }
        .criteria-title .toggle { font-size: 12px; color: #667eea; opacity: 0.9; transition: transform 0.2s ease; }
        .criteria-panel.collapsed .criteria-title .toggle { transform: rotate(-90deg); }
        .criteria-content { margin-top: 6px; }
        .criteria-panel.collapsed .criteria-content { display: none; }
        .criteria-preview { margin-top: 6px; font-size: 12px; color: #666; background: #fff; border: 1px dashed #e0e0e0; border-radius: 8px; padding: 8px 10px; line-height: 1.6; }
        /* ä»…åœ¨æŠ˜å æ—¶æ˜¾ç¤ºé¢„è§ˆ */
        .criteria-panel:not(.collapsed) .criteria-preview { display: none; }
        .expand-hint { margin-top: 6px; font-size: 12px; color: #999; }
        .criteria-panel:not(.collapsed) .expand-hint { display: none; }
        .criteria-item { margin-bottom: 12px; font-size: 13px; color: #555; }
        .criteria-item strong { color: #333; }
        .criteria-item ul { margin-top: 6px; margin-left: 18px; }
        .criteria-item li { margin: 4px 0; line-height: 1.6; }

        /* å³ä¾§æ¨ªå‘æ»šåŠ¨æ¨¡å‹å¡ç‰‡ */
        .models-container { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 16px; align-items: flex-start; }
        .models-container::-webkit-scrollbar { height: 10px; }
        .models-container::-webkit-scrollbar-thumb { background: #667eea; border-radius: 6px; }
        .model-card { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; overflow: hidden; width: 450px; flex: 0 0 450px; }
        .model-card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 16px; font-weight: 700; }
        .patient-info-bar { background: #f0f4ff; padding: 8px 16px; border-bottom: 2px solid #e0e0e0; display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; }
        .patient-name { color: #667eea; font-weight: 700; }
        .model-card-body { padding: 16px; max-height: 800px; overflow-y: auto; font-size: 14px; line-height: 1.8; color: #333; white-space: normal; }
        .model-card-body h3 { margin: 16px 0 8px; font-size: 16px; color: #667eea; }
        /* æŠ¥å‘Šåˆ†å—å¯¹é½æ ·å¼ */
        .report-block + .report-block { border-top: 2px solid #e0e0e0; margin-top: 14px; padding-top: 14px; }
        .report-block-title { margin: 0 0 8px 0; font-size: 16px; color: #667eea; font-weight: 700; }
        .report-block-content { overflow-y: auto; }

        .rating-panel { background: #fff; border-top: 2px solid #e0e0e0; padding: 12px 16px; }
        .rating-title { font-weight: 700; color: #333; margin-bottom: 8px; }
        .rating-row { display: flex; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px dashed #eee; }
        .rating-row:last-child { border-bottom: none; }
        .rating-label { min-width: 140px; font-size: 13px; color: #555; }
        .stars { display: inline-flex; gap: 6px; cursor: pointer; user-select: none; }
        .star { font-size: 20px; color: #ddd; transition: transform 0.15s; }
        .star.filled { color: #ffc107; text-shadow: 0 0 3px rgba(255,193,7,0.3); }
        .star:hover { transform: scale(1.1); }
        .score-num { font-weight: 700; color: #667eea; min-width: 60px; text-align: right; }
        .total-row { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 2px solid #eee; }
        .total-score { font-size: 18px; font-weight: 800; color: #667eea; }

        @media (max-width: 1200px) { .content-wrapper { grid-template-columns: 1fr; } }

        /* é¡¶éƒ¨å³ä¾§æ‚¬æµ® HUD */
        .hud-floating { position: fixed; right: 20px; top: 20px; z-index: 9999; background: rgba(255,255,255,0.95); border: 2px solid #e0e0e0; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); padding: 12px 14px; min-width: 280px; backdrop-filter: blur(6px); }
        .hud-title { font-weight: 700; font-size: 14px; color: #333; margin-bottom: 8px; }
        .hud-progress { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .hud-bar { flex: 1; height: 8px; background: #f0f0f0; border-radius: 6px; overflow: hidden; }
        .hud-bar-fill { height: 100%; background: linear-gradient(90deg, #52c41a, #73d13d); width: 0%; transition: width 0.3s; }
        .hud-numbers { font-family: monospace; font-weight: 700; color: #667eea; min-width: 80px; text-align: right; }
        .hud-buttons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .hud-btn { padding: 8px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 12px; font-weight: 600; color: #333; transition: all 0.2s; }
        .hud-btn:hover { background: #f0f4ff; border-color: #667eea; color: #667eea; }
        .hud-btn.primary { background: linear-gradient(135deg,#667eea,#764ba2); color: white; border: none; }
        .hud-btn.primary:hover { filter: brightness(1.05); }
        .hud-btn.disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ æ¨¡å‹è¯„æµ‹å¯¹æ¯”ï¼ˆäººå·¥æ‰“åˆ†ï¼‰</h1>
            <p>åŸºäºäººç±»è¯„å®¡çš„ 5 æ˜Ÿè¯„åˆ†ï¼ˆè‡ªåŠ¨æ¢ç®—è‡³æƒé‡åˆ†ï¼‰</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label class="control-label">ğŸ“‹ é€‰æ‹©æ‚£è€… (å¯å¤šé€‰):</label>
                <div class="patient-selector" id="patientSelector"></div>
            </div>

            <!-- æ¨¡å‹ä¸å¯¹è¯ç±»å‹å›ºå®šä¸ºå…¨éƒ¨å±•ç¤ºï¼Œå»é™¤é€‰æ‹©æ§ä»¶ -->
        </div>

        <div class="comparison-area" id="comparisonArea">
            <div class="no-data">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        </div>
    </div>

    <!-- æ‚¬æµ® HUD -->
    <div class="hud-floating" id="hudBox" style="display:none;">
        <div class="hud-title">è¯„æµ‹è¿›åº¦</div>
        <div class="hud-progress">
            <div class="hud-bar"><div class="hud-bar-fill" id="hudBarFill" style="width:0%"></div></div>
            <div class="hud-numbers" id="hudNumbers">0/0 (0%)</div>
        </div>
        <div class="hud-buttons">
            <button class="hud-btn primary" id="hudSubmitBtn" title="æäº¤è¯„åˆ†">æäº¤</button>
            <button class="hud-btn" id="hudExportBtn" title="å¯¼å‡ºè¯„åˆ†ä¸ºCSV">å¯¼å‡º</button>
            <button class="hud-btn" id="hudRulesBtn" title="å±•å¼€/æ”¶èµ·è¯„æµ‹è§„åˆ™">è§„åˆ™</button>
            <button class="hud-btn" id="hudRefreshBtn" title="åˆ·æ–°è¿›åº¦">åˆ·æ–°</button>
            <button class="hud-btn disabled" id="hudDemoBtn" title="æ¼”ç¤ºé¡µé¢ï¼ˆæš‚æœªå®ç°ï¼‰">æ¼”ç¤º</button>
        </div>
    </div>

    <script>
        let comparisonData = null;
        let selectedPatients = new Set();
        let selectedModels = new Set(); // å†…éƒ¨ç»´æŠ¤ä¸ºâ€œå…¨éƒ¨æ¨¡å‹â€ï¼Œä¸æ¸²æŸ“é€‰æ‹©
        let selectedConvTypes = new Set(['1','2','3','4']); // å›ºå®šå››ä¸ªå°èŠ‚
        let evalCriteria = [];

        // é¢œè‰²
        const modelColors = {};
        function getModelColor(model) {
            if (modelColors[model]) return modelColors[model];
            const hue = (model.split('').reduce((a, c) => a + c.charCodeAt(0), 0) % 360);
            const start = `hsl(${hue}, 65%, 65%)`;
            const end = `hsl(${(hue+30)%360}, 65%, 75%)`;
            return modelColors[model] = { start, end };
        }

        // è¯»å– comparison æ•°æ®ï¼ˆç”¨äºæ‚£è€…/æ¨¡å‹åˆ—è¡¨ï¼‰
        async function loadComparison() {
            const res = await fetch('../../output/comparison_data.json');
            if (!res.ok) throw new Error('comparison_data.json åŠ è½½å¤±è´¥');
            comparisonData = await res.json();
        }

        // è¯»å–äººå·¥è¯„æµ‹æŒ‡æ ‡
        async function loadHumanPrompt() {
            const res = await fetch('../../Prompts/PromptForReportTest/human_prompt');
            if (!res.ok) throw new Error('human_prompt åŠ è½½å¤±è´¥');
            const text = await res.text();
            // ç²—ç•¥è§£æ: æå–æ¯ä¸ªâ€œ**X. åç§°â€”â€” æƒé‡ Yåˆ†**â€åŠå…¶åé¢çš„è¦ç‚¹ä½œä¸ºæè¿°
            const lines = text.split('\n');
            const items = [];
            let current = null;
            const headerRe = /^\*\*\s*(\d+)\.\s*([^â€”\-]+)[â€”\-]+\s*æƒé‡\s*(\d+)åˆ†\s*\*\*/;
            lines.forEach(line => {
                const m = line.match(headerRe);
                if (m) {
                    if (current) items.push(current);
                    current = { id: m[1], name: m[2].trim(), weight: parseFloat(m[3]), desc: [] };
                } else if (current) {
                    if (line.trim()) current.desc.push(line);
                }
            });
            if (current) items.push(current);
            evalCriteria = items.map(it => ({
                id: it.id,
                key: it.name,
                name: it.name,
                weight: it.weight,
                description: it.desc.join('\n')
            }));
        }

        // åŸå§‹è¾“å‡ºï¼ˆrawï¼‰åŠ è½½ç¼“å­˜
        const rawCache = {};
        function getRaw(model, patient) {
            if (!rawCache[model]) rawCache[model] = {};
            if (rawCache[model][patient]) return Promise.resolve(rawCache[model][patient]);
            const filename = encodeURIComponent(`${model}-${patient}.json`);
            const url = `../../output/raw/${filename}`;
            return fetch(url)
                .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
                .then(j => (rawCache[model][patient] = j))
                .catch(_ => (rawCache[model][patient] = null));
        }

        // åˆå§‹åŒ–UI
        function initUI() {
            const patientSelector = document.getElementById('patientSelector');
            // æ¨¡å‹ä¸å¯¹è¯ç±»å‹ä¸æ¸²æŸ“é€‰æ‹©æ§ä»¶

            // æ‚£è€…
            const pBtn = document.createElement('button'); pBtn.className='select-all-patients-btn'; pBtn.id='selectAllPatientsBtn'; pBtn.textContent='âœ“ å…¨é€‰æ‚£è€…'; pBtn.onclick=selectAllPatients; patientSelector.appendChild(pBtn);
            comparisonData.patients.forEach(p => {
                const l=document.createElement('label'); l.className='patient-checkbox';
                l.innerHTML=`<input type="checkbox" value="${p}" onchange="togglePatient('${p}', this.checked)"><span>${p}</span>`;
                patientSelector.appendChild(l);
            });

            // æ¨¡å‹å†…éƒ¨å›ºå®šä¸ºå…¨éƒ¨
            comparisonData.models.forEach(m => selectedModels.add(m));

            // é»˜è®¤å…¨é€‰
            comparisonData.patients.forEach(p => selectedPatients.add(p));
            syncPatientCheckboxes();
            // å¯¹è¯ç±»å‹å›ºå®šå››ä¸ªï¼Œå·²é»˜è®¤è®¾ç½®

            updateComparison();
        }

        // é€‰æ‹©å‡½æ•°
        function togglePatient(p, checked){
            if (checked) selectedPatients.add(p); else selectedPatients.delete(p);
            syncPatientCheckboxes();
            updateComparison();
        }
        function selectAllPatients(){
            const all = selectedPatients.size === comparisonData.patients.length;
            selectedPatients.clear();
            if (!all) comparisonData.patients.forEach(p => selectedPatients.add(p));
            syncPatientCheckboxes();
            updateComparison();
        }
        function syncPatientCheckboxes(){
            document.querySelectorAll('.patient-checkbox input').forEach(cb => {
                cb.checked = selectedPatients.has(cb.value);
                cb.parentElement.classList.toggle('selected', cb.checked);
            });
            updateSelectAllPatientsButton();
        }
        function updateSelectAllPatientsButton(){
            const btn = document.getElementById('selectAllPatientsBtn');
            if (!btn || !comparisonData) return;
            const all = selectedPatients.size === comparisonData.patients.length;
            btn.textContent = all ? 'âœ— å–æ¶ˆå…¨é€‰' : 'âœ“ å…¨é€‰æ‚£è€…';
        }
        // ç§»é™¤æ¨¡å‹/å¯¹è¯ç±»å‹é€‰æ‹©é€»è¾‘ï¼ˆå›ºå®šå…¨éƒ¨ï¼‰
        function syncCheck(sel){ document.querySelectorAll(sel).forEach(l=>{ const cb=l.querySelector('input'); if(!cb) return; l.classList.toggle('selected', cb.checked); }); }

        // æ˜Ÿçº§è¯„åˆ†å­˜å‚¨
        function getRatingKey(patient, model){ return `human_eval_${patient}_${model}`; }
        function getRatings(patient, model){ return JSON.parse(localStorage.getItem(getRatingKey(patient, model))||'{}'); }
        function setRating(patient, model, dimKey, stars){ const key=getRatingKey(patient,model); const data=getRatings(patient,model); data[dimKey]=stars; localStorage.setItem(key, JSON.stringify(data)); try{ updateHUD(); }catch(e){} }

        // æ„å»ºå¯¹æ¯”åŒºåŸŸ
        async function updateComparison(){
            const area = document.getElementById('comparisonArea');
            if (selectedPatients.size===0 || selectedModels.size===0 || selectedConvTypes.size===0){ area.innerHTML='<div class="no-data">ğŸ‘† è¯·é€‰æ‹©æ‚£è€…ã€æ¨¡å‹å’Œå¯¹è¯ç±»å‹</div>'; return; }
            area.innerHTML='';

            for (const patient of Array.from(selectedPatients)){
                // æ ‡é¢˜
                const h = document.createElement('h1'); h.style.cssText='font-size:22px;margin:24px 0 16px;color:#667eea;border-bottom:3px solid #667eea;padding-bottom:8px;font-weight:800;'; h.textContent = `ğŸ“‹ ${patient}`; area.appendChild(h);

                const wrapper = document.createElement('div'); wrapper.className='content-wrapper';

                // å¯¹è¯é¢æ¿
                const convPanel = document.createElement('div'); convPanel.className='conversation-panel';
                const chead = document.createElement('div'); chead.className='conversation-header'; chead.innerHTML='<span class="conversation-icon">ğŸ’¬</span><h3>é¢„é—®è¯Šå¯¹è¯è®°å½•</h3>';
                const cmessages = document.createElement('div'); cmessages.className='chat-messages';

                // ä»ä»»æ„æ¨¡å‹è·å– chatï¼ˆrawï¼‰ï¼Œå¹¶è§£ææˆæ°”æ³¡æ ·å¼
                let chatText = null;
                for (const model of Array.from(selectedModels)){
                    const raw = await getRaw(model, patient);
                    if (raw && raw.conversations){
                        const ids = Object.keys(raw.conversations).sort((a,b)=>Number(a)-Number(b));
                        for (const id of ids){ const c = raw.conversations[id]; if (c && c.chat){ chatText=c.chat; break; } }
                        if (chatText) break;
                    }
                }
                if (!chatText) {
                    cmessages.innerHTML = '<div class="no-data">æš‚æ— å¯¹è¯æ•°æ®</div>';
                } else {
                    const messages = parseChatContent(chatText);
                    cmessages.innerHTML = messages.map(msg => {
                        if (msg.type === 'section') {
                            return `<div class="chat-section-title">${escapeHtml(msg.content)}</div>`;
                        } else if (msg.type === 'patient-info') {
                            const items = Object.entries(msg.data).map(([k,v]) => `<div class="patient-info-item"><strong>${escapeHtml(k)}:</strong> ${escapeHtml(v)}</div>`).join('');
                            return `<div class="patient-info-card"><div class="patient-info-grid">${items}</div></div>`;
                        } else {
                            const roleClass = msg.role === 'patient' ? 'patient' : 'doctor';
                            const roleName = msg.role === 'patient' ? 'æ‚£è€…' : 'åŒ»åŠ©';
                            const avatar = msg.role === 'patient' ? 'ğŸ‘¤' : 'ğŸ‘¨â€âš•ï¸';
                            const normalized = normalizeShortLines(msg.content);
                            const plain = normalized.replace(/\s+/g, '');
                            const isShort = plain.length <= 6;
                            const contentHtml = escapeHtml(normalized).replace(/\n/g,'<br>');
                            return `<div class="chat-message ${roleClass}">
                                <div class="chat-avatar">${avatar}</div>
                                <div class="chat-content">
                                    <div class="chat-role">${roleName}</div>
                                    <div class="chat-bubble ${isShort ? 'short' : ''}">${contentHtml}</div>
                                </div>
                            </div>`;
                        }
                    }).join('');
                }

                // æŒ‡æ ‡è¯´æ˜
                const criteriaDiv = document.createElement('div'); criteriaDiv.className='criteria-panel';
                criteriaDiv.innerHTML = `
                    <div class="criteria-title" id="criteriaToggle">ğŸ“‘ è¯„æµ‹æŒ‡æ ‡è¯´æ˜ <span class="toggle">â–¼</span></div>
                    <div class="criteria-preview"></div>
                    <div class="expand-hint">ç‚¹å‡»ä¸Šæ–¹æ ‡é¢˜å±•å¼€æŸ¥çœ‹å®Œæ•´è¯„æµ‹è¦æ±‚</div>
                    <div class="criteria-content">${evalCriteria.map(c => `<div class=\"criteria-item\"><strong>${c.name}ï¼ˆæƒé‡${c.weight}ï¼‰</strong>${renderCriteriaMarkdown(c.description)}</div>`).join('')}</div>
                `;
                // é»˜è®¤å±•å¼€ï¼šå¿½ç•¥å†å²æŠ˜å çŠ¶æ€ï¼Œå¼ºåˆ¶å±•å¼€
                localStorage.setItem('criteria_collapsed', '0');
                // é¢„è§ˆå†…å®¹ï¼šå±•ç¤ºâ€œç»´åº¦ï¼ˆæƒé‡ï¼‰â€ä¸€è¡Œ
                const previewEl = criteriaDiv.querySelector('.criteria-preview');
                previewEl.innerHTML = generateCriteriaPreview(evalCriteria);
                criteriaDiv.querySelector('#criteriaToggle').addEventListener('click', () => {
                    // åŒæ­¥æ‰€æœ‰é¢æ¿ï¼šè‹¥ä»»ä¸€å±•å¼€åˆ™å…¨éƒ¨æ”¶èµ·ï¼›è‹¥éƒ½æ”¶èµ·åˆ™å…¨éƒ¨å±•å¼€
                    const panels = Array.from(document.querySelectorAll('.criteria-panel'));
                    const anyExpanded = panels.some(p => !p.classList.contains('collapsed'));
                    const targetCollapse = anyExpanded; // å±•å¼€â†’å…¨æ”¶èµ·ï¼›æ”¶èµ·â†’å…¨å±•å¼€
                    panels.forEach(p => p.classList.toggle('collapsed', targetCollapse));
                    localStorage.setItem('criteria_collapsed', targetCollapse ? '1' : '0');
                });

                convPanel.appendChild(chead); convPanel.appendChild(cmessages); convPanel.appendChild(criteriaDiv);
                wrapper.appendChild(convPanel);

                // æ¨¡å‹å®¹å™¨
                const modelsDiv = document.createElement('div'); modelsDiv.className='models-container';
                const sortedModels = Array.from(selectedModels).sort();
                for (const model of sortedModels){
                    const raw = await getRaw(model, patient);
                    const sectionTitles = { '1':'ä¸»è¯‰','2':'ç°ç—…å²','3':'æ—¢å¾€å²','4':'å®¶æ—å²' };
                    const modelConvData = [];
                    if (raw && raw.conversations){
                        Object.keys(sectionTitles).forEach(id => {
                            if (!selectedConvTypes.has(id)) return;
                            const conv = raw.conversations[id]; const out = conv && (conv.Output || conv.output);
                            if (out) modelConvData.push({ id, title: sectionTitles[id], output: out });
                        });
                    }
                    const card = buildModelCard(patient, model, modelConvData);
                    modelsDiv.appendChild(card);
                }
                wrapper.appendChild(modelsDiv);
                // å¯¹é½æœ¬æ‚£è€…ä¸‹å„æ¨¡å‹ä¸­ç›¸åŒåˆ†å—çš„é«˜åº¦
                setTimeout(() => alignReportBlocks(modelsDiv), 50);
                area.appendChild(wrapper);
            }
        }

        function buildModelCard(patient, model, modelConvData){
            const card = document.createElement('div'); card.className='model-card';
            const header = document.createElement('div'); header.className='model-card-header'; header.textContent=model; const colors=getModelColor(model); header.style.background=`linear-gradient(135deg, ${colors.start} 0%, ${colors.end} 100%)`;
            const bar = document.createElement('div'); bar.className='patient-info-bar'; bar.innerHTML=`<span class="patient-icon">ğŸ‘¤</span><span>æ‚£è€…ï¼š</span><span class="patient-name">${patient}</span>`;
            const body = document.createElement('div'); body.className='model-card-body';
            // è¾“å‡º
            let html='';
            modelConvData.forEach((d, idx) => { if (idx>0) html+='<div style="border-top:2px solid #e0e0e0;margin:14px 0;"></div>'; html+=`<h3>${d.title}</h3>` + formatOutput(d.output); });
            if (modelConvData.length===0) html='<div class="no-data">è¯¥æ¨¡å‹æš‚æ— åŸå§‹è¾“å‡º</div>';
            body.innerHTML = html;
            // åŒ…è£¹æ¯ä¸ª <h3> ä½œä¸ºä¸€ä¸ªæŠ¥å‘Šåˆ†å—ï¼Œä¾¿äºåç»­å¯¹é½é«˜åº¦
            wrapReportSections(body);

            // è¯„åˆ†
            const rating = document.createElement('div'); rating.className='rating-panel';
            rating.appendChild(Object.assign(document.createElement('div'),{className:'rating-title',textContent:'ğŸ“ è¯„æµ‹æ‰“åˆ†ï¼ˆ5æ˜Ÿåˆ¶ï¼Œè‡ªåŠ¨æ¢ç®—è‡³æƒé‡ï¼‰'}));
            const rows = document.createElement('div');
            const saved = getRatings(patient, model);
            evalCriteria.forEach(c => {
                const row = document.createElement('div'); row.className='rating-row';
                const label = document.createElement('div'); label.className='rating-label'; label.textContent = `${c.name}ï¼ˆæƒé‡${c.weight}ï¼‰`;
                const stars = document.createElement('div'); stars.className='stars';
                const display = document.createElement('div'); display.className='score-num';
                const current = Number(saved[c.name] || 0);
                for (let i=1;i<=5;i++){
                    const s = document.createElement('span'); s.className='star' + (i<=current?' filled':''); s.textContent='â˜…';
                    s.onclick = () => { setRating(patient, model, c.name, i); updateTotals(); };
                    stars.appendChild(s);
                }
                row.appendChild(label); row.appendChild(stars); row.appendChild(display); rows.appendChild(row);
            });
            rating.appendChild(rows);

            const totalRow = document.createElement('div'); totalRow.className='total-row';
            const totalLabel = document.createElement('div'); totalLabel.textContent='æ€»åˆ†ï¼ˆè‡ªåŠ¨æ¢ç®—ï¼‰';
            const totalValue = document.createElement('div'); totalValue.className='total-score'; totalRow.appendChild(totalLabel); totalRow.appendChild(totalValue);
            rating.appendChild(totalRow);

            function updateTotals(){
                // æ›´æ–°æ˜Ÿæ˜Ÿå¡«å……çŠ¶æ€ä¸å•é¡¹åˆ†æ•°æ˜¾ç¤º
                const myRatings = getRatings(patient, model);
                const starRows = rating.querySelectorAll('.rating-row');
                let total = 0;
                starRows.forEach((row, idx) => {
                    const c = evalCriteria[idx]; if (!c) return;
                    const stars = Number(myRatings[c.name] || 0);
                    const starsEls = row.querySelectorAll('.star');
                    starsEls.forEach((el, i) => el.classList.toggle('filled', i < stars));
                    const val = c.weight * (stars/5.0);
                    total += val;
                    const disp = row.querySelector('.score-num');
                    disp.textContent = `${val.toFixed(1)}`;
                });
                totalValue.textContent = `${total.toFixed(1)} / 100`;
            }
            updateTotals();

            card.appendChild(header); card.appendChild(bar); card.appendChild(body); card.appendChild(rating);
            return card;
        }

        function formatOutput(text){ if (!text) return ''; let t=text.replace(/\n/g,'<br>'); t=t.replace(/^### (.+)$/gm,'<h3>$1</h3>'); t=t.replace(/^\*\*(.+?)\*\*:/gm,'<strong>$1:</strong>'); t=t.replace(/^- (.+)$/gm,'â€¢ $1'); t=t.replace(/^\* (.+)$/gm,'â€¢ $1'); return t; }
        function renderCriteriaMarkdown(text){
            if (!text) return '';
            // å…ˆè½¬ä¹‰
            let src = escapeHtml(text);
            const lines = src.split(/\n+/);
            let html=''; let inList=false;
            lines.forEach(line => {
                const l = line.trim(); if (!l) return;
                // å°æ ‡é¢˜ï¼šä»¥â€œæ ¸å¿ƒæ£€æŸ¥ç‚¹ï¼šâ€ç­‰ä½œä¸ºåŠ ç²—
                if (/^\*\*?.+?\*\*?:?$/.test(l) && !l.startsWith('-')){
                    html += `<div style="margin-top:6px;color:#667eea;font-weight:700;">${l.replace(/^\*\*|\*\*$/g,'')}</div>`; return;
                }
                const m = l.match(/^[-â€¢]\s+(.*)$/);
                if (m){ if (!inList){ html += '<ul>'; inList=true; } html += `<li>${m[1]}</li>`; }
                else { if (inList){ html += '</ul>'; inList=false; } html += `<div>${l}</div>`; }
            });
            if (inList) html += '</ul>';
            // åŠ ç²— **text**
            html = html.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
            return html;
        }
        function generateCriteriaPreview(criteria){
            try{
                const weights = criteria.map(c => `${c.name}ï¼ˆ${c.weight}ï¼‰`).join(' Â· ');
                return `<div>${weights}</div>`;
            }catch(e){ return ''; }
        }

        // å°† model-card-body ä¸­çš„æ¯ä¸ª <h3> åˆ°ä¸‹ä¸€ä¸ª <h3> çš„å†…å®¹åŒ…è£…ä¸º .report-block
        function wrapReportSections(bodyEl){
            try{
                const h3s = Array.from(bodyEl.querySelectorAll('h3'));
                if (h3s.length === 0) return;
                h3s.forEach((h3, idx) => {
                    const block = document.createElement('div');
                    block.className = 'report-block';
                    block.setAttribute('data-section', String(idx+1));
                    const title = document.createElement('div');
                    title.className = 'report-block-title';
                    title.textContent = h3.textContent || '';
                    const content = document.createElement('div');
                    content.className = 'report-block-content';
                    // æ”¶é›†æ ‡é¢˜åçš„å…„å¼ŸèŠ‚ç‚¹ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ª h3 æˆ–ç»“æŸ
                    let node = h3.nextSibling;
                    const nodes = [];
                    while (node && !(node.nodeType === 1 && node.tagName === 'H3')){
                        const next = node.nextSibling; nodes.push(node); node = next;
                    }
                    // å°†åŸå§‹èŠ‚ç‚¹ç§»åŠ¨åˆ° content ä¸‹
                    nodes.forEach(n => content.appendChild(n));
                    // ç”¨ block æ›¿æ¢åŸ h3
                    block.appendChild(title); block.appendChild(content);
                    h3.replaceWith(block);
                });
            }catch(e){ console.warn('wrapReportSections failed:', e); }
        }

        // å¯¹é½å‡½æ•°ï¼šå°†åŒä¸€æ‚£è€…ä¸‹å„æ¨¡å‹ä¸­ç›¸åŒåˆ†å—é«˜åº¦è®¾ç½®ä¸ºæœ€å°é«˜åº¦
        function alignReportBlocks(modelsContainer){
            const sectionIds = ['1','2','3','4'];
            sectionIds.forEach(id => {
                const contents = Array.from(modelsContainer.querySelectorAll(`.report-block[data-section="${id}"] .report-block-content`));
                if (contents.length === 0) return;
                contents.forEach(c => c.style.height = 'auto');
                const heights = contents.map(c => c.offsetHeight || c.scrollHeight || 0).filter(h => h>0);
                if (heights.length === 0) return;
                const minH = Math.min.apply(null, heights);
                contents.forEach(c => c.style.height = minH + 'px');
            });
        }
        // è®¡ç®—ä¸æ›´æ–° HUD è¿›åº¦
        function computeCompletion(){
            if (!comparisonData) return {done:0,total:0,percent:0};
            const patients = Array.from(selectedPatients);
            const models = comparisonData.models || [];
            let total = 0, done = 0;
            patients.forEach(p => {
                models.forEach(m => {
                    total += 1;
                    const r = getRatings(p, m) || {};
                    const complete = evalCriteria.every(c => Number(r[c.name]||0) > 0);
                    if (complete) done += 1;
                });
            });
            const percent = total>0 ? Math.round(done*100/total) : 0;
            return {done,total,percent};
        }
        function updateHUD(){
            const hud = document.getElementById('hudBox'); if (!hud) return;
            const {done,total,percent} = computeCompletion();
            const fill = document.getElementById('hudBarFill');
            const num = document.getElementById('hudNumbers');
            if (fill) fill.style.width = `${percent}%`;
            if (num) num.textContent = `${done}/${total} (${percent}%)`;
        }
        function initHUD(){
            const hud = document.getElementById('hudBox'); if (!hud) return;
            hud.style.display = 'block';
            const expBtn = document.getElementById('hudExportBtn'); if (expBtn) expBtn.addEventListener('click', exportHumanRatingsCSV);
            const refBtn = document.getElementById('hudRefreshBtn'); if (refBtn) refBtn.addEventListener('click', updateHUD);
            const ruleBtn = document.getElementById('hudRulesBtn'); if (ruleBtn) ruleBtn.addEventListener('click', toggleAllCriteriaPanels);
            const submitBtn = document.getElementById('hudSubmitBtn'); if (submitBtn) submitBtn.addEventListener('click', submitAllRatings);
        }
        function toggleAllCriteriaPanels(){
            const panels = Array.from(document.querySelectorAll('.criteria-panel'));
            const anyExpanded = panels.some(p => !p.classList.contains('collapsed'));
            const targetCollapse = anyExpanded; // è‹¥æœ‰å±•å¼€åˆ™æ”¶èµ·ï¼›è‹¥éƒ½æ”¶èµ·åˆ™å±•å¼€
            panels.forEach(p => p.classList.toggle('collapsed', targetCollapse));
            localStorage.setItem('criteria_collapsed', targetCollapse ? '1' : '0');
        }
        function exportHumanRatingsCSV(){
            const rows = [];
            const header = ['æ‚£è€…','æ¨¡å‹', ...evalCriteria.map(c=>c.name+'(æ˜Ÿ)'), ...evalCriteria.map(c=>c.name+'(åˆ†)'), 'æ€»åˆ†'];
            rows.push(header);
            const patients = Array.from(selectedPatients);
            const models = comparisonData.models || [];
            patients.forEach(p => {
                models.forEach(m => {
                    const r = getRatings(p,m)||{};
                    const stars = evalCriteria.map(c => Number(r[c.name]||0));
                    const scores = evalCriteria.map((c,i)=> (c.weight * (stars[i]/5)).toFixed(1));
                    const total = scores.reduce((a,b)=> a+Number(b), 0).toFixed(1);
                    rows.push([p,m, ...stars, ...scores, total]);
                });
            });
            const csv = rows.map(row => row.map(cell => {
                const s = String(cell);
                return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
            }).join(',')).join('\n');
            const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download=`äººå·¥è¯„æµ‹_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
        async function submitAllRatings(){
            const patients = Array.from(selectedPatients);
            const models = comparisonData.models || [];
            let count = 0;
            patients.forEach(p => { models.forEach(m => { const key=getRatingKey(p,m)+'_submitted'; localStorage.setItem(key,'1'); count++; }); });
            alert(`âœ… å·²æ ‡è®°æäº¤ ${count} æ¡è¯„åˆ†ï¼ˆæœ¬åœ°ï¼‰`);
            updateHUD();
        }
        function parseChatContent(content){
            const messages=[]; const lines=content.split('\n'); let inDialog=false, inBasic=false; let current=null; let info={};
            for (let raw of lines){ let line=raw.trim(); if (line.startsWith('====')||line.startsWith('----')||line==='') continue;
                if (line.includes('æ‚£è€…åŸºæœ¬ä¿¡æ¯')){ if (current) {messages.push(current); current=null;} inBasic=true; inDialog=false; continue; }
                if (line.includes('é¢„é—®è¯Šå¯¹è¯è®°å½•')){ if (current) {messages.push(current); current=null;} if (Object.keys(info).length>0) messages.push({type:'patient-info', data:info}); messages.push({type:'section', content:'é¢„é—®è¯Šå¯¹è¯è®°å½•'}); inBasic=false; inDialog=true; continue; }
                if (inBasic){ const m=line.match(/^(.+?)[:ï¼š]\s*(.+)$/); if (m){ info[m[1].trim()]=m[2].trim(); } continue; }
                const pm=line.match(/^\d+\.\s*æ‚£è€…:\s*(.+)$/); const dm=line.match(/^\d+\.\s*åŒ»åŠ©:\s*(.+)$/);
                if (pm){ if (current) messages.push(current); current={type:'message', role:'patient', content:pm[1].trim()}; }
                else if (dm){ if (current) messages.push(current); current={type:'message', role:'doctor', content:dm[1].trim()}; }
                else if (current && line){ current.content += '\n' + line; }
            }
            if (current) messages.push(current); return messages;
        }
        function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s||''; return d.innerHTML; }
        function normalizeShortLines(text){
            if(!text) return '';
            const lines=text.split('\n').map(s=>s.trim()).filter(Boolean);
            if(lines.length>=2 && lines.length<=6){
                const total=lines.reduce((a,l)=>a+l.length,0);
                const maxLen=Math.max.apply(null, lines.map(l=>l.length));
                const manySingle=lines.filter(l=>l.length<=2).length>=Math.ceil(lines.length*0.6);
                const allShort=maxLen<=8;
                if((allShort && total<=24) || manySingle){ return lines.join(' ');} 
            }
            return text;
        }

        // å…¥å£
        (async function(){
            try {
                await loadComparison();
                await loadHumanPrompt();
                initUI();
                initHUD();
                updateHUD();
            } catch (e) {
                document.getElementById('comparisonArea').innerHTML = `<div class="no-data">âŒ åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        })();
    </script>
</body>
</html>
