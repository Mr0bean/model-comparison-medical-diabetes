<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯„æµ‹ç³»ç»Ÿç®¡ç†é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 5px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #52c41a, #73d13d);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #f5222d;
            color: white;
        }

        .btn-danger:hover {
            background: #cf1322;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 34, 45, 0.4);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-active {
            background: #d1f4e0;
            color: #0f7c39;
        }

        .badge-used {
            background: #fff3cd;
            color: #856404;
        }

        .badge-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .code-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .code-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .code-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-family: monospace;
            font-weight: 600;
            font-size: 16px;
            border: 2px solid #667eea;
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #333;
        }

        .modal-body {
            padding: 30px;
        }

        .detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-label {
            width: 150px;
            font-weight: 600;
            color: #666;
        }

        .detail-value {
            flex: 1;
            color: #333;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .score-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .score-item-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .score-item-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .auto-refresh-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .completion-rate {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .completion-number {
            font-family: monospace;
            font-weight: 600;
            color: #667eea;
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* çŸ©é˜µè¡¨æ ¼æ ·å¼ */
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
        }

        .matrix-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .matrix-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
        }

        .matrix-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #eee;
        }

        .matrix-table td:first-child {
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 5;
            border-right: 2px solid #ddd;
        }

        .matrix-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .matrix-avg {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
        }

        .matrix-stddev {
            font-size: 11px;
            color: #999;
        }

        .matrix-count {
            font-size: 10px;
            color: #bbb;
        }

        .matrix-empty {
            color: #ccc;
            font-style: italic;
        }

        .matrix-table tr:hover td {
            background: #f8f9fa;
        }

        .matrix-table tr:hover td:first-child {
            background: #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ“Š åŒ»ç–—AIè¯„æµ‹ç³»ç»Ÿ - ç®¡ç†é¢æ¿</h1>
                <p style="color: #666; margin-top: 5px;">å®Œæˆç ç®¡ç†ä¸æ•°æ®ç»Ÿè®¡</p>
            </div>
            <div class="header-controls">
                <div class="auto-refresh-controls">
                    <span>è‡ªåŠ¨åˆ·æ–°:</span>
                    <label class="switch">
                        <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()">
                        <span class="slider"></span>
                    </label>
                    <select id="refreshInterval" onchange="updateRefreshInterval()" style="width: 100px;">
                        <option value="5">5ç§’</option>
                        <option value="10" selected>10ç§’</option>
                        <option value="30">30ç§’</option>
                        <option value="60">1åˆ†é’Ÿ</option>
                        <option value="300">5åˆ†é’Ÿ</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="refreshAll()">ğŸ”„ ç«‹å³åˆ·æ–°</button>
                <button class="btn btn-danger" onclick="showClearDatabaseModal()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®åº“</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-label">æ€»å®Œæˆç æ•°</div>
                <div class="stat-value" id="totalCodes">-</div>
                <div class="stat-subtitle">å·²ç”Ÿæˆçš„å®Œæˆç æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¯ç”¨å®Œæˆç </div>
                <div class="stat-value" id="activeCodes" style="color: #52c41a;">-</div>
                <div class="stat-subtitle">å‰©ä½™å¯ä½¿ç”¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å·²ä½¿ç”¨å®Œæˆç </div>
                <div class="stat-value" id="usedCodes" style="color: #faad14;">-</div>
                <div class="completion-rate">
                    <div class="progress-bar" style="flex: 1;">
                        <div class="progress-fill" id="usedProgress" style="width: 0%;"></div>
                    </div>
                    <span class="completion-number" id="usedPercentage">0%</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å®Œæˆç ä½¿ç”¨ç‡</div>
                <div class="stat-value" id="completionRate" style="color: #1890ff;">-</div>
                <div class="stat-subtitle">å·²ä½¿ç”¨/æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ€»è¯„æµ‹æ•°</div>
                <div class="stat-value" id="totalEvaluations">-</div>
                <div class="stat-subtitle">ç´¯è®¡æäº¤çš„è¯„æµ‹</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¹³å‡åˆ†æ•°</div>
                <div class="stat-value" id="avgScore" style="color: #f5222d;">-</div>
                <div class="stat-subtitle">æ‰€æœ‰è¯„æµ‹çš„å¹³å‡åˆ†</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä»Šæ—¥è¯„æµ‹æ•°</div>
                <div class="stat-value" id="todayEvaluations" style="color: #722ed1;">-</div>
                <div class="stat-subtitle">ä»Šå¤©æäº¤çš„è¯„æµ‹</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ´»è·ƒæ¨¡å‹æ•°</div>
                <div class="stat-value" id="activeModels" style="color: #13c2c2;">-</div>
                <div class="stat-subtitle">å‚ä¸è¯„æµ‹çš„æ¨¡å‹</div>
            </div>
        </div>

        <!-- ç”Ÿæˆå®Œæˆç  -->
        <div class="section">
            <div class="section-title">ğŸ« ç”Ÿæˆæ–°å®Œæˆç </div>
            <div class="input-group">
                <input type="number" id="codeCount" placeholder="ç”Ÿæˆæ•°é‡" value="10" min="1" max="100" style="width: 150px;">
                <input type="text" id="batchDescription" placeholder="æ‰¹æ¬¡è¯´æ˜ï¼ˆå¯é€‰ï¼‰" style="flex: 1;">
                <button class="btn btn-primary" onclick="generateCodes()">ç”Ÿæˆå®Œæˆç </button>
            </div>
            <div class="code-box" id="generatedCodes" style="display: none;">
                <strong>âœ… å·²ç”Ÿæˆå®Œæˆç ï¼š</strong>
                <div class="code-list" id="codeList"></div>
                <button class="btn btn-primary" onclick="copyAllCodes()" style="margin-top: 15px;">ğŸ“‹ å¤åˆ¶æ‰€æœ‰å®Œæˆç </button>
            </div>
        </div>

        <!-- å®Œæˆç åˆ—è¡¨ -->
        <div class="section">
            <div class="section-title">ğŸ“‹ å®Œæˆç åˆ—è¡¨</div>
            <div class="input-group">
                <select id="statusFilter" onchange="loadCodes()">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="active">å¯ç”¨</option>
                    <option value="used">å·²ä½¿ç”¨</option>
                    <option value="expired">å·²è¿‡æœŸ</option>
                </select>
                <button class="btn btn-primary" onclick="loadCodes()">åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="codesTable">
                    <thead>
                        <tr>
                            <th>å®Œæˆç </th>
                            <th>çŠ¶æ€</th>
                            <th>å®Œæˆç‡</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>ä½¿ç”¨æ—¶é—´</th>
                            <th>æ‰¹æ¬¡ID</th>
                            <th>è¯´æ˜</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="codesTableBody">
                        <tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- è¯„æµ‹çŸ©é˜µ -->
        <div class="section">
            <div class="section-title">ğŸ“Š è¯„æµ‹çŸ©é˜µ - æ¨¡å‹Ã—è¯„æµ‹ç‚¹ç»Ÿè®¡</div>
            <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
                æ˜¾ç¤ºæ¯ä¸ªæ¨¡å‹åœ¨æ¯ä¸ªè¯„æµ‹ç‚¹çš„å¹³å‡åˆ†å’Œæ ‡å‡†å·®ï¼ˆæ ¼å¼ï¼šå¹³å‡åˆ† Â± æ ‡å‡†å·®ï¼‰
            </div>
            <div class="input-group">
                <button class="btn btn-primary" onclick="loadEvaluationMatrix()">åˆ·æ–°çŸ©é˜µ</button>
            </div>
            <div id="matrixContainer" style="overflow-x: auto; margin-top: 20px;">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- è¯„æµ‹æ•°æ®åˆ—è¡¨ -->
        <div class="section">
            <div class="section-title">ğŸ“ è¯„æµ‹æ•°æ®</div>
            <div class="input-group">
                <input type="text" id="searchCode" placeholder="æœç´¢å®Œæˆç " style="width: 150px;">
                <input type="text" id="searchPatient" placeholder="æœç´¢æ‚£è€…" style="width: 150px;">
                <input type="text" id="searchModel" placeholder="æœç´¢æ¨¡å‹" style="width: 200px;">
                <button class="btn btn-primary" onclick="loadEvaluations()">æœç´¢</button>
                <button class="btn btn-secondary" onclick="clearSearch()">æ¸…é™¤</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="evaluationsTable">
                    <thead>
                        <tr>
                            <th>å®Œæˆç </th>
                            <th>æ‚£è€…</th>
                            <th>æ¨¡å‹</th>
                            <th>æ€»åˆ†</th>
                            <th>å®Œæˆè¿›åº¦</th>
                            <th>æäº¤æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="evaluationsTableBody">
                        <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ…å¼¹çª— -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ è¯„æµ‹è¯¦æƒ…</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æ¸…ç©ºæ•°æ®åº“ç¡®è®¤å¼¹çª— -->
    <div id="clearDatabaseModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 style="color: #f5222d;">âš ï¸ å±é™©æ“ä½œ</h2>
                <span class="close" onclick="closeClearDatabaseModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="background: #fff3cd; border-left: 4px solid #faad14; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                    <strong>è­¦å‘Šï¼š</strong>æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>æ‰€æœ‰å®Œæˆç è®°å½•</li>
                        <li>æ‰€æœ‰è¯„æµ‹æ•°æ®</li>
                    </ul>
                    <strong style="color: #f5222d;">æ­¤æ“ä½œä¸å¯æ¢å¤ï¼</strong>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                        è¯·è¾“å…¥ <code style="background: #f5f5f5; padding: 2px 8px; border-radius: 4px; color: #f5222d;">clear</code> ä»¥ç¡®è®¤åˆ é™¤ï¼š
                    </label>
                    <input
                        type="text"
                        id="clearConfirmInput"
                        placeholder="è¾“å…¥ clear ç¡®è®¤"
                        style="width: 100%; padding: 10px; border: 2px solid #f5222d; border-radius: 6px;"
                        onkeyup="validateClearInput()"
                    >
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closeClearDatabaseModal()" style="flex: 1;">å–æ¶ˆ</button>
                    <button
                        class="btn btn-danger"
                        id="confirmClearBtn"
                        onclick="confirmClearDatabase()"
                        style="flex: 1;"
                        disabled
                    >ç¡®è®¤æ¸…ç©º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¯å¢ƒé…ç½® -->
    <script src="../static/js/config.js"></script>

    <script>
        const API_BASE = window.API_CONFIG ? window.API_CONFIG.BASE_URL : 'http://localhost:5001/api';
        let autoRefreshInterval = null;
        let currentRefreshSeconds = 10;

        // é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            refreshAll();
        });

        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        function refreshAll() {
            loadStats();
            loadCodes();
            loadEvaluations();
            loadEvaluationMatrix();
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const enabled = document.getElementById('autoRefreshToggle').checked;

            if (enabled) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            stopAutoRefresh(); // å…ˆæ¸…é™¤å·²æœ‰çš„
            const seconds = parseInt(document.getElementById('refreshInterval').value);
            currentRefreshSeconds = seconds;

            autoRefreshInterval = setInterval(() => {
                refreshAll();
                console.log(`è‡ªåŠ¨åˆ·æ–°: ${new Date().toLocaleTimeString()}`);
            }, seconds * 1000);

            console.log(`è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œé—´éš” ${seconds} ç§’`);
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
            }
        }

        // æ›´æ–°åˆ·æ–°é—´éš”
        function updateRefreshInterval() {
            const enabled = document.getElementById('autoRefreshToggle').checked;
            if (enabled) {
                startAutoRefresh();
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`);
                const data = await response.json();

                if (data.success) {
                    // åŸºç¡€ç»Ÿè®¡
                    document.getElementById('totalCodes').textContent = data.codes.total;
                    document.getElementById('activeCodes').textContent = data.codes.active;
                    document.getElementById('usedCodes').textContent = data.codes.used;
                    document.getElementById('totalEvaluations').textContent = data.evaluations.total;

                    // è®¡ç®—ä½¿ç”¨ç‡
                    const usedPercentage = data.codes.total > 0
                        ? ((data.codes.used / data.codes.total) * 100).toFixed(1)
                        : 0;
                    document.getElementById('usedPercentage').textContent = usedPercentage + '%';
                    document.getElementById('usedProgress').style.width = usedPercentage + '%';
                    document.getElementById('completionRate').textContent = usedPercentage + '%';

                    // æ‰©å±•ç»Ÿè®¡
                    document.getElementById('avgScore').textContent =
                        data.evaluations.avgScore ? data.evaluations.avgScore.toFixed(1) : '-';
                    document.getElementById('todayEvaluations').textContent =
                        data.evaluations.todayCount || 0;
                    document.getElementById('activeModels').textContent =
                        data.evaluations.activeModels || 0;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                if (!autoRefreshInterval) {
                    alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨');
                }
            }
        }

        // ç”Ÿæˆå®Œæˆç 
        async function generateCodes() {
            const count = parseInt(document.getElementById('codeCount').value);
            const description = document.getElementById('batchDescription').value;

            if (count < 1 || count > 100) {
                alert('ç”Ÿæˆæ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/generate-codes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count, description })
                });

                const data = await response.json();

                if (data.success) {
                    // æ˜¾ç¤ºç”Ÿæˆçš„å®Œæˆç 
                    const codeList = document.getElementById('codeList');
                    codeList.innerHTML = data.codes.map(code =>
                        `<div class="code-item">${code}</div>`
                    ).join('');

                    document.getElementById('generatedCodes').style.display = 'block';

                    // åˆ·æ–°ç»Ÿè®¡å’Œåˆ—è¡¨
                    refreshAll();

                    alert(`âœ… æˆåŠŸç”Ÿæˆ ${data.count} ä¸ªå®Œæˆç `);
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('ç”Ÿæˆå®Œæˆç å¤±è´¥:', error);
                alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥');
            }
        }

        // å¤åˆ¶æ‰€æœ‰å®Œæˆç 
        function copyAllCodes() {
            const codes = Array.from(document.querySelectorAll('.code-item')).map(el => el.textContent);
            const text = codes.join('\n');

            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… å·²å¤åˆ¶æ‰€æœ‰å®Œæˆç åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }

        // åŠ è½½å®Œæˆç åˆ—è¡¨
        async function loadCodes() {
            const status = document.getElementById('statusFilter').value;

            try {
                const url = new URL(`${API_BASE}/admin/codes`);
                if (status) url.searchParams.append('status', status);

                const response = await fetch(url);
                const data = await response.json();

                const tbody = document.getElementById('codesTableBody');

                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(code => {
                        // ä½¿ç”¨åç«¯è®¡ç®—çš„å®Œæˆç‡ï¼ˆåŸºäº80ä»½è¯„æµ‹ï¼‰
                        const completionRate = code.completionRate || 0;
                        const evaluationCount = code.evaluationCount || 0;
                        const completionRateText = `${completionRate}%`;

                        // æ ¹æ®å®Œæˆç‡è®¾ç½®é¢œè‰²
                        let completionColor = '#999';
                        if (completionRate >= 100) {
                            completionColor = '#52c41a'; // ç»¿è‰²-å·²å®Œæˆ
                        } else if (completionRate > 0) {
                            completionColor = '#faad14'; // æ©™è‰²-è¿›è¡Œä¸­
                        }

                        return `
                            <tr>
                                <td><strong style="font-family: monospace; color: #667eea;">${code.code}</strong></td>
                                <td><span class="badge badge-${code.status}">${getStatusText(code.status)}</span></td>
                                <td>
                                    <div class="completion-rate">
                                        <div class="progress-bar" style="width: 60px;">
                                            <div class="progress-fill" style="width: ${Math.min(completionRate, 100)}%; background: ${completionColor};"></div>
                                        </div>
                                        <span style="font-size: 12px; color: ${completionColor};" title="${evaluationCount}/80ä»½">${completionRateText}</span>
                                    </div>
                                </td>
                                <td>${new Date(code.createdAt).toLocaleString('zh-CN')}</td>
                                <td>${code.usedAt ? new Date(code.usedAt).toLocaleString('zh-CN') : '-'}</td>
                                <td>${code.batchId || '-'}</td>
                                <td>${code.description || '-'}</td>
                                <td>
                                    ${evaluationCount > 0 ?
                                        `<button class="btn btn-small btn-secondary" onclick="viewCodeDetails('${code.code}')">æŸ¥çœ‹è¯¦æƒ…</button>`
                                        : '-'}
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">æš‚æ— æ•°æ®</td></tr>';
                }
            } catch (error) {
                console.error('åŠ è½½å®Œæˆç åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½è¯„æµ‹æ•°æ®
        async function loadEvaluations() {
            const code = document.getElementById('searchCode').value;
            const patient = document.getElementById('searchPatient').value;
            const model = document.getElementById('searchModel').value;

            try {
                const url = new URL(`${API_BASE}/admin/evaluations`);
                if (code) url.searchParams.append('code', code);
                if (patient) url.searchParams.append('patient', patient);
                if (model) url.searchParams.append('model', model);

                const response = await fetch(url);
                const data = await response.json();

                const tbody = document.getElementById('evaluationsTableBody');

                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(eval => {
                        // è®¡ç®—å®Œæˆè¿›åº¦ï¼šæ£€æŸ¥3ä¸ªæ ¸å¿ƒç»´åº¦çš„è¯„åˆ†æ˜¯å¦éƒ½ä¸ä¸º0
                        const scores = eval.scores || {};
                        const coreScores = ['accuracy', 'completeness', 'standard'];
                        let completedCount = 0;

                        coreScores.forEach(dimension => {
                            if (scores[dimension] && scores[dimension].score > 0) {
                                completedCount++;
                            }
                        });

                        const completionPercentage = Math.round((completedCount / coreScores.length) * 100);

                        // æ ¹æ®å®Œæˆåº¦è®¾ç½®é¢œè‰²
                        let progressColor = completionPercentage === 100 ? '#52c41a' : '#faad14';

                        return `
                            <tr>
                                <td><strong style="font-family: monospace;">${eval.code}</strong></td>
                                <td>${eval.patient || '-'}</td>
                                <td>${eval.model || '-'}</td>
                                <td><strong style="color: #667eea; font-size: 18px;">${eval.total_score?.toFixed(1) || '-'}</strong></td>
                                <td>
                                    <div class="completion-rate">
                                        <div class="progress-bar" style="width: 80px;">
                                            <div class="progress-fill" style="width: ${completionPercentage}%; background: ${progressColor};"></div>
                                        </div>
                                        <span style="font-size: 12px; color: ${progressColor};">${completionPercentage}%</span>
                                    </div>
                                </td>
                                <td>${new Date(eval.submittedAt).toLocaleString('zh-CN')}</td>
                                <td><button class="btn btn-small btn-primary" onclick="viewEvaluation('${eval._id}')">æŸ¥çœ‹è¯¦æƒ…</button></td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">æš‚æ— æ•°æ®</td></tr>';
                }
            } catch (error) {
                console.error('åŠ è½½è¯„æµ‹æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ¸…é™¤æœç´¢
        function clearSearch() {
            document.getElementById('searchCode').value = '';
            document.getElementById('searchPatient').value = '';
            document.getElementById('searchModel').value = '';
            loadEvaluations();
        }

        // æŸ¥çœ‹å®Œæˆç è¯¦æƒ…
        async function viewCodeDetails(code) {
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');

            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // è·å–è¯¥å®Œæˆç çš„æ‰€æœ‰è¯„æµ‹
                const url = new URL(`${API_BASE}/admin/evaluations`);
                url.searchParams.append('code', code);

                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    const evaluation = data.data[0];

                    modalBody.innerHTML = `
                        <div class="detail-row">
                            <div class="detail-label">å®Œæˆç :</div>
                            <div class="detail-value"><strong style="font-family: monospace; color: #667eea;">${code}</strong></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">æ‚£è€…:</div>
                            <div class="detail-value">${evaluation.patient || '-'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">æ¨¡å‹:</div>
                            <div class="detail-value">${evaluation.model || '-'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">æ€»åˆ†:</div>
                            <div class="detail-value"><strong style="color: #667eea; font-size: 20px;">${evaluation.total_score?.toFixed(1) || '-'}</strong></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">æäº¤æ—¶é—´:</div>
                            <div class="detail-value">${new Date(evaluation.submittedAt).toLocaleString('zh-CN')}</div>
                        </div>
                        ${evaluation.scores ? `
                            <div style="margin-top: 20px;">
                                <h3 style="margin-bottom: 15px;">ğŸ“Š å„ç»´åº¦è¯„åˆ†</h3>
                                <div class="score-grid">
                                    ${Object.entries(evaluation.scores).map(([key, value]) => {
                                        const score = value.score || value;
                                        const weight = value.weight || 0;
                                        const comment = value.comment || '';
                                        return `
                                        <div class="score-item">
                                            <div class="score-item-label">${getDimensionName(key)}</div>
                                            <div class="score-item-value">${typeof score === 'number' ? score + 'â­' : score}</div>
                                            ${weight > 0 ? `<div style="font-size: 11px; color: #999; margin-top: 4px;">æƒé‡: ${weight}%</div>` : ''}
                                            ${comment ? `<div style="font-size: 12px; color: #666; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; text-align: left;">${comment}</div>` : ''}
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        ` : ''}
                    `;
                } else {
                    modalBody.innerHTML = '<div style="text-align: center; color: #999;">æœªæ‰¾åˆ°ç›¸å…³è¯„æµ‹æ•°æ®</div>';
                }
            } catch (error) {
                console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
                modalBody.innerHTML = '<div style="text-align: center; color: #f5222d;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        // æŸ¥çœ‹è¯„æµ‹è¯¦æƒ…
        async function viewEvaluation(id) {
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('modalBody');

            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/admin/evaluation/${id}`);
                const data = await response.json();

                if (data.success) {
                    const evaluation = data.data;

                    modalBody.innerHTML = `
                        <div class="detail-row">
                            <div class="detail-label">è¯„æµ‹ID:</div>
                            <div class="detail-value"><code>${id}</code></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">å®Œæˆç :</div>
                            <div class="detail-value"><strong style="font-family: monospace; color: #667eea;">${evaluation.code}</strong></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">æ‚£è€…:</div>
                            <div class="detail-value">${evaluation.patient || '-'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">æ¨¡å‹:</div>
                            <div class="detail-value">${evaluation.model || '-'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">æ€»åˆ†:</div>
                            <div class="detail-value"><strong style="color: #667eea; font-size: 24px;">${evaluation.total_score?.toFixed(1) || '-'}</strong></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">æäº¤æ—¶é—´:</div>
                            <div class="detail-value">${new Date(evaluation.submittedAt).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            })}</div>
                        </div>
                        ${evaluation.scores ? `
                            <div style="margin-top: 30px;">
                                <h3 style="margin-bottom: 15px; color: #333;">ğŸ“Š å„ç»´åº¦è¯„åˆ†è¯¦æƒ…</h3>
                                <div class="score-grid">
                                    ${Object.entries(evaluation.scores).map(([key, value]) => {
                                        const score = value.score || value;
                                        const weight = value.weight || 0;
                                        const comment = value.comment || '';
                                        return `
                                        <div class="score-item">
                                            <div class="score-item-label">${getDimensionName(key)}</div>
                                            <div class="score-item-value">${typeof score === 'number' ? score + 'â­' : score}</div>
                                            ${weight > 0 ? `<div style="font-size: 11px; color: #999; margin-top: 4px;">æƒé‡: ${weight}%</div>` : ''}
                                            ${comment ? `<div style="font-size: 12px; color: #666; margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; text-align: left; max-height: 100px; overflow-y: auto;">${comment}</div>` : ''}
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${evaluation.overall_comment ? `
                            <div style="margin-top: 30px;">
                                <h3 style="margin-bottom: 15px; color: #333;">ğŸ’¬ æ€»ä½“è¯„ä»·</h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; line-height: 1.6; white-space: pre-wrap;">
                                    ${evaluation.overall_comment}
                                </div>
                            </div>
                        ` : ''}
                    `;
                } else {
                    modalBody.innerHTML = '<div style="text-align: center; color: #999;">æœªæ‰¾åˆ°è¯„æµ‹æ•°æ®</div>';
                }
            } catch (error) {
                console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
                modalBody.innerHTML = '<div style="text-align: center; color: #f5222d;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const map = {
                'active': 'å¯ç”¨',
                'used': 'å·²ä½¿ç”¨',
                'expired': 'å·²è¿‡æœŸ'
            };
            return map[status] || status;
        }

        // è·å–ç»´åº¦åç§°
        function getDimensionName(key) {
            const map = {
                'accuracy': 'å‡†ç¡®æ€§',
                'completeness': 'å®Œæ•´æ€§',
                'standard': 'è§„èŒƒæ€§',
                'clinical': 'ä¸´åºŠå®ç”¨æ€§',
                'structure': 'ç»“æ„æ¸…æ™°åº¦',
                'language': 'è¯­è¨€ä¸“ä¸šæ€§',
                'format': 'æ ¼å¼è§„èŒƒ',
                'logic': 'é€»è¾‘æ€§',
                'professionalism': 'ä¸“ä¸šæ€§',
                'clarity': 'æ¸…æ™°åº¦'
            };
            return map[key] || key;
        }

        // æ˜¾ç¤ºæ¸…ç©ºæ•°æ®åº“ç¡®è®¤å¼¹çª—
        function showClearDatabaseModal() {
            document.getElementById('clearDatabaseModal').style.display = 'block';
            document.getElementById('clearConfirmInput').value = '';
            document.getElementById('confirmClearBtn').disabled = true;
        }

        // å…³é—­æ¸…ç©ºæ•°æ®åº“å¼¹çª—
        function closeClearDatabaseModal() {
            document.getElementById('clearDatabaseModal').style.display = 'none';
        }

        // éªŒè¯æ¸…ç©ºç¡®è®¤è¾“å…¥
        function validateClearInput() {
            const input = document.getElementById('clearConfirmInput').value;
            const confirmBtn = document.getElementById('confirmClearBtn');
            confirmBtn.disabled = input !== 'clear';
        }

        // ç¡®è®¤æ¸…ç©ºæ•°æ®åº“
        async function confirmClearDatabase() {
            const input = document.getElementById('clearConfirmInput').value;

            if (input !== 'clear') {
                alert('è¯·è¾“å…¥ clear ä»¥ç¡®è®¤åˆ é™¤');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/clear-database`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… æ•°æ®åº“å·²æ¸…ç©º\nåˆ é™¤äº† ${data.deletedCodes} ä¸ªå®Œæˆç \nåˆ é™¤äº† ${data.deletedEvaluations} æ¡è¯„æµ‹è®°å½•`);
                    closeClearDatabaseModal();
                    refreshAll();
                } else {
                    alert('æ¸…ç©ºå¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('æ¸…ç©ºæ•°æ®åº“å¤±è´¥:', error);
                alert('æ¸…ç©ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥');
            }
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­æ¸…ç©ºæ•°æ®åº“å¼¹çª—
        window.addEventListener('click', function(event) {
            const clearModal = document.getElementById('clearDatabaseModal');
            if (event.target == clearModal) {
                closeClearDatabaseModal();
            }
        });

        // åŠ è½½è¯„æµ‹çŸ©é˜µæ•°æ®
        async function loadEvaluationMatrix() {
            const container = document.getElementById('matrixContainer');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/admin/evaluation-matrix`);
                const data = await response.json();

                if (data.success) {
                    const { models, patients, matrix } = data;

                    if (models.length === 0 || patients.length === 0) {
                        container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æš‚æ— è¯„æµ‹æ•°æ®</div>';
                        return;
                    }

                    // æ„å»ºçŸ©é˜µè¡¨æ ¼
                    let tableHTML = '<table class="matrix-table">';

                    // è¡¨å¤´
                    tableHTML += '<thead><tr>';
                    tableHTML += '<th>æ¨¡å‹ / è¯„æµ‹ç‚¹</th>';
                    patients.forEach(patient => {
                        tableHTML += `<th>${patient}</th>`;
                    });
                    tableHTML += '</tr></thead>';

                    // è¡¨ä½“
                    tableHTML += '<tbody>';
                    models.forEach(model => {
                        tableHTML += '<tr>';
                        tableHTML += `<td>${model}</td>`;

                        patients.forEach(patient => {
                            const cellData = matrix[model] && matrix[model][patient];

                            if (cellData && cellData.count > 0) {
                                const avg = cellData.avg.toFixed(1);
                                const stdDev = cellData.stdDev.toFixed(1);
                                const count = cellData.count;

                                tableHTML += `
                                    <td>
                                        <div class="matrix-cell">
                                            <div class="matrix-avg">${avg}</div>
                                            <div class="matrix-stddev">Â± ${stdDev}</div>
                                            <div class="matrix-count">(n=${count})</div>
                                        </div>
                                    </td>
                                `;
                            } else {
                                tableHTML += '<td><span class="matrix-empty">-</span></td>';
                            }
                        });

                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody>';

                    tableHTML += '</table>';

                    container.innerHTML = tableHTML;
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #f5222d; padding: 40px;">åŠ è½½å¤±è´¥: ' + data.message + '</div>';
                }
            } catch (error) {
                console.error('åŠ è½½è¯„æµ‹çŸ©é˜µå¤±è´¥:', error);
                if (!autoRefreshInterval) {
                    container.innerHTML = '<div style="text-align: center; color: #f5222d; padding: 40px;">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨</div>';
                }
            }
        }
    </script>
</body>
</html>
