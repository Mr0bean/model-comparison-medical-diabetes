<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹è¯„åˆ†è¡¨æ ¼ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            font-size: 14px;
        }

        .control-group select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .load-btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .load-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        .scoring-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .scoring-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .scoring-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        .scoring-table td {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }

        .scoring-table tbody tr:hover {
            background: #f8f9fa;
        }

        .model-name {
            font-weight: 600;
            color: #667eea;
            min-width: 150px;
        }

        .output-cell {
            max-width: 400px;
            line-height: 1.6;
            font-size: 12px;
        }

        .score-input {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .score-input input {
            width: 50px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
        }

        .score-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .score-label {
            font-size: 11px;
            color: #666;
        }

        .comment-input {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
            resize: vertical;
        }

        .comment-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .export-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            transition: all 0.3s;
            z-index: 1000;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .avg-score {
            font-weight: 700;
            color: #667eea;
            font-size: 14px;
        }

        .dimension-header {
            text-align: center;
            background: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ¨¡å‹è¯„åˆ†è¡¨æ ¼ç³»ç»Ÿ</h1>
            <p>æ‰¹é‡å¯¹æ¯”è¯„åˆ† - è¡¨æ ¼è§†å›¾</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>é€‰æ‹©æ‚£è€…:</label>
                <select id="patientSelect" onchange="loadTable()">
                    <option value="">-- è¯·é€‰æ‹© --</option>
                </select>
            </div>

            <div class="control-group">
                <label>é€‰æ‹©å¯¹è¯ç±»å‹:</label>
                <select id="convTypeSelect" onchange="loadTable()">
                    <option value="">-- è¯·é€‰æ‹© --</option>
                </select>
            </div>

            <button class="load-btn" onclick="loadTable()">ğŸ”„ åŠ è½½æ•°æ®</button>
        </div>

        <div class="table-container">
            <div id="tableArea" class="no-data">
                ğŸ‘† è¯·é€‰æ‹©æ‚£è€…å’Œå¯¹è¯ç±»å‹
            </div>
        </div>
    </div>

    <button class="export-btn" onclick="exportScores()">ğŸ’¾ å¯¼å‡ºè¯„åˆ†</button>

    <script>
        let comparisonData = null;
        let scoresData = {};

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const response = await fetch('../../output/comparison_data.json');
                comparisonData = await response.json();
                initializeSelectors();
            } catch (error) {
                document.getElementById('tableArea').innerHTML = 
                    '<div class="no-data">âŒ æ•°æ®åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åˆå§‹åŒ–é€‰æ‹©å™¨
        function initializeSelectors() {
            const patientSelect = document.getElementById('patientSelect');
            comparisonData.patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient;
                option.textContent = patient;
                patientSelect.appendChild(option);
            });
        }

        // æ›´æ–°å¯¹è¯ç±»å‹é€‰æ‹©å™¨
        function updateConvTypeSelector(patient) {
            const convTypeSelect = document.getElementById('convTypeSelect');
            convTypeSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';

            if (!patient) return;

            const patientData = comparisonData.data[patient];
            if (!patientData) return;

            Object.keys(patientData).forEach(convId => {
                const convData = patientData[convId];
                let title = 'æœªçŸ¥';
                Object.values(convData).forEach(data => {
                    if (data.title) title = data.title;
                });

                const option = document.createElement('option');
                option.value = convId;
                option.textContent = `${title} (å¯¹è¯ ${convId})`;
                convTypeSelect.appendChild(option);
            });
        }

        // ç›‘å¬æ‚£è€…é€‰æ‹©å˜åŒ–
        document.getElementById('patientSelect').addEventListener('change', function() {
            updateConvTypeSelector(this.value);
        });

        // åŠ è½½è¡¨æ ¼
        function loadTable() {
            const patient = document.getElementById('patientSelect').value;
            const convId = document.getElementById('convTypeSelect').value;
            const tableArea = document.getElementById('tableArea');

            if (!patient || !convId) {
                tableArea.innerHTML = '<div class="no-data">ğŸ‘† è¯·é€‰æ‹©æ‚£è€…å’Œå¯¹è¯ç±»å‹</div>';
                return;
            }

            const patientData = comparisonData.data[patient];
            if (!patientData || !patientData[convId]) {
                tableArea.innerHTML = '<div class="no-data">âš ï¸ æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ•°æ®</div>';
                return;
            }

            const convData = patientData[convId];
            let convTitle = 'æœªçŸ¥';
            Object.values(convData).forEach(data => {
                if (data.title) convTitle = data.title;
            });

            // åˆ›å»ºè¡¨æ ¼
            let tableHTML = `
                <table class="scoring-table">
                    <thead>
                        <tr>
                            <th>æ¨¡å‹</th>
                            <th style="min-width: 350px;">è¾“å‡ºå†…å®¹</th>
                            <th class="dimension-header">å‡†ç¡®æ€§<br>(1-5)</th>
                            <th class="dimension-header">å®Œæ•´æ€§<br>(1-5)</th>
                            <th class="dimension-header">æ ¼å¼è§„èŒƒ<br>(1-5)</th>
                            <th class="dimension-header">è¯­è¨€è¡¨è¾¾<br>(1-5)</th>
                            <th class="dimension-header">é€»è¾‘æ€§<br>(1-5)</th>
                            <th class="dimension-header">å¹³å‡åˆ†</th>
                            <th style="min-width: 200px;">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // æŒ‰æ¨¡å‹åç§°æ’åº
            const models = Object.keys(convData).sort();

            models.forEach(model => {
                const data = convData[model];
                const scoreKey = `${patient}_${convId}_${model}`;

                tableHTML += `
                    <tr>
                        <td class="model-name">${model}</td>
                        <td class="output-cell">${formatOutput(data.output)}</td>
                        <td><input type="number" min="1" max="5" class="score-input" 
                            data-key="${scoreKey}" data-dim="accuracy" 
                            onchange="updateScore(this)" placeholder="-"></td>
                        <td><input type="number" min="1" max="5" class="score-input"
                            data-key="${scoreKey}" data-dim="completeness"
                            onchange="updateScore(this)" placeholder="-"></td>
                        <td><input type="number" min="1" max="5" class="score-input"
                            data-key="${scoreKey}" data-dim="format"
                            onchange="updateScore(this)" placeholder="-"></td>
                        <td><input type="number" min="1" max="5" class="score-input"
                            data-key="${scoreKey}" data-dim="language"
                            onchange="updateScore(this)" placeholder="-"></td>
                        <td><input type="number" min="1" max="5" class="score-input"
                            data-key="${scoreKey}" data-dim="logic"
                            onchange="updateScore(this)" placeholder="-"></td>
                        <td class="avg-score" id="avg_${scoreKey}">-</td>
                        <td><textarea class="comment-input" 
                            data-key="${scoreKey}" 
                            onchange="updateComment(this)" 
                            placeholder="è¯·è¾“å…¥è¯„åˆ†å¤‡æ³¨..."></textarea></td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            tableArea.innerHTML = tableHTML;
        }

        // æ ¼å¼åŒ–è¾“å‡º
        function formatOutput(text) {
            return text.substring(0, 200) + (text.length > 200 ? '...' : '');
        }

        // æ›´æ–°è¯„åˆ†
        function updateScore(input) {
            const key = input.dataset.key;
            const dim = input.dataset.dim;
            const value = parseInt(input.value);

            if (!scoresData[key]) {
                scoresData[key] = { dimensions: {}, comment: '' };
            }

            if (value >= 1 && value <= 5) {
                scoresData[key].dimensions[dim] = value;
            } else {
                delete scoresData[key].dimensions[dim];
            }

            updateAvgScore(key);
        }

        // æ›´æ–°å¹³å‡åˆ†
        function updateAvgScore(key) {
            const avgCell = document.getElementById(`avg_${key}`);
            if (!scoresData[key] || !scoresData[key].dimensions) {
                avgCell.textContent = '-';
                return;
            }

            const scores = Object.values(scoresData[key].dimensions);
            if (scores.length === 0) {
                avgCell.textContent = '-';
                return;
            }

            const avg = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);
            avgCell.textContent = avg;
        }

        // æ›´æ–°è¯„è®º
        function updateComment(textarea) {
            const key = textarea.dataset.key;
            if (!scoresData[key]) {
                scoresData[key] = { dimensions: {}, comment: '' };
            }
            scoresData[key].comment = textarea.value;
        }

        // å¯¼å‡ºè¯„åˆ†
        function exportScores() {
            if (Object.keys(scoresData).length === 0) {
                alert('âš ï¸ è¿˜æ²¡æœ‰ä»»ä½•è¯„åˆ†æ•°æ®ï¼è¯·å…ˆè¿›è¡Œè¯„åˆ†ã€‚');
                return;
            }

            const exportData = [];

            Object.keys(scoresData).forEach(key => {
                const [patient, convId, model] = key.split('_');
                const score = scoresData[key];

                const scores = Object.values(score.dimensions);
                const avgScore = scores.length > 0 ? 
                    (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2) : 0;

                exportData.push({
                    'æ‚£è€…': patient,
                    'å¯¹è¯ID': convId,
                    'æ¨¡å‹': model,
                    'å‡†ç¡®æ€§': score.dimensions.accuracy || '',
                    'å®Œæ•´æ€§': score.dimensions.completeness || '',
                    'æ ¼å¼è§„èŒƒ': score.dimensions.format || '',
                    'è¯­è¨€è¡¨è¾¾': score.dimensions.language || '',
                    'é€»è¾‘æ€§': score.dimensions.logic || '',
                    'å¹³å‡åˆ†': avgScore,
                    'å¤‡æ³¨': score.comment || ''
                });
            });

            const csv = convertToCSV(exportData);
            downloadCSV(csv, `æ¨¡å‹è¯„åˆ†è¡¨æ ¼_${new Date().toISOString().split('T')[0]}.csv`);

            alert(`âœ… è¯„åˆ†æ•°æ®å¯¼å‡ºæˆåŠŸï¼\nå…±å¯¼å‡º ${exportData.length} æ¡è¯„åˆ†è®°å½•ã€‚`);
        }

        // è½¬æ¢ä¸ºCSV
        function convertToCSV(data) {
            if (data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvRows = [];

            csvRows.push('\ufeff' + headers.join(','));

            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header];
                    if (typeof value === 'string' && (value.includes(',') || value.includes('\n') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });

            return csvRows.join('\n');
        }

        // ä¸‹è½½CSV
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        loadData();
    </script>
</body>
</html>
