# 🚀 快速上手：多模型对比系统

## ✨ 核心功能

一键对比多个AI模型的输出差异，帮助您选择最佳模型！

```
输入：患者问答记录 + 多个Prompt
  ↓
处理：同时使用多个模型（如 gpt-4o-mini, gpt-5.1）
  ↓
输出：详细的对比报告
  - 横向对比各模型输出
  - 性能指标统计
  - 每个模型的独立报告
```

## 📦 三步开始

### 1️⃣ 快速测试（推荐）

```bash
# 只需一行命令！
python batch_process_multi_model_test.py
```

**结果：**
- ✅ 2个模型对比（gpt-4o-mini vs gpt-5.1）
- ✅ 2个患者 × 5个Prompt = 20个任务
- ✅ 约1.5分钟完成
- ✅ 生成4种报告

### 2️⃣ 查看报告

```bash
# 查看目录
ls 模型对比报告_测试/

# 查看性能对比
cat 模型对比报告_测试/性能对比_*.txt

# 查看模型输出对比
cat 模型对比报告_测试/模型对比报告_*.txt
```

### 3️⃣ 完整对比（4个模型）

```bash
# 对比更多模型
python batch_process_multi_model.py
```

**结果：**
- ✅ 4个模型对比（gpt-3.5-turbo, gpt-4o-mini, gpt-4o, gpt-5.1）
- ✅ 2个患者 × 5个Prompt × 4模型 = 40个任务
- ✅ 约3-4分钟完成

## 📊 报告示例

### 性能对比报告

```
模型                   总任务      成功       平均耗时(秒)      平均输出长度
--------------------------------------------------------------------
gpt-4o-mini          10       10       4.49          147
gpt-5.1              10       10       5.24          184
```

**发现：**
- gpt-4o-mini 更快（快15%）
- gpt-5.1 输出更详细（多25%）

### 模型输出对比示例

**【主诉】对比：**

```
>>> 模型: gpt-4o-mini (4.12秒, 54字符)
主诉：小便泡沫多，持续时间长。糖尿病确诊12年以上，血糖不稳定...

>>> 模型: gpt-5.1 (3.61秒, 24字符)
发现血糖升高12余年，空腹血糖升高伴体重下降5月
```

**对比分析：**
- ✅ gpt-5.1 更符合医学术语规范
- ✅ gpt-4o-mini 更详细但略显口语化
- ✅ gpt-5.1 响应速度更快

## 🎯 关键差异对比

基于实际测试，两个模型的主要差异：

| 维度 | gpt-4o-mini | gpt-5.1 | 推荐场景 |
|------|-------------|---------|----------|
| **响应速度** | ⚡️ 快（4.49秒） | 稍慢（5.24秒） | 高并发 → gpt-4o-mini |
| **输出长度** | 适中（147字） | 更长（184字） | 详细报告 → gpt-5.1 |
| **医学规范** | ★★★☆☆ | ★★★★★ | 专业病历 → gpt-5.1 |
| **简洁性** | ★★★★☆ | ★★★☆☆ | 快速摘要 → gpt-4o-mini |
| **稳定性** | 100% | 100% | 两者都很稳定 |

## 🔍 具体输出对比

### 案例1：主诉生成

**患者情况：** 糖尿病12年，小便泡沫多

| 模型 | 输出 | 评价 |
|------|------|------|
| gpt-4o-mini | "主诉：小便泡沫多，持续时间长。糖尿病确诊12年以上，血糖不稳定..." | ❌ 包含过多信息，不符合主诉简洁性要求 |
| gpt-5.1 | "发现血糖升高12余年，空腹血糖升高伴体重下降5月" | ✅ 简洁规范，符合医学主诉格式 |

**结论：** 主诉生成推荐使用 **gpt-5.1**

### 案例2：现病史生成

**患者情况：** 糖尿病患者，用药复杂

| 模型 | 输出长度 | 详细程度 | 规范性 |
|------|----------|----------|--------|
| gpt-4o-mini | 246字 | ★★★☆☆ | ★★★☆☆ |
| gpt-5.1 | 346字 | ★★★★★ | ★★★★★ |

**示例对比：**

```
gpt-4o-mini:
"患者于12年前自觉小便泡沫增多，遂至医院检查发现空腹血糖升高，
诊断为糖尿病，给予口服降糖药物治疗。目前正在服用..."

gpt-5.1:
"患者于12年前自觉小便泡沫增多，因母亲、舅舅及哥哥均有糖尿病史，
遂至医院就诊，查血糖升高，诊断为2型糖尿病。起病时未述明显口干、
多饮、多尿及体重下降。此后长期口服降糖药物及应用胰岛素治疗..."
```

**结论：** 现病史推荐使用 **gpt-5.1**（更详细、更规范）

### 案例3：既往史生成

**患者情况：** 既往有高甘油三酯

| 模型 | 输出 | 评价 |
|------|------|------|
| gpt-4o-mini | "**即往史：**<br>- 既往有高甘油三酯史...<br>- 无高血压史..." | ⚠️ 格式化过度（带Markdown） |
| gpt-5.1 | "既往有高甘油三酯血症，具体发病时间不详，目前未规律口服调脂药物治疗。" | ✅ 纯文本，符合病历格式 |

**结论：** 既往史推荐使用 **gpt-5.1**

## 💡 选择建议

### 推荐配置

**方案A：质量优先（推荐用于正式病历）**
```python
MODELS = ["gpt-5.1"]  # 或 gpt-4o
```
- ✅ 医学术语规范
- ✅ 输出详细完整
- ✅ 格式标准
- ❌ 速度稍慢
- ❌ 成本较高

**方案B：速度优先（推荐用于快速预览）**
```python
MODELS = ["gpt-4o-mini"]
```
- ✅ 响应速度快
- ✅ 成本低
- ✅ 基本信息完整
- ❌ 医学规范性稍弱
- ❌ 输出较简略

**方案C：对比验证（推荐用于重要病例）**
```python
MODELS = ["gpt-4o-mini", "gpt-5.1"]
```
- ✅ 两个模型互相验证
- ✅ 可选择最佳输出
- ✅ 发现模型差异
- ❌ 耗时翻倍
- ❌ 成本翻倍

## 📈 性能优化建议

### 1. 减少处理时间

```python
# 方法1：只测试关键Prompt
Prompts = ["主诉", "现病史"]  # 只保留最重要的

# 方法2：减少模型数量
MODELS = ["gpt-5.1"]  # 只用最好的

# 方法3：批量处理时分批
# 先处理紧急患者，再处理其他
```

### 2. 提高输出质量

```python
# 使用质量更高的模型
MODELS = ["gpt-4o", "gpt-5.1"]

# 调整max_tokens
max_tokens=3000  # 允许更长的输出
```

## 🎓 高级用法

### 自定义模型列表

```python
# 创建自己的测试脚本
from batch_process_multi_model import MultiModelBatchProcessor

MODELS = [
    "gpt-4o-mini",      # 快速
    "gpt-5.1",          # 质量
    # "gpt-4o",         # 可选：平衡
    # "claude-3-sonnet" # 可选：如果API支持
]

processor = MultiModelBatchProcessor(
    prompts_file="多个Prompt.json",
    records_dir="测试输入问答记录",
    output_dir="我的对比报告",
    models=MODELS
)

await processor.run()
```

### 分析特定Prompt

```bash
# 只查看"主诉"的对比
grep -A 15 "【主诉】" 模型对比报告_测试/模型对比报告_*.txt
```

### 导出数据到Excel

```python
import pandas as pd
import json

with open('完整报告_xxx.json') as f:
    data = json.load(f)

# 提取性能数据
perf_data = []
for patient in data:
    for model, stats in patient['model_stats'].items():
        perf_data.append({
            '患者': patient['patient_name'],
            '模型': model,
            '成功数': stats['success'],
            '平均耗时': stats['avg_time']
        })

df = pd.DataFrame(perf_data)
df.to_excel('性能对比.xlsx', index=False)
```

## 🐛 故障排查

### 问题1：API调用失败

**症状：** 某个模型一直报错

**解决：**
```bash
# 查看详细错误
cat batch_process_multi_model.log | grep ERROR

# 临时移除有问题的模型
# 编辑脚本，注释掉该模型
```

### 问题2：输出为空

**症状：** 某些输出是空的

**原因：** 可能是max_tokens设置太小

**解决：**
```python
# 增加max_tokens
max_tokens=3000  # 从2000增加到3000
```

### 问题3：处理太慢

**症状：** 等待时间太长

**解决：**
```python
# 方法1：只测试1个患者
# 临时移动其他患者文件到别的目录

# 方法2：减少模型数量
MODELS = ["gpt-5.1"]  # 只用一个模型

# 方法3：减少Prompt数量
# 只保留最重要的Prompt
```

## 📚 完整文档

更详细的说明请查看：
- 📖 `多模型对比使用说明.md` - 完整使用手册
- 📖 `BATCH_PROCESS_README.md` - 单模型批处理说明

## 🎉 总结

### 测试结果总结

基于2个患者、5个Prompt的测试：

| 模型 | 综合评分 | 推荐场景 |
|------|---------|----------|
| **gpt-5.1** | ⭐️⭐️⭐️⭐️⭐️ | 正式病历、医学文档 |
| **gpt-4o-mini** | ⭐️⭐️⭐️⭐️ | 快速预览、大批量处理 |

### 最佳实践

1. **首次使用**：运行测试版本熟悉功能
2. **正式使用**：使用gpt-5.1生成正式病历
3. **批量处理**：使用gpt-4o-mini快速处理大量数据
4. **质量检查**：对重要病例同时使用两个模型对比验证

### 下一步

- [ ] 运行快速测试
- [ ] 查看各类报告
- [ ] 分析模型差异
- [ ] 选择最适合的模型
- [ ] 应用到生产环境

**开始使用：**
```bash
python batch_process_multi_model_test.py
```

祝您使用愉快！🎊
