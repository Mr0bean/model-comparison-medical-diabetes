# 部署检查清单

在执行部署前，请确认以下事项：

## 部署前检查 (Pre-Deployment)

### 服务器环境
- [ ] 服务器可通过 SSH 访问
- [ ] 服务器已安装 Node.js 14+
- [ ] 服务器已安装 MongoDB 4.4+
- [ ] 服务器已安装 Nginx
- [ ] 服务器已安装 PM2
- [ ] MongoDB 服务正在运行
- [ ] Nginx 服务正在运行

### 本地准备
- [ ] 已测试本地开发环境正常运行
- [ ] 已更新 server/.env.production 配置
- [ ] 已验证 config.js 中的域名配置
- [ ] deploy.sh 具有执行权限 (`chmod +x deploy.sh`)
- [ ] 已备份当前数据库（如有）

### 配置文件检查
- [ ] server/.env.production - MongoDB URI 正确
- [ ] server/.env.production - PORT 设置为 5001
- [ ] nginx.conf - server_name 为 ruan.etodo.top
- [ ] ecosystem.config.js - 进程配置正确
- [ ] config.js - 生产环境 API 地址正确

## 部署执行 (Deployment)

### 自动部署
- [ ] 执行 `./deploy.sh`
- [ ] 观察部署输出，无错误信息
- [ ] SSH 连接成功
- [ ] 文件上传完成
- [ ] 依赖安装完成
- [ ] PM2 启动成功
- [ ] Nginx 配置重载成功

### 手动部署（如自动失败）
- [ ] 文件上传: `rsync` 或 `scp`
- [ ] 后端依赖: `npm install --production`
- [ ] PM2 启动: `pm2 start ecosystem.config.js`
- [ ] Nginx 配置: 复制并启用
- [ ] Nginx 测试: `nginx -t`
- [ ] Nginx 重载: `systemctl reload nginx`

## 部署后验证 (Post-Deployment)

### 服务状态检查
```bash
# 在服务器上执行
- [ ] `pm2 status` - medical-evaluation-api 显示 online
- [ ] `systemctl status nginx` - active (running)
- [ ] `systemctl status mongod` - active (running)
```

### API 功能测试
```bash
# 从本地或服务器执行
- [ ] `curl http://ruan.etodo.top/api/admin/stats` - 返回 JSON
- [ ] `curl -I http://ruan.etodo.top` - 返回 200
- [ ] `curl http://ruan.etodo.top/api/verify-code/test` - API 正常响应
```

### 前端功能测试
- [ ] http://ruan.etodo.top - 主页加载
- [ ] http://ruan.etodo.top/model_evaluation_chat.html - 评测页面加载
- [ ] http://ruan.etodo.top/admin.html - 管理页面加载
- [ ] 浏览器控制台无 CORS 错误
- [ ] API 请求成功（检查 Network 标签）
- [ ] 完成码验证功能正常
- [ ] 评测提交功能正常

### 数据库检查
```bash
# 在服务器上执行
- [ ] `mongosh medical_evaluation --eval "db.stats()"` - 数据库存在
- [ ] `mongosh medical_evaluation --eval "show collections"` - 集合显示
```

### 日志检查
```bash
# 在服务器上执行
- [ ] `pm2 logs medical-evaluation-api --lines 20` - 无错误日志
- [ ] `tail -20 /var/log/nginx/error.log` - 无严重错误
- [ ] `tail -20 /var/log/nginx/access.log` - 有访问记录
```

## 安全加固 (Security)

### HTTPS 配置（推荐）
- [ ] 安装 Certbot
- [ ] 获取 SSL 证书: `certbot --nginx -d ruan.etodo.top`
- [ ] 测试 HTTPS 访问
- [ ] 配置自动续期

### 防火墙配置
- [ ] 只开放必要端口 (80, 443, SSH)
- [ ] 配置 UFW 或 iptables
- [ ] 测试防火墙规则

### MongoDB 安全
- [ ] 启用 MongoDB 认证（生产环境必须）
- [ ] 创建数据库用户
- [ ] 限制 MongoDB 只监听 localhost

## 监控和维护 (Monitoring)

### 设置监控
- [ ] PM2 开机自启: `pm2 startup`
- [ ] PM2 保存当前进程: `pm2 save`
- [ ] 配置日志轮转

### 备份策略
- [ ] 创建数据库备份脚本
- [ ] 配置 crontab 定时备份
- [ ] 测试备份恢复流程

### 文档更新
- [ ] 记录服务器 IP 地址
- [ ] 记录管理员账号信息
- [ ] 记录完成码生成记录
- [ ] 更新团队文档

## 回滚计划 (Rollback)

如果部署失败，执行：
- [ ] 还原 Nginx 配置
- [ ] 停止新版本 PM2 进程
- [ ] 恢复数据库备份（如需要）
- [ ] 重新部署旧版本

## 完成确认

- [ ] 所有功能测试通过
- [ ] 性能表现正常
- [ ] 无错误日志
- [ ] 团队成员已通知
- [ ] 用户可以正常访问

---

**部署日期**: _______________
**部署人员**: _______________
**版本号**: _______________
**备注**: _______________

## 应急联系

- 服务器提供商: _______________
- MongoDB 技术支持: _______________
- 团队负责人: _______________
