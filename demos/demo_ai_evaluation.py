#!/usr/bin/env python3
"""
AIè‡ªåŠ¨è¯„æµ‹æ¼”ç¤ºè„šæœ¬
åŸºäºç”¨æˆ·è¯„æµ‹æ ‡å‡†ï¼Œä½¿ç”¨DeepSeek Reasonerè¿›è¡Œç—…å†æ‘˜è¦è‡ªåŠ¨è¯„åˆ†
"""

import json
import os
from openai import OpenAI
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# è·å–APIé…ç½®
DEEPSEEK_API_KEY = os.getenv('DEEPSEEK_API_KEY')
DEEPSEEK_BASE_URL = os.getenv('DEEPSEEK_BASE_URL', 'https://api.deepseek.com')

# ç¤ºä¾‹å¯¹è¯
SAMPLE_CONVERSATION = """
åŒ»ç”Ÿï¼šæ‚¨å¥½ï¼Œè¯·é—®æ‚¨æœ‰ä»€ä¹ˆä¸èˆ’æœå—ï¼Ÿ
æ‚£è€…ï¼šåŒ»ç”Ÿæ‚¨å¥½ï¼Œæˆ‘æœ€è¿‘æ€»æ˜¯æ„Ÿè§‰å£æ¸´ï¼Œå–æ°´ç‰¹åˆ«å¤šï¼Œè€Œä¸”ä¸Šå•æ‰€ä¹Ÿå¾ˆé¢‘ç¹ã€‚
åŒ»ç”Ÿï¼šè¿™ç§æƒ…å†µæŒç»­å¤šä¹…äº†ï¼Ÿ
æ‚£è€…ï¼šå¤§æ¦‚æœ‰3ä¸ªæœˆäº†ã€‚
åŒ»ç”Ÿï¼šä¹‹å‰æœ‰æ£€æŸ¥è¿‡è¡€ç³–å—ï¼Ÿ
æ‚£è€…ï¼šå»å¹´10æœˆä½“æ£€çš„æ—¶å€™æŸ¥è¿‡ï¼Œç©ºè…¹è¡€ç³–æ˜¯7.2ï¼ŒåŒ»ç”Ÿè¯´æœ‰ç‚¹é«˜ã€‚
åŒ»ç”Ÿï¼šé‚£å½“æ—¶æœ‰å¼€å§‹æ²»ç–—å—ï¼Ÿ
æ‚£è€…ï¼šæ²¡æœ‰ï¼ŒåŒ»ç”Ÿè¯´è®©æˆ‘å…ˆæ§åˆ¶é¥®é£Ÿï¼Œå¤šè¿åŠ¨ã€‚ä½†æˆ‘å·¥ä½œå¤ªå¿™ï¼Œä¸€ç›´æ²¡æ€ä¹ˆæ³¨æ„ã€‚
åŒ»ç”Ÿï¼šæ‚¨ç°åœ¨æœ‰åœ¨åƒä»€ä¹ˆè¯å—ï¼Ÿ
æ‚£è€…ï¼šæ²¡æœ‰åƒè¯ã€‚
åŒ»ç”Ÿï¼šå®¶é‡Œæœ‰äººå¾—ç³–å°¿ç—…å—ï¼Ÿ
æ‚£è€…ï¼šæˆ‘çˆ¸çˆ¸æœ‰ç³–å°¿ç—…ï¼Œå·²ç»åƒè¯10å¤šå¹´äº†ã€‚
åŒ»ç”Ÿï¼šæ‚¨æœ‰é«˜è¡€å‹å—ï¼Ÿ
æ‚£è€…ï¼šæœ‰çš„ï¼Œ3å¹´å‰æŸ¥å‡ºæ¥çš„ï¼Œç°åœ¨åœ¨åƒé™å‹è¯ã€‚
åŒ»ç”Ÿï¼šè¡€å‹æ§åˆ¶å¾—æ€ä¹ˆæ ·ï¼Ÿ
æ‚£è€…ï¼šè¿˜å¯ä»¥ï¼Œä¸€èˆ¬æ˜¯130/85å·¦å³ã€‚
åŒ»ç”Ÿï¼šå¥½çš„ï¼Œæˆ‘ç»™æ‚¨æµ‹ä¸€ä¸‹è¡€ç³–ã€‚
æ‚£è€…ï¼šå¥½çš„ã€‚
åŒ»ç”Ÿï¼šæ‚¨çš„éšæœºè¡€ç³–æ˜¯12.5ï¼Œç¡®å®åé«˜äº†ã€‚æˆ‘å»ºè®®æ‚¨åšä¸€ä¸ªè¯¦ç»†çš„æ£€æŸ¥ï¼ŒåŒ…æ‹¬ç³–åŒ–è¡€çº¢è›‹ç™½å’Œå…¶ä»–æŒ‡æ ‡ã€‚
æ‚£è€…ï¼šå¥½çš„ï¼Œé‚£æˆ‘éœ€è¦åƒè¯å—ï¼Ÿ
åŒ»ç”Ÿï¼šæ ¹æ®æ‚¨çš„æƒ…å†µï¼Œå¯èƒ½éœ€è¦å¼€å§‹è¯ç‰©æ²»ç–—ã€‚æˆ‘å…ˆç»™æ‚¨å¼€äºŒç”²åŒèƒï¼Œä»å°å‰‚é‡å¼€å§‹ï¼Œ500mgæ¯å¤©ä¸¤æ¬¡ï¼Œæ—©æ™šé¥­åæœç”¨ã€‚
æ‚£è€…ï¼šå¥½çš„ï¼Œè°¢è°¢åŒ»ç”Ÿã€‚
"""

# ä¼˜è´¨ç—…å†æ‘˜è¦
GOOD_RECORD = """
ä¸»è¯‰ï¼šå£æ¸´ã€å¤šé¥®ã€å¤šå°¿3ä¸ªæœˆ

ç°ç—…å²ï¼šæ‚£è€…3ä¸ªæœˆå‰æ— æ˜æ˜¾è¯±å› å‡ºç°å£æ¸´ã€å¤šé¥®ã€å¤šå°¿ç—‡çŠ¶ã€‚å»å¹´10æœˆä½“æ£€å‘ç°ç©ºè…¹è¡€ç³–7.2mmol/Lï¼ŒåŒ»ç”Ÿå»ºè®®æ§åˆ¶é¥®é£Ÿå’Œè¿åŠ¨ï¼Œæ‚£è€…æœªäºˆé‡è§†ï¼Œæœªè¿›è¡Œè¯ç‰©æ²»ç–—ã€‚è¿‘æœŸä¸Šè¿°ç—‡çŠ¶æŒç»­å­˜åœ¨ã€‚ä»Šæ—¥å°±è¯Šï¼Œéšæœºè¡€ç³–12.5mmol/Lï¼Œæ‹Ÿè¯Šæ–­ä¸ºç³–å°¿ç—…ã€‚ç°äºˆäºŒç”²åŒèƒç‰‡500mgæ¯æ—¥2æ¬¡æ—©æ™šé¤åå£æœæ²»ç–—ã€‚

æ—¢å¾€å²ï¼š3å¹´å‰è¯Šæ–­é«˜è¡€å‹ï¼Œç›®å‰å£æœé™å‹è¯æ²»ç–—ï¼Œè¡€å‹æ§åˆ¶åœ¨130/85mmHgå·¦å³ã€‚å¦è®¤å† å¿ƒç—…ã€é«˜è¡€è„‚ç—…å²ã€‚

å®¶æ—å²ï¼šçˆ¶äº²æ‚£2å‹ç³–å°¿ç—…10ä½™å¹´ï¼Œè¯ç‰©æ²»ç–—ä¸­ã€‚

ä¸ªäººå²ï¼šå·¥ä½œç¹å¿™ï¼Œç¼ºä¹è¿åŠ¨ã€‚å¦è®¤å¸çƒŸã€é¥®é…’å²ã€‚
"""

# é—®é¢˜ç—…å†æ‘˜è¦ï¼ˆåŒ…å«å¤šå¤„é”™è¯¯ï¼‰
BAD_RECORD = """
ä¸»è¯‰ï¼šå£æ¸´ã€å°¿å¤š3ä¸ªæœˆ

ç°ç—…å²ï¼šæ‚£è€…3ä¸ªæœˆå‰å¼€å§‹å£æ¸´ï¼Œå–æ°´å¤šï¼Œä¸Šå•æ‰€æ¬¡æ•°å¢åŠ ã€‚å»å¹´ä½“æ£€è¡€ç³–7.2ï¼Œæœ‰ç‚¹é«˜ã€‚æœ€è¿‘è¿˜æ˜¯è¿™æ ·ã€‚ä»Šå¤©æ¥çœ‹ç—…ï¼Œè¡€ç³–12.5ã€‚åŒ»ç”Ÿå¼€äº†äºŒç”²åŒèƒï¼Œä¸€å¤©ä¸¤æ¬¡ã€‚

æ—¢å¾€å²ï¼šé«˜è¡€å‹3å¹´ï¼Œç³–å°¿ç—…å»å¹´å‘ç°ã€‚åƒé™å‹è¯ï¼Œè¡€å‹130/85ã€‚

å®¶æ—å²ï¼šçˆ¸çˆ¸æœ‰ç³–å°¿ç—…ï¼Œåƒè¯å¾ˆå¤šå¹´äº†ã€‚

ä¸ªäººå²ï¼šå·¥ä½œå¿™ï¼Œæ²¡æ—¶é—´è¿åŠ¨ã€‚
"""

# è¯„æµ‹Promptï¼ˆç®€åŒ–ç‰ˆï¼‰
EVALUATION_PROMPT_TEMPLATE = """
ã€è¯„æµ‹ä»»åŠ¡ã€‘
è¯·æ ¹æ®ä»¥ä¸‹åŸå§‹åŒ»æ‚£å¯¹è¯å’ŒAIç”Ÿæˆçš„ç—…å†æ‘˜è¦ï¼Œä¸¥æ ¼æŒ‰ç…§è¯„åˆ†æ ‡å‡†è¿›è¡Œæ‰“åˆ†ã€‚

ã€åŸå§‹å¯¹è¯ã€‘
{conversation}

ã€ç—…å†æ‘˜è¦ã€‘
{medical_record}

ã€è¯„åˆ†æ ‡å‡†ã€‘

ä¸€ã€å‡†ç¡®æ€§ï¼ˆ40åˆ†ï¼‰
1. æ•°å€¼å‡†ç¡®ï¼ˆè¡€ç³–ã€ä½“é‡ç­‰ï¼‰ï¼šæ•°å€¼é”™è¯¯-2åˆ†/å¤„ï¼Œå•ä½é”™è¯¯-1åˆ†/å¤„
2. è¯ç‰©å‡†ç¡®ï¼ˆè¯åã€å‰‚é‡ã€ç”¨æ³•ï¼‰ï¼šè¯åé”™è¯¯-3åˆ†/å¤„ï¼Œå‰‚é‡-2åˆ†/å¤„ï¼Œç”¨æ³•-1.5åˆ†/å¤„
3. æ—¶é—´å‡†ç¡®ï¼ˆå‘ç—…ã€å°±è¯Šæ—¶é—´ï¼‰ï¼šæ—¶é—´é”™è¯¯-2åˆ†/å¤„
4. è¯Šæ–­å‡†ç¡®ï¼ˆç±»å‹ã€å¹¶å‘ç—‡ï¼‰ï¼šè¯Šæ–­é”™è¯¯-3åˆ†/å¤„
5. ç—…ç¨‹æè¿°å‡†ç¡®ï¼šäº‹å®é”™è¯¯-2åˆ†/å¤„
6. âš ï¸ ç³–å°¿ç—…å†™å…¥æ—¢å¾€å²ï¼š-10åˆ†ï¼ˆä¸€ç¥¨å¦å†³ï¼‰

äºŒã€å®Œæ•´æ€§ï¼ˆ35åˆ†ï¼‰
å¿…å¤‡æ¨¡å—ï¼š
- ä¸»è¯‰ï¼ˆ7åˆ†ï¼‰ï¼šç—‡çŠ¶+æ—¶é—´ï¼Œç¼ºç—‡çŠ¶-4åˆ†ï¼Œç¼ºæ—¶é—´-3åˆ†
- ç°ç—…å²ï¼ˆ14åˆ†ï¼‰ï¼šåˆè¯Š3åˆ†+æ²»ç–—4åˆ†+è¿‘æœŸ4åˆ†+å¹¶å‘ç—‡3åˆ†
- æ—¢å¾€å²ï¼ˆ7åˆ†ï¼‰ï¼šé«˜è¡€å‹2åˆ†+é«˜è¡€è„‚2åˆ†+å† å¿ƒç—…2åˆ†+å…¶ä»–1åˆ†
- å®¶æ—å²ï¼ˆ4åˆ†ï¼‰ï¼šç³–å°¿ç—…å®¶æ—å²3åˆ†+å…¶ä»–1åˆ†
- ä¸ªäººå²ï¼ˆ3åˆ†ï¼‰ï¼šå¯¹è¯ä¸­æåŠä½†æœªè®°å½•æ‰£1-2åˆ†

ä¸‰ã€è§„èŒƒæ€§ï¼ˆ25åˆ†ï¼‰
1. åŒ»å­¦æœ¯è¯­ï¼ˆ8åˆ†ï¼‰ï¼šå£è¯­åŒ–-1åˆ†/å¤„ï¼Œæœ¯è¯­é”™è¯¯-2åˆ†/å¤„
   è§„èŒƒï¼šå¤šé¥®ã€å¤šå°¿ã€è§†ç‰©æ¨¡ç³Š âœ…
   ä¸è§„èŒƒï¼šå£æ¸´ã€å°¿å¤šã€çœ‹ä¸æ¸… âŒ
2. ç»“æ„è§„èŒƒï¼ˆ7åˆ†ï¼‰ï¼šé¡ºåºé”™è¯¯-2åˆ†ï¼Œç»“æ„æ··ä¹±-3åˆ†
3. è¯ç‰©ä¹¦å†™ï¼ˆ5åˆ†ï¼‰ï¼šä¸è§„èŒƒ-1åˆ†/å¤„
   è§„èŒƒæ ¼å¼ï¼šè¯å+å‰‚é‡+é¢‘ç‡+æ–¹å¼
4. æ—¶é—´è¡¨è¿°ï¼ˆ3åˆ†ï¼‰ï¼šä¸æ˜ç¡®-1åˆ†/å¤„
5. æ•´ä½“ä¸“ä¸šæ€§ï¼ˆ2åˆ†ï¼‰

ã€è¾“å‡ºæ ¼å¼ã€‘
ä¸¥æ ¼æŒ‰JSONæ ¼å¼è¾“å‡ºï¼ˆä¸è¦æœ‰å…¶ä»–æ–‡å­—ï¼‰ï¼š

```json
{{
  "accuracy": {{
    "score": 0-40,
    "stars": 1-5,
    "deductions": [
      {{"item": "æ‰£åˆ†é¡¹", "points": 2, "reason": "åŸå› "}}
    ],
    "comment": "è¯„è¯­"
  }},
  "completeness": {{
    "score": 0-35,
    "stars": 1-5,
    "missing_modules": ["ç¼ºå¤±æ¨¡å—"],
    "comment": "è¯„è¯­"
  }},
  "standardization": {{
    "score": 0-25,
    "stars": 1-5,
    "issues": ["é—®é¢˜"],
    "comment": "è¯„è¯­"
  }},
  "total_score": 0-100,
  "overall_comment": "æ€»è¯„"
}}
```

è¯·å¼€å§‹è¯„æµ‹ã€‚
"""


def evaluate_medical_record(conversation: str, medical_record: str, title: str = "è¯„æµ‹ç»“æœ"):
    """
    è¯„æµ‹ç—…å†æ‘˜è¦

    Args:
        conversation: åŒ»æ‚£å¯¹è¯
        medical_record: ç—…å†æ‘˜è¦
        title: ç»“æœæ ‡é¢˜
    """
    print("\n" + "=" * 60)
    print(f"{title}")
    print("=" * 60)

    # åˆ›å»ºOpenAIå®¢æˆ·ç«¯
    client = OpenAI(
        api_key=DEEPSEEK_API_KEY,
        base_url=DEEPSEEK_BASE_URL
    )

    # æ„å»ºè¯„æµ‹prompt
    prompt = EVALUATION_PROMPT_TEMPLATE.format(
        conversation=conversation,
        medical_record=medical_record
    )

    print("æ­£åœ¨è°ƒç”¨ DeepSeek Reasoner è¿›è¡Œè¯„æµ‹...")

    # è°ƒç”¨API
    response = client.chat.completions.create(
        model="deepseek-reasoner",
        messages=[
            {
                "role": "system",
                "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„åŒ»ç–—ç—…å†è´¨é‡è¯„æµ‹ä¸“å®¶ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§è¯„åˆ†æ ‡å‡†è¿›è¡Œå®¢è§‚è¯„åˆ†ã€‚"
            },
            {
                "role": "user",
                "content": prompt
            }
        ],
        temperature=0.3,  # é™ä½éšæœºæ€§
        max_tokens=8000  # å¢åŠ tokené™é¢ä»¥å®¹çº³æ¨ç†è¿‡ç¨‹å’Œè¾“å‡º
    )

    # DeepSeek Reasoner çš„è¾“å‡ºåŒ…å«æ¨ç†è¿‡ç¨‹å’Œæœ€ç»ˆç»“æœ
    message = response.choices[0].message

    # è·å–æœ€ç»ˆè¾“å‡º
    result_text = message.content if message.content else ""

    # å¦‚æœæœ‰æ¨ç†è¿‡ç¨‹ï¼Œå¯ä»¥æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰
    if hasattr(message, 'reasoning_content') and message.reasoning_content:
        print(f"  [æ¨ç†tokenæ•°: {len(message.reasoning_content.split())}]")

    # æå–JSON
    try:
        json_start = result_text.find('{')
        json_end = result_text.rfind('}') + 1

        if json_start != -1 and json_end > json_start:
            json_str = result_text[json_start:json_end]
            result = json.loads(json_str)

            # æ˜¾ç¤ºç»“æœ
            print("\nâœ… è¯„æµ‹å®Œæˆï¼\n")

            # å‡†ç¡®æ€§
            acc = result['accuracy']
            print(f"ã€å‡†ç¡®æ€§ã€‘{acc['score']}/40 åˆ† (â­ {'â­' * acc['stars']})")
            print(f"  {acc['comment']}")
            if acc.get('deductions'):
                print("  æ‰£åˆ†æ˜ç»†ï¼š")
                for d in acc['deductions']:
                    print(f"    - {d['item']}: -{d['points']}åˆ† ({d['reason']})")

            # å®Œæ•´æ€§
            comp = result['completeness']
            print(f"\nã€å®Œæ•´æ€§ã€‘{comp['score']}/35 åˆ† (â­ {'â­' * comp['stars']})")
            print(f"  {comp['comment']}")
            if comp.get('missing_modules'):
                print(f"  ç¼ºå¤±æ¨¡å—ï¼š{', '.join(comp['missing_modules'])}")

            # è§„èŒƒæ€§
            std = result['standardization']
            print(f"\nã€è§„èŒƒæ€§ã€‘{std['score']}/25 åˆ† (â­ {'â­' * std['stars']})")
            print(f"  {std['comment']}")
            if std.get('issues'):
                print(f"  é—®é¢˜é¡¹ï¼š{', '.join(std['issues'][:3])}")  # åªæ˜¾ç¤ºå‰3ä¸ª

            # æ€»åˆ†
            print(f"\n{'â”€' * 60}")
            print(f"ğŸ“Š æ€»åˆ†ï¼š{result['total_score']}/100 åˆ†")
            print(f"ğŸ“ æ€»è¯„ï¼š{result['overall_comment']}")

            return result

        else:
            print("âŒ æ— æ³•è§£æJSONæ ¼å¼")
            print("åŸå§‹å“åº”ï¼š", result_text)
            return None

    except json.JSONDecodeError as e:
        print(f"âŒ JSONè§£æå¤±è´¥ï¼š{e}")
        print("åŸå§‹å“åº”ï¼š", result_text)
        return None


def main():
    """ä¸»å‡½æ•°"""
    print("\n" + "ğŸ§ª" * 30)
    print(" " * 20 + "AIç—…å†è‡ªåŠ¨è¯„æµ‹æ¼”ç¤º")
    print("ğŸ§ª" * 30)

    # æ£€æŸ¥APIé…ç½®
    if not DEEPSEEK_API_KEY:
        print("\nâŒ é”™è¯¯ï¼šDEEPSEEK_API_KEY æœªé…ç½®")
        print("è¯·åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½® DEEPSEEK_API_KEY")
        return

    print(f"\nâœ… DeepSeek API å·²é…ç½®")
    print(f"   Base URL: {DEEPSEEK_BASE_URL}")
    print(f"   Model: deepseek-reasoner")

    # è¯„æµ‹1ï¼šä¼˜è´¨ç—…å†
    result1 = evaluate_medical_record(
        SAMPLE_CONVERSATION,
        GOOD_RECORD,
        "æµ‹è¯•1: ä¼˜è´¨ç—…å†æ‘˜è¦è¯„æµ‹"
    )

    # è¯„æµ‹2ï¼šé—®é¢˜ç—…å†
    result2 = evaluate_medical_record(
        SAMPLE_CONVERSATION,
        BAD_RECORD,
        "æµ‹è¯•2: é—®é¢˜ç—…å†æ‘˜è¦è¯„æµ‹"
    )

    # å¯¹æ¯”åˆ†æ
    if result1 and result2:
        print("\n" + "=" * 60)
        print("å¯¹æ¯”åˆ†æ")
        print("=" * 60)
        print(f"æ€»åˆ†å·®è·ï¼š{result1['total_score'] - result2['total_score']} åˆ†")
        print(f"å‡†ç¡®æ€§ï¼š{result1['accuracy']['score']} vs {result2['accuracy']['score']} (å·® {result1['accuracy']['score'] - result2['accuracy']['score']}åˆ†)")
        print(f"å®Œæ•´æ€§ï¼š{result1['completeness']['score']} vs {result2['completeness']['score']} (å·® {result1['completeness']['score'] - result2['completeness']['score']}åˆ†)")
        print(f"è§„èŒƒæ€§ï¼š{result1['standardization']['score']} vs {result2['standardization']['score']} (å·® {result1['standardization']['score'] - result2['standardization']['score']}åˆ†)")

    print("\n" + "=" * 60)
    print("âœ… æ¼”ç¤ºå®Œæˆï¼")
    print("=" * 60)
    print("\nğŸ“š è¯„æµ‹æ ‡å‡†è¯¦è§ï¼šAI_EVALUATION_STANDARD.md")
    print("ğŸ’» Prompté…ç½®è¯¦è§ï¼šconfig/ai_evaluation_prompt.py")


if __name__ == "__main__":
    main()
